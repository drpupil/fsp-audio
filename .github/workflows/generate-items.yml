name: Generate items.json from Archive.org

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate items.json
        run: |
          python - << 'EOF'
          import json, re
          from urllib.request import Request, urlopen
          from html.parser import HTMLParser
          from urllib.parse import unquote

          BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/"
          OUT = "items.json"

          class P(HTMLParser):
              def __init__(self):
                  super().__init__()
                  self.links = []
              def handle_starttag(self, tag, attrs):
                  if tag.lower() != "a":
                      return
                  href = dict(attrs).get("href")
                  if href:
                      self.links.append(href)

          def title_from_filename(fn):
              s = unquote(fn)
              s = re.sub(r"\.m4a$", "", s, flags=re.I)
              s = s.replace("_", " ")
              s = re.sub(r"\s+", " ", s).strip()
              s = s.replace("O mer", "Ömer").replace("Ömer", "Ömer")
              return s

          req = Request(BASE, headers={"User-Agent": "Mozilla/5.0"})
          html = urlopen(req).read().decode("utf-8", errors="replace")

          p = P(); p.feed(html)

          files = sorted(
              {h.split("?",1)[0] for h in p.links if h.lower().endswith(".m4a")},
              key=str.lower
          )

          items = [{"title": title_from_filename(f), "file": f, "info": ""} for f in files]

          with open(OUT, "w", encoding="utf-8") as w:
              json.dump(items, w, ensure_ascii=False, indent=2)

          print(f"{len(items)} items written")
          EOF

      - name: Commit items.json
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add items.json
          git commit -m "Auto-generate items.json from Archive.org" || echo "No changes"
          git push
