name: Generate items.json from Archive.org

on:
  workflow_dispatch:
  schedule:
    # Her gün Türkiye saatiyle ~06:00 (UTC 03:00)
    - cron: "0 3 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate items.json
        run: |
          python - << 'EOF'
          import json, re
          from urllib.request import Request, urlopen
          from html.parser import HTMLParser
          from urllib.parse import unquote

          BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/"

          class LinkParser(HTMLParser):
              def __init__(self):
                  super().__init__()
                  self.links = []

              def handle_starttag(self, tag, attrs):
                  if tag == "a":
                      for k, v in attrs:
                          if k == "href" and v.endswith(".m4a"):
                              self.links.append(unquote(v))

          req = Request(BASE, headers={"User-Agent": "Mozilla/5.0"})
          html = urlopen(req).read().decode("utf-8", errors="ignore")

          parser = LinkParser()
          parser.feed(html)

          items = []
          for f in parser.links:
              title = re.sub(r"\.m4a$", "", f)
              title = title.replace("_", " ").replace("%20", " ")
              items.append({
                  "title": title,
                  "file": f
              })

          items.sort(key=lambda x: x["title"].lower())

          with open("items.json", "w", encoding="utf-8") as out:
              json.dump(items, out, ensure_ascii=False, indent=2)

          print(f"{len(items)} kayıt üretildi.")
          EOF

      - name: Commit items.json if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep items.json; then
            git add items.json
            git commit -m "Auto-update items.json from Archive.org"
            git push
          else
            echo "Değişiklik yok."
          fi
