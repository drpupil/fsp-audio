name: Generate items.json from Archive.org

on:
  workflow_dispatch:
  schedule:
    # Her gün 03:00 UTC (Berlin kışın 04:00 / yazın 05:00 civarı)
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate items.json (m4a + mp3)
        run: |
          python - << 'EOF'
          import json, re
          from urllib.request import Request, urlopen
          from html.parser import HTMLParser
          from urllib.parse import unquote

          BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/"

          class LinkParser(HTMLParser):
              def __init__(self):
                  super().__init__()
                  self.files = []

              def handle_starttag(self, tag, attrs):
                  if tag != "a":
                      return
                  href = None
                  for k, v in attrs:
                      if k == "href":
                          href = v
                          break
                  if not href:
                      return

                  h = href.lower()
                  if h.endswith(".m4a") or h.endswith(".mp3"):
                      self.files.append(unquote(href))

          req = Request(BASE, headers={"User-Agent": "Mozilla/5.0"})
          html = urlopen(req).read().decode("utf-8", errors="ignore")

          parser = LinkParser()
          parser.feed(html)

          # de-dup
          seen = set()
          files = []
          for f in parser.files:
              if f in seen:
                  continue
              seen.add(f)
              files.append(f)

          items = []
          for f in files:
              title = re.sub(r"\.(m4a|mp3)$", "", f, flags=re.IGNORECASE)
              # başlık temizleme (istersen daha agresif temizleriz)
              title = title.replace("_", " ").replace("%20", " ")
              items.append({"title": title, "file": f})

          items.sort(key=lambda x: x["title"].lower())

          with open("items.json", "w", encoding="utf-8") as out:
              json.dump(items, out, ensure_ascii=False, indent=2)

          print(f"{len(items)} kayıt üretildi (m4a + mp3).")
          EOF

      - name: Commit items.json if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -q "items.json"; then
            git add items.json
            git commit -m "Auto-update items.json (m4a+mp3) from Archive.org"
            git push
          else
            echo "Değişiklik yok."
          fi
