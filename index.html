<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfabetik FSP A–Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --bg:#fff; --text:#111; --muted:#666; --line:#eee;
      --soft:#f6f6f6; --softBorder:#e5e5e5;
      --active:#e5f2ff; --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 12px; --blue:#2563eb; --amber:#f59e0b; --rose:#e11d48;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 18px;
      max-width: 1100px;
      color: var(--text);
      background: var(--bg);
      font-weight: 400;
    }

    h1{
      font-size: 1.5rem;
      margin: 0 0 12px 0;
      font-weight: 600;
    }

    .topbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      margin-bottom: 8px;
    }

    #search{
      flex: 1 1 380px;
      padding: 10px 12px;
      border: 1px solid #cfcfcf;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      font-weight: 400;
    }

    .chipBtn{
      padding: 9px 12px;
      border:1px solid var(--softBorder);
      background: var(--soft);
      border-radius:10px;
      cursor:pointer;
      user-select:none;
      font-weight:600;
      font-size:.95rem;
      white-space:nowrap;
    }
    .chipBtn:active{ transform: translateY(1px); }

    #statusTop{
      font-size: .95rem;
      color: var(--muted);
      margin: 6px 0 10px 2px;
      font-weight: 400;
    }

    /* Kolon üstü ikon filtre satırı */
    #iconFilters{
      display:flex;
      align-items:center;
      justify-content: flex-end;
      gap: 10px;
      padding: 10px 6px;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      color: var(--muted);
      user-select:none;
    }
    #iconFilters .hint{
      margin-right:auto;
      font-size:.92rem;
      color: var(--muted);
    }

    #list{
      margin-bottom: 140px; /* floating player boşluğu */
    }

    /* Daha sık satır */
    .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 6px;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      font-size: 0.95rem;
      line-height: 1.25;
      font-weight: 400;
    }
    .row:hover{ background:#fafafa; }
    .row.active{ background: var(--active); }

    .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }
    .title{
      flex: 1;
      min-width: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 400;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .iconBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 2px solid #dcdcdc;
      background: #fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      padding:0;
    }
    .iconBtn:active{ transform: translateY(1px); }

    .likeCount{
      font-size: 0.85rem;
      color:#444;
      min-width: 16px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight: 400;
    }

    /* Like */
    .iconBtn.like::before{ content:"♡"; font-size: 14px; color:#777; transform: translateY(-0.5px); }
    .iconBtn.like.active{ border-color: var(--rose); background:#fff0f3; }
    .iconBtn.like.active::before{ content:"♥"; color: var(--rose); }

    /* Favorite */
    .iconBtn.star::before{ content:"☆"; font-size: 15px; color:#777; transform: translateY(-0.5px); }
    .iconBtn.star.active{ border-color: var(--amber); background:#fff7ed; }
    .iconBtn.star.active::before{ content:"★"; color: var(--amber); }

    /* Selected */
    .iconBtn.select::before{ content:"✓"; font-size: 15px; color:#9aa0a6; transform: translateY(-0.5px); }
    .iconBtn.select.active{ border-color: var(--blue); background: var(--blue); }
    .iconBtn.select.active::before{ color:#fff; }

    /* Download */
    .iconBtn.dl::before{ content:"⤓"; font-size: 15px; color:#111; transform: translateY(-0.5px); }

    /* Floating player */
    #floatingPlayer{
      position: fixed;
      left: 18px;
      bottom: 18px;
      width: min(680px, calc(100vw - 36px));
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 9999;
      overflow:hidden;
    }

    #fpHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid #efefef;
      cursor: grab;
      user-select:none;
      background: #fafafa;
    }
    #fpHeader:active{ cursor: grabbing; }

    #fpTitle{
      font-size: .95rem;
      color:#222;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 600;
      flex: 1;
      min-width:0;
    }
    #fpHint{
      font-size: .8rem;
      color:#888;
      font-weight: 400;
      white-space:nowrap;
    }

    #fpBody{ padding: 10px 12px 12px 12px; }

    #playerStatus{
      font-size: .9rem;
      color:#666;
      margin: 0 0 8px 2px;
      font-weight: 400;
    }

    .plyr{ border-radius: 10px; }

    /* Plyr custom prev/next ikonları biraz büyüsün */
    .plyr__control[data-plyr="prev"],
    .plyr__control[data-plyr="next"]{
      font-size: 16px;
      line-height: 1;
    }
  </style>
</head>

<body>
  <h1>Alfabetik FSP A–Z</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />
    <button class="chipBtn" id="clearFiltersBtn" title="Filtreleri temizle">Hepsi</button>
  </div>

  <div id="statusTop"></div>

  <div id="iconFilters">
    <div class="hint">Kayıt</div>

    <div class="likeCount" title="Like"></div>
    <button class="iconBtn like" id="filterLikeBtn" title="Sadece liked"></button>
    <button class="iconBtn select" id="filterSelectBtn" title="Sadece seçili"></button>
    <button class="iconBtn star" id="filterFavBtn" title="Sadece favoriler"></button>
    <button class="iconBtn dl" disabled style="opacity:.45; cursor:default;" title="İndir (satırda var)"></button>
  </div>

  <div id="list"></div>

  <div id="floatingPlayer" aria-label="Audio player">
    <div id="fpHeader">
      <div id="fpTitle">Seçili kayıt yok</div>
      <div id="fpHint">Sürükle</div>
    </div>

    <div id="fpBody">
      <div id="playerStatus"></div>

      <!-- Crossorigin + Plyr -->
      <audio id="player" class="js-player" controls preload="auto" crossorigin="anonymous"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // Archive download base
    const BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

    // Storage keys
    const LS_FAVS = "favs_v5";
    const LS_SELECTED = "selected_v5";
    const LS_LIKES = "likes_count_v5";

    // State
    let items = [];
    let favs = new Set();
    let selected = new Set();
    let likesCount = {};
    let activeFile = null;

    // filter: all | fav | liked | selected
    let filterMode = "all";

    // view for prev/next
    let currentView = [];
    let currentIndex = -1;

    // Elements
    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const statusTopEl = document.getElementById("statusTop");

    const clearFiltersBtn = document.getElementById("clearFiltersBtn");
    const filterFavBtn = document.getElementById("filterFavBtn");
    const filterLikeBtn = document.getElementById("filterLikeBtn");
    const filterSelectBtn = document.getElementById("filterSelectBtn");

    const fp = document.getElementById("floatingPlayer");
    const fpHeader = document.getElementById("fpHeader");
    const fpTitle = document.getElementById("fpTitle");
    const playerStatusEl = document.getElementById("playerStatus");

    const audioEl = document.getElementById("player");

    // Plyr with custom Prev/Next buttons INSIDE controls
    const plyr = new Plyr(audioEl, {
      seekTime: 5,
      controls: [
        '<button type="button" class="plyr__control" data-plyr="prev" aria-label="Önceki" title="Önceki (←)">⏮</button>',
        "rewind",
        "play",
        "fast-forward",
        '<button type="button" class="plyr__control" data-plyr="next" aria-label="Sonraki" title="Sonraki (→)">⏭</button>',
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume"
      ]
    });

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fileUrl(file){
      const encoded = encodeURIComponent(file).replace(/%2F/g, "/");
      return BASE + encoded;
    }

    function downloadUrl(file){
      return fileUrl(file) + "?download=1";
    }

    function loadSet(key){
      try{
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        return new Set(Array.isArray(arr) ? arr : []);
      } catch { return new Set(); }
    }
    function saveSet(key, set){
      localStorage.setItem(key, JSON.stringify([...set]));
    }

    function loadLikes(){
      try{
        const obj = JSON.parse(localStorage.getItem(LS_LIKES) || "{}");
        return (obj && typeof obj === "object") ? obj : {};
      } catch { return {}; }
    }
    function saveLikes(){
      localStorage.setItem(LS_LIKES, JSON.stringify(likesCount));
    }
    function getLikeCount(file){
      return Number(likesCount[file] || 0);
    }

    function setTopStatus(msg){ statusTopEl.textContent = msg || ""; }
    function setPlayerStatus(msg){ playerStatusEl.textContent = msg || ""; }

    function updateFilterIcons(){
      filterFavBtn.classList.toggle("active", filterMode === "fav");
      filterLikeBtn.classList.toggle("active", filterMode === "liked");
      filterSelectBtn.classList.toggle("active", filterMode === "selected");
    }

    function buildView(){
      const q = searchEl.value.trim().toLowerCase();

      let view = items.filter(it => {
        const t = (it.title || "").toLowerCase();
        if (q && !t.includes(q)) return false;

        const isFav = favs.has(it.file);
        const isSel = selected.has(it.file);
        const isLiked = getLikeCount(it.file) > 0;

        if (filterMode === "fav") return isFav;
        if (filterMode === "liked") return isLiked;
        if (filterMode === "selected") return isSel;
        return true;
      });

      view.sort((a,b) => String(a.title).localeCompare(String(b.title), "tr"));
      return view;
    }

    function renderList(){
      updateFilterIcons();

      currentView = buildView();
      listEl.innerHTML = "";

      const likedN = Object.values(likesCount).filter(n => Number(n) > 0).length;
      setTopStatus(`Görünen: ${currentView.length} • Favori: ${favs.size} • Liked: ${likedN}`);

      for (const it of currentView){
        const isActive = (it.file === activeFile);
        const isFav = favs.has(it.file);
        const isSel = selected.has(it.file);

        const likeN = getLikeCount(it.file);
        const isLiked = likeN > 0;

        const row = document.createElement("div");
        row.className = "row" + (isActive ? " active" : "");
        row.dataset.file = it.file;

        row.innerHTML = `
          <div class="left">
            <div class="title" data-action="play" title="${escapeHtml(it.title)}">
              ${escapeHtml(it.title)}
            </div>
          </div>

          <div class="right">
            <div class="actions">
              <div class="likeCount" title="Like">${likeN}</div>
              <button class="iconBtn like ${isLiked ? "active" : ""}" data-action="like" title="Like"></button>

              <button class="iconBtn select ${isSel ? "active" : ""}" data-action="select" title="Seç"></button>
              <button class="iconBtn star ${isFav ? "active" : ""}" data-action="fav" title="Favori"></button>
              <button class="iconBtn dl" data-action="dl" title="İndir"></button>
            </div>
          </div>
        `;
        listEl.appendChild(row);
      }

      currentIndex = currentView.findIndex(x => x.file === activeFile);
    }

    async function safePlay(){
      try{
        const p = plyr.play();
        if (p && typeof p.then === "function") await p;
        setPlayerStatus("");
      } catch {
        setPlayerStatus("Oynatma başlatılamadı. Player’daki ▶ tuşuna bas (tarayıcı kısıtı olabilir).");
      }
    }

    function playByIndex(idx){
      const it = currentView[idx];
      if (!it) return;

      activeFile = it.file;
      currentIndex = idx;

      fpTitle.textContent = it.title || "Seçili kayıt";
      setPlayerStatus("Yükleniyor…");

      audioEl.crossOrigin = "anonymous";
      audioEl.src = fileUrl(it.file);
      try { audioEl.load(); } catch {}

      safePlay();
      renderList();
    }

    function playFile(file){
      const idx = currentView.findIndex(x => x.file === file);
      if (idx >= 0) playByIndex(idx);
    }

    function playPrev(){
      if (currentIndex > 0) playByIndex(currentIndex - 1);
    }
    function playNext(){
      if (currentIndex >= 0 && currentIndex < currentView.length - 1) playByIndex(currentIndex + 1);
    }

    function triggerDownload(file){
      const url = downloadUrl(file);
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Plyr custom prev/next handler (player içinde)
    document.addEventListener("click", (e) => {
      const b = e.target.closest("[data-plyr]");
      if (!b) return;
      const action = b.getAttribute("data-plyr");
      if (action === "prev") playPrev();
      if (action === "next") playNext();
    });

    // Space: play/pause, arrows: prev/next (input dışında)
    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      if (tag === "input" || tag === "textarea") return;

      if (e.code === "Space"){
        e.preventDefault();
        try { plyr.togglePlay(); } catch {}
      }
      if (e.key === "ArrowLeft"){
        e.preventDefault();
        playPrev();
      }
      if (e.key === "ArrowRight"){
        e.preventDefault();
        playNext();
      }
    });

    // Filters (ikon satırı)
    function setFilter(mode){
      filterMode = (filterMode === mode) ? "all" : mode;
      renderList();
    }
    filterFavBtn.addEventListener("click", () => setFilter("fav"));
    filterLikeBtn.addEventListener("click", () => setFilter("liked"));
    filterSelectBtn.addEventListener("click", () => setFilter("selected"));
    clearFiltersBtn.addEventListener("click", () => { filterMode = "all"; renderList(); });

    // Search
    searchEl.addEventListener("input", renderList);

    // List click
    listEl.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      const row = e.target.closest(".row");
      if (!row) return;

      const file = row.dataset.file;
      const action = btn ? btn.dataset.action : "play";

      if (action === "play"){ playFile(file); return; }

      if (action === "fav"){
        if (favs.has(file)) favs.delete(file); else favs.add(file);
        saveSet(LS_FAVS, favs); renderList(); return;
      }

      if (action === "select"){
        if (selected.has(file)) selected.delete(file); else selected.add(file);
        saveSet(LS_SELECTED, selected); renderList(); return;
      }

      if (action === "like"){
        likesCount[file] = (getLikeCount(file) > 0) ? 0 : 1;
        saveLikes(); renderList(); return;
      }

      if (action === "dl"){
        triggerDownload(file); return;
      }
    });

    // Floating drag
    (function makeDraggable(){
      let dragging = false;
      let startX = 0, startY = 0;
      let startLeft = 0, startTop = 0;

      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

      function onDown(clientX, clientY){
        const rect = fp.getBoundingClientRect();
        dragging = true;
        startX = clientX; startY = clientY;
        startLeft = rect.left; startTop = rect.top;
        fp.style.right = "auto"; fp.style.bottom = "auto";
      }
      function onMove(clientX, clientY){
        if (!dragging) return;
        const dx = clientX - startX;
        const dy = clientY - startY;
        const newLeft = startLeft + dx;
        const newTop  = startTop + dy;
        const maxLeft = window.innerWidth - fp.offsetWidth - 6;
        const maxTop  = window.innerHeight - fp.offsetHeight - 6;
        fp.style.left = clamp(newLeft, 6, maxLeft) + "px";
        fp.style.top  = clamp(newTop, 6, maxTop) + "px";
      }
      function onUp(){ dragging = false; }

      fpHeader.addEventListener("mousedown", (e) => { onDown(e.clientX, e.clientY); e.preventDefault(); });
      window.addEventListener("mousemove", (e) => onMove(e.clientX, e.clientY));
      window.addEventListener("mouseup", onUp);

      fpHeader.addEventListener("touchstart", (e) => {
        const t = e.touches[0]; onDown(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener("touchmove", (e) => {
        if (!dragging) return;
        const t = e.touches[0]; onMove(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener("touchend", onUp);
    })();

    // Auto next on ended
    audioEl.addEventListener("ended", () => playNext());

    // Init
    async function loadItems(){
      favs = loadSet(LS_FAVS);
      selected = loadSet(LS_SELECTED);
      likesCount = loadLikes();

      setTopStatus("Yükleniyor…");
      setPlayerStatus("");

      try{
        const res = await fetch("./items.json", { cache: "no-store" });
        if (!res.ok) throw new Error("items.json okunamadı");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("items.json formatı yanlış");

        items = data
          .filter(x => x && x.file)
          .map(x => ({ title: String(x.title || x.file), file: String(x.file) }));

        renderList();
        setTopStatus("");
      } catch (err){
        console.error(err);
        setTopStatus("Liste yüklenemedi. items.json kontrol et.");
        setPlayerStatus("Liste yüklenemedi.");
      }
    }

    function loadLikes(){ return (function(){
      try{
        const obj = JSON.parse(localStorage.getItem(LS_LIKES) || "{}");
        return (obj && typeof obj === "object") ? obj : {};
      } catch { return {}; }
    })(); }

    loadItems();
  </script>
</body>
</html>
