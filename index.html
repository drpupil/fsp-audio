<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Alfabetik FSP A–Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --line:#eee; --muted:#666; --muted2:#888; --chip:#f5f5f7;
      --accent:#1677ff; --danger:#e11d48; --star:#f59e0b;
    }
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;margin:18px;max-width:1100px}
    h1{font-size:22px;margin:0 0 10px;font-weight:700}

    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    #search{flex:1;min-width:260px;padding:10px 12px;border:1px solid #d9d9d9;border-radius:12px;outline:none;font-size:15px}
    #search:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(22,119,255,.15)}
    .pill{padding:9px 12px;border:1px solid #d9d9d9;border-radius:12px;background:#fff;cursor:pointer;font-size:14px;user-select:none}
    .pill:hover{background:var(--chip)}
    .meta{font-size:13px;color:var(--muted);margin:6px 0 8px}

    /* Header row (icon-only) */
    .hdr{
      display:grid;
      grid-template-columns: 1fr 90px 70px 80px 60px;
      gap:10px;
      align-items:center;
      padding:8px 6px;
      color:var(--muted);
      font-size:13px;
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      background:#fcfcfd;
      position:sticky; top:0; z-index:2;
    }
    .hdr .hcell{display:flex;align-items:center;justify-content:flex-end}
    .hdr .hcell.left{justify-content:flex-start}
    .filterIcon{
      width:32px;height:32px;border-radius:999px;border:1px solid #d9d9d9;background:#fff;
      display:inline-flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
      color:var(--muted2); font-size:16px;
    }
    .filterIcon:hover{background:var(--chip)}
    .filterIcon.on{border-color:rgba(22,119,255,.35); box-shadow:0 0 0 3px rgba(22,119,255,.12); color:var(--accent)}

    #list{border-bottom:1px solid var(--line)}
    .row{
      display:grid;
      grid-template-columns: 1fr 90px 70px 80px 60px;
      gap:10px;
      align-items:center;
      padding:6px 6px;              /* ✅ sıkı satır */
      border-bottom:1px solid var(--line);
      cursor:pointer
    }
    .row:hover{background:#fafafa}
    .row.active{background:rgba(22,119,255,.09)}

    .title{
      min-width:0;font-size:15px;font-weight:400;
      line-height:1.15;             /* ✅ daha sıkı */
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }

    .cell{display:flex;align-items:center;justify-content:flex-end;gap:6px;white-space:nowrap}
    .count{width:22px;text-align:right;color:var(--muted2);font-size:13px;font-variant-numeric:tabular-nums}

    .iconbtn{
      width:32px;height:32px;border-radius:999px;border:1px solid #d9d9d9;background:#fff;
      display:inline-flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
      color:var(--muted2); font-size:16px;
    }
    .iconbtn:hover{background:var(--chip)}
    .iconbtn:active{transform:translateY(1px)}

    .heart{color:var(--muted2)} .heart.on{color:var(--danger)}
    .star{color:var(--muted2)}  .star.on{color:var(--star)}
    .check{color:var(--muted2)}
    .check.on{color:#fff;background:var(--accent);border-color:var(--accent)}

    /* Floating player */
    #floatingPlayer{
      position:fixed;left:18px;bottom:18px;width:min(720px,calc(100vw - 36px));
      background:#fff;border:1px solid #e6e6e6;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.12);
      z-index:9999;overflow:hidden
    }
    #fpHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border-bottom:1px solid var(--line);background:#fcfcfd;
      cursor:grab;user-select:none
    }
    #fpHeader:active{cursor:grabbing}
    #fpTitle{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    #fpControls{display:flex;align-items:center;gap:8px;flex-shrink:0}
    .tiny{width:38px;height:32px;border-radius:10px;border:1px solid #d9d9d9;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;user-select:none;font-size:16px}
    .tiny:hover{background:var(--chip)}
    .tiny:active{transform:translateY(1px)}
    #fpStatus{padding:6px 10px;font-size:13px;color:var(--muted)}
    #fpStatus a{color:var(--accent);text-decoration:underline}
    #fpBody{padding:6px 8px 10px}

    @media (max-width:700px){
      .hdr,.row{grid-template-columns: 1fr 84px 62px 72px 54px}
    }
    @media (max-width:520px){
      #floatingPlayer{width:calc(100vw - 24px);left:12px;bottom:12px}
      .hdr,.row{grid-template-columns: 1fr 84px 62px 72px 54px}
    }
  </style>
</head>
<body>

  <h1>Alfabetik FSP A–Z</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />
    <button id="clearAll" class="pill" title="Filtreleri + aramayı temizle">Hepsi</button>
  </div>

  <div class="meta" id="meta">Yükleniyor...</div>

  <!-- Header icons only -->
  <div class="hdr">
    <div class="hcell left"></div>

    <div class="hcell">
      <button id="fltLike" class="filterIcon" title="Sadece liked">♥</button>
    </div>

    <div class="hcell">
      <button id="fltSel" class="filterIcon" title="Sadece seçili">✓</button>
    </div>

    <div class="hcell">
      <button id="fltFav" class="filterIcon" title="Sadece favoriler">★</button>
    </div>

    <div class="hcell"></div>
  </div>

  <div id="list"></div>

  <!-- Floating player -->
  <div id="floatingPlayer">
    <div id="fpHeader">
      <div id="fpTitle">Bir kayıt seç…</div>
      <div id="fpControls">
        <button id="btnPrev" class="tiny" title="Önceki">⏮</button>
        <button id="btnNext" class="tiny" title="Sonraki">⏭</button>
        <span style="color:#888;font-size:13px;margin-left:6px">Sürükle</span>
      </div>
    </div>

    <div id="fpStatus"></div>

    <div id="fpBody">
      <audio id="player" class="js-player" controls preload="none" crossorigin="anonymous"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    const BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";
    const ITEMS_URL = "./items.json";

    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl = document.getElementById("meta");

    const fltLikeBtn = document.getElementById("fltLike");
    const fltSelBtn  = document.getElementById("fltSel");
    const fltFavBtn  = document.getElementById("fltFav");

    const fpTitle = document.getElementById("fpTitle");
    const fpStatus = document.getElementById("fpStatus");

    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");

    const playerEl = document.getElementById("player");

    const plyr = new Plyr(playerEl, {
      seekTime: 5,
      controls: ["rewind","play","fast-forward","progress","current-time","duration","mute","volume"]
    });

    let items = [];
    let activeIndex = null;
    let filteredIdx = [];

    const LS_LIKES = "fsp_likes_v4";
    const LS_FAVS  = "fsp_favs_v4";
    const LS_SEL   = "fsp_selected_v4";

    const likes = JSON.parse(localStorage.getItem(LS_LIKES) || "{}");
    const favs  = JSON.parse(localStorage.getItem(LS_FAVS)  || "{}");
    const sel   = JSON.parse(localStorage.getItem(LS_SEL)   || "{}");

    const saveLikes = () => localStorage.setItem(LS_LIKES, JSON.stringify(likes));
    const saveFavs  = () => localStorage.setItem(LS_FAVS,  JSON.stringify(favs));
    const saveSel   = () => localStorage.setItem(LS_SEL,   JSON.stringify(sel));

    let filterLike = false;
    let filterFav  = false;
    let filterSel  = false;

    function syncFilterUI(){
      fltLikeBtn.classList.toggle("on", filterLike);
      fltFavBtn.classList.toggle("on",  filterFav);
      fltSelBtn.classList.toggle("on",  filterSel);
    }

    function urlFor(item){
      return encodeURI(BASE + item.file);
    }

    function buildFiltered(){
      const q = (searchEl.value || "").trim().toLowerCase();
      filteredIdx = [];

      for (let i=0;i<items.length;i++){
        const it = items[i];
        if (q && !it.title.toLowerCase().includes(q)) continue;
        if (filterLike && !((likes[it.file]||0)>0)) continue;
        if (filterFav  && !(!!favs[it.file])) continue;
        if (filterSel  && !(!!sel[it.file])) continue;
        filteredIdx.push(i);
      }

      metaEl.textContent = `Görünen: ${filteredIdx.length} / Toplam: ${items.length}`;
    }

    function render(){
      buildFiltered();
      syncFilterUI();
      listEl.innerHTML = "";

      for (const idx of filteredIdx){
        const it = items[idx];

        const row = document.createElement("div");
        row.className = "row" + (idx===activeIndex ? " active":"");
        row.dataset.index = String(idx);

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;

        // Like
        const likeCell = document.createElement("div");
        likeCell.className = "cell";
        const likeCount = document.createElement("span");
        likeCount.className = "count";
        likeCount.textContent = String(likes[it.file] || 0);

        const likeBtn = document.createElement("button");
        likeBtn.className = "iconbtn";
        likeBtn.title = "Like (+1)";
        const heart = document.createElement("span");
        heart.className = "heart" + ((likes[it.file]||0)>0 ? " on":"");
        heart.textContent = "♥";
        likeBtn.appendChild(heart);

        likeBtn.addEventListener("click",(e)=>{
          e.stopPropagation();
          likes[it.file] = (likes[it.file]||0) + 1;
          saveLikes();
          render();
        });

        likeCell.appendChild(likeCount);
        likeCell.appendChild(likeBtn);

        // Select
        const selCell = document.createElement("div");
        selCell.className = "cell";
        const selBtn = document.createElement("button");
        selBtn.className = "iconbtn check" + (sel[it.file] ? " on":"");
        selBtn.title = "Seç";
        selBtn.textContent = "✓";
        selBtn.addEventListener("click",(e)=>{
          e.stopPropagation();
          if (sel[it.file]) delete sel[it.file];
          else sel[it.file] = true;
          saveSel();
          render();
        });
        selCell.appendChild(selBtn);

        // Fav
        const favCell = document.createElement("div");
        favCell.className = "cell";
        const favBtn = document.createElement("button");
        favBtn.className = "iconbtn";
        favBtn.title = "Favori";
        const star = document.createElement("span");
        star.className = "star" + (favs[it.file] ? " on":"");
        star.textContent = "★";
        favBtn.appendChild(star);

        favBtn.addEventListener("click",(e)=>{
          e.stopPropagation();
          if (favs[it.file]) delete favs[it.file];
          else favs[it.file] = true;
          saveFavs();
          render();
        });
        favCell.appendChild(favBtn);

        // Download
        const dlCell = document.createElement("div");
        dlCell.className = "cell";
        const dl = document.createElement("a");
        dl.className = "iconbtn";
        dl.title = "İndir / Aç";
        dl.href = urlFor(it);
        dl.target = "_blank";
        dl.rel = "noopener";
        dl.textContent = "⬇";
        dl.addEventListener("click",(e)=>e.stopPropagation());
        dlCell.appendChild(dl);

        row.appendChild(title);
        row.appendChild(likeCell);
        row.appendChild(selCell);
        row.appendChild(favCell);
        row.appendChild(dlCell);

        row.addEventListener("click", ()=> playIndex(idx, true));

        listEl.appendChild(row);
      }
    }

    function findActivePos(){
      if (activeIndex==null) return -1;
      return filteredIdx.indexOf(activeIndex);
    }

    function playPrev(){
      if(!filteredIdx.length) return;
      const pos = findActivePos();
      const p = (pos<=0) ? (filteredIdx.length-1) : (pos-1);
      playIndex(filteredIdx[p], true);
    }
    function playNext(){
      if(!filteredIdx.length) return;
      const pos = findActivePos();
      const p = (pos===-1 || pos>=filteredIdx.length-1) ? 0 : (pos+1);
      playIndex(filteredIdx[p], true);
    }

    btnPrev.addEventListener("click", playPrev);
    btnNext.addEventListener("click", playNext);

    async function playIndex(index, userInitiated){
      const it = items[index];
      if(!it) return;

      activeIndex = index;
      fpTitle.textContent = it.title;

      const src = urlFor(it);
      fpStatus.innerHTML = `Yükleniyor… <a href="${src}" target="_blank" rel="noopener">dosyayı yeni sekmede aç</a>`;

      playerEl.src = src;
      playerEl.load();

      render();

      if(userInitiated){
        try{
          await plyr.play();
          fpStatus.textContent = "";
        }catch{
          fpStatus.innerHTML =
            `Oynatma başlatılamadı. Player’daki ▶ tuşuna bas. ` +
            `<a href="${src}" target="_blank" rel="noopener">dosyayı yeni sekmede aç</a>`;
        }
      }
    }

    playerEl.addEventListener("ended", playNext);

    document.addEventListener("keydown", async (e)=>{
      const tag = (document.activeElement && document.activeElement.tagName) || "";
      if(tag==="INPUT"||tag==="TEXTAREA") return;
      if(e.code==="Space"){
        e.preventDefault();
        try{
          if(plyr.playing) plyr.pause();
          else await plyr.play();
        }catch{}
      }
    });

    fltLikeBtn.addEventListener("click", ()=>{ filterLike = !filterLike; render(); });
    fltFavBtn.addEventListener("click",  ()=>{ filterFav  = !filterFav;  render(); });
    fltSelBtn.addEventListener("click",  ()=>{ filterSel  = !filterSel;  render(); });

    document.getElementById("clearAll").addEventListener("click", ()=>{
      searchEl.value = "";
      filterLike = filterFav = filterSel = false;
      render();
    });

    searchEl.addEventListener("input", render);

    // draggable player
    (function(){
      const box = document.getElementById("floatingPlayer");
      const handle = document.getElementById("fpHeader");
      let dragging=false, sx=0, sy=0, ox=0, oy=0;

      handle.addEventListener("pointerdown",(e)=>{
        dragging=true; handle.setPointerCapture(e.pointerId);
        const r = box.getBoundingClientRect();
        ox=r.left; oy=r.top; sx=e.clientX; sy=e.clientY;
      });
      handle.addEventListener("pointermove",(e)=>{
        if(!dragging) return;
        const dx=e.clientX-sx, dy=e.clientY-sy;
        let nx=ox+dx, ny=oy+dy;
        const vw=innerWidth, vh=innerHeight;
        const r=box.getBoundingClientRect();
        nx=Math.max(8, Math.min(nx, vw-r.width-8));
        ny=Math.max(8, Math.min(ny, vh-r.height-8));
        box.style.left=nx+"px";
        box.style.top=ny+"px";
        box.style.bottom="auto";
      });
      handle.addEventListener("pointerup",()=>dragging=false);
      handle.addEventListener("pointercancel",()=>dragging=false);
    })();

    async function loadItems(){
      metaEl.textContent = "Yükleniyor…";
      const res = await fetch(ITEMS_URL, { cache: "no-store" });
      items = await res.json();
      items.sort((a,b)=>a.title.localeCompare(b.title,"tr",{sensitivity:"base"}));
      render();
    }

    loadItems().catch(err=>{
      console.error(err);
      metaEl.textContent = "items.json yüklenemedi (Pages yayınlandı mı?)";
    });
  </script>

</body>
</html>
