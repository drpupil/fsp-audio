<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfabetik FSP A–Z</title>

  <!-- Plyr -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --border:#ececec;
      --muted:#6b7280;
      --bg:#ffffff;
      --rowHover:#f7f7f7;
      --rowActive:#e5f2ff;
      --btn:#f4f4f5;
      --btnBorder:#e5e7eb;
      --btnActive:#111827;
      --shadow:0 12px 40px rgba(0,0,0,.12);
      --radius:14px;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 18px;
      max-width: 1100px;
      color:#111;
    }

    h1{
      font-size: 28px;
      margin: 6px 0 14px 0;
      font-weight: 700;
      letter-spacing: -.2px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    #search{
      flex:1;
      min-width: 260px;
      padding: 10px 12px;
      border:1px solid var(--btnBorder);
      border-radius: 14px;
      outline:none;
      font-size:16px;
    }
    #search:focus{ border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.15); }

    .pill{
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--btnBorder);
      background:var(--btn);
      cursor:pointer;
      font-size:16px;
      user-select:none;
    }
    .pill:active{ transform: translateY(1px); }
    .pill.primary{ background:#fff; }
    .pill.primary:hover{ background:#fafafa; }

    .meta{
      font-size:14px;
      color:var(--muted);
      margin: 6px 0 10px 0;
    }

    /* Table header */
    .headerRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .colTitle{ flex:1; }
    .colActions{
      display:flex;
      align-items:center;
      gap:10px;
      width: 220px; /* right area */
      justify-content:flex-end;
    }

    .iconBtn{
      width:34px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      border:1px solid var(--btnBorder);
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-size:16px;
      line-height:1;
      opacity:.85;
    }
    .iconBtn:hover{ opacity:1; background:#fafafa; }
    .iconBtn.active{
      border-color:#a5b4fc;
      box-shadow:0 0 0 3px rgba(99,102,241,.12);
      opacity:1;
    }

    /* List rows */
    #list{ border-bottom:1px solid var(--border); }

    .item{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;       /* ↓ satır aralığı burada */
      border-bottom: 1px solid var(--border);
      cursor:pointer;
    }
    .item:hover{ background: var(--rowHover); }
    .item.active{ background: var(--rowActive); }

    .title{
      flex:1;
      font-size:16px;
      line-height:1.25;
      font-weight: 400;         /* bold olmasın */
    }

    .actions{
      width: 220px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-shrink:0;
    }

    .likeCount{
      min-width:18px;
      text-align:right;
      font-size:14px;
      color:var(--muted);
      margin-right:2px;
    }

    /* Floating player */
    #floatingPlayer{
      position:fixed;
      left: 18px;
      bottom: 18px;
      width: 520px;
      max-width: calc(100vw - 36px);
      background: var(--bg);
      border: 1px solid var(--btnBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index: 9999;
      display:flex;
      flex-direction:column;
    }

    .fpHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      cursor: grab;
      user-select:none;
    }
    .fpHead:active{ cursor: grabbing; }

    #fpTitle{
      font-size:14px;
      color:#111;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:600;
      flex:1;
    }
    .fpRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }

    .miniBtn{
      width:36px;
      height:32px;
      border-radius: 10px;
      border:1px solid var(--btnBorder);
      background:#fff;
      cursor:pointer;
      font-size:15px;
      opacity:.9;
    }
    .miniBtn:hover{ opacity:1; background:#fafafa; }
    .miniBtn:active{ transform: translateY(1px); }

    #fpMsg{
      padding: 8px 12px 0 12px;
      font-size:13px;
      color:var(--muted);
      min-height: 18px;
    }

    .fpBody{
      padding: 8px 12px 12px 12px;
    }

    /* Plyr inside fixed box */
    .plyr--audio .plyr__controls{
      border-radius: 12px;
    }

    /* Mobile tweaks */
    @media (max-width: 560px){
      #floatingPlayer{ width: calc(100vw - 36px); }
      .colActions, .actions{ width: 200px; }
    }
  </style>
</head>

<body>
  <h1>Alfabetik FSP A–Z</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />
    <button id="btnAll" class="pill primary">Hepsi</button>
  </div>

  <div class="meta" id="meta">Yükleniyor…</div>

  <div class="headerRow">
    <div class="colTitle">Kayıt</div>
    <div class="colActions" title="Filtre ikonları">
      <button id="filterLiked" class="iconBtn" title="Liked filtre">♥</button>
      <button id="filterFav"   class="iconBtn" title="Favori filtre">★</button>
      <button id="filterSel"   class="iconBtn" title="Seçili filtre">✓</button>
    </div>
  </div>

  <div id="list"></div>

  <!-- Floating Player -->
  <div id="floatingPlayer" aria-live="polite">
    <div class="fpHead" id="fpDrag">
      <div id="fpTitle">Bir kayıt seç…</div>
      <div class="fpRight">
        <button class="miniBtn" id="btnPrev" title="Önceki">⟪</button>
        <button class="miniBtn" id="btnNext" title="Sonraki">⟫</button>
        <div style="font-size:13px;color:var(--muted);padding-left:6px;">Sürükle</div>
      </div>
    </div>
    <div id="fpMsg"></div>
    <div class="fpBody">
      <audio id="player" class="js-player" controls preload="metadata"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // ====== CONFIG ======
    // Archive.org base URL (identifier klasörü)
    const ARCHIVE_BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

    // items.json'ı repoda köke koyuyorsun (sende zaten var)
    const ITEMS_JSON = "items.json";

    // ====== STATE ======
    let items = [];          // { title, file, url, ext }
    let activeIndex = null;  // index in items array
    let viewIndexes = [];    // current filtered indexes

    // Filters (AND)
    let filterLiked = false;
    let filterFav   = false;
    let filterSel   = false;

    // LocalStorage keys
    const LS = {
      liked:   "fsp_liked_v1",
      fav:     "fsp_fav_v1",
      sel:     "fsp_sel_v1",
      likeCnt: "fsp_likeCnt_v1",
      playerPos:"fsp_playerPos_v1"
    };

    const likedSet   = new Set(JSON.parse(localStorage.getItem(LS.liked)   || "[]"));
    const favSet     = new Set(JSON.parse(localStorage.getItem(LS.fav)     || "[]"));
    const selSet     = new Set(JSON.parse(localStorage.getItem(LS.sel)     || "[]"));
    const likeCounts = JSON.parse(localStorage.getItem(LS.likeCnt) || "{}"); // {file: number}

    // ====== DOM ======
    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl = document.getElementById("meta");

    const btnAll = document.getElementById("btnAll");
    const btnFilterLiked = document.getElementById("filterLiked");
    const btnFilterFav   = document.getElementById("filterFav");
    const btnFilterSel   = document.getElementById("filterSel");

    const fp = document.getElementById("floatingPlayer");
    const fpTitle = document.getElementById("fpTitle");
    const fpMsg = document.getElementById("fpMsg");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");

    const audioEl = document.getElementById("player");

    // Plyr controls: prev/next bizde ayrı; burada 5sn ileri/geri + normal kontroller
    const plyr = new Plyr(audioEl, {
      seekTime: 5,
      controls: [
        "rewind",
        "play",
        "fast-forward",
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume"
      ]
    });

    // ====== Helpers ======
    function saveSets(){
      localStorage.setItem(LS.liked, JSON.stringify([...likedSet]));
      localStorage.setItem(LS.fav,   JSON.stringify([...favSet]));
      localStorage.setItem(LS.sel,   JSON.stringify([...selSet]));
      localStorage.setItem(LS.likeCnt, JSON.stringify(likeCounts));
    }

    function buildUrl(file){
      return ARCHIVE_BASE + encodeURIComponent(file).replace(/%2F/g,"/");
    }

    function downloadUrl(file){
      // Çoğu durumda indirmeye zorlar
      return buildUrl(file) + "?download=1";
    }

    function extOf(file){
      const m = file.toLowerCase().match(/\.(m4a|mp3)$/);
      return m ? m[1] : "";
    }

    function mimeOf(ext){
      if (ext === "mp3") return "audio/mpeg";
      if (ext === "m4a") return "audio/mp4";
      return "audio/*";
    }

    function passesFilters(file){
      if (filterLiked && !likedSet.has(file)) return false;
      if (filterFav   && !favSet.has(file))   return false;
      if (filterSel   && !selSet.has(file))   return false;
      return true;
    }

    function computeView(){
      const q = searchEl.value.trim().toLowerCase();
      viewIndexes = [];
      for (let i=0;i<items.length;i++){
        const it = items[i];
        if (q && !it.title.toLowerCase().includes(q)) continue;
        if (!passesFilters(it.file)) continue;
        viewIndexes.push(i);
      }
      metaEl.textContent = `Görünen: ${viewIndexes.length} / Toplam: ${items.length}`;
    }

    function render(){
      computeView();

      listEl.innerHTML = "";
      for (const idx of viewIndexes){
        const it = items[idx];

        const row = document.createElement("div");
        row.className = "item" + (idx === activeIndex ? " active" : "");
        row.dataset.index = String(idx);

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;

        const actions = document.createElement("div");
        actions.className = "actions";

        const count = document.createElement("div");
        count.className = "likeCount";
        count.textContent = String(likeCounts[it.file] || 0);

        const bLike = document.createElement("button");
        bLike.className = "iconBtn" + (likedSet.has(it.file) ? " active" : "");
        bLike.title = "Like";
        bLike.textContent = "♥";

        const bFav = document.createElement("button");
        bFav.className = "iconBtn" + (favSet.has(it.file) ? " active" : "");
        bFav.title = "Favori";
        bFav.textContent = "★";

        const bSel = document.createElement("button");
        bSel.className = "iconBtn" + (selSet.has(it.file) ? " active" : "");
        bSel.title = "Seç";
        bSel.textContent = "✓";

        const bDl = document.createElement("button");
        bDl.className = "iconBtn";
        bDl.title = "İndir";
        bDl.textContent = "⬇";

        // Stop row click for buttons
        bLike.addEventListener("click", (e)=>{
          e.stopPropagation();
          // toggle + counter (tek tarayıcı için)
          if (likedSet.has(it.file)){
            likedSet.delete(it.file);
            likeCounts[it.file] = Math.max(0, (likeCounts[it.file]||0) - 1);
          } else {
            likedSet.add(it.file);
            likeCounts[it.file] = (likeCounts[it.file]||0) + 1;
          }
          saveSets();
          render();
        });

        bFav.addEventListener("click", (e)=>{
          e.stopPropagation();
          if (favSet.has(it.file)) favSet.delete(it.file);
          else favSet.add(it.file);
          saveSets();
          render();
        });

        bSel.addEventListener("click", (e)=>{
          e.stopPropagation();
          if (selSet.has(it.file)) selSet.delete(it.file);
          else selSet.add(it.file);
          saveSets();
          render();
        });

        bDl.addEventListener("click", (e)=>{
          e.stopPropagation();
          // Download attempt (cross-origin "download" attribute genelde çalışmaz)
          const a = document.createElement("a");
          a.href = downloadUrl(it.file);
          a.target = "_blank";
          a.rel = "noopener";
          document.body.appendChild(a);
          a.click();
          a.remove();
        });

        actions.appendChild(count);
        actions.appendChild(bLike);
        actions.appendChild(bFav);
        actions.appendChild(bSel);
        actions.appendChild(bDl);

        row.appendChild(title);
        row.appendChild(actions);

        row.addEventListener("click", ()=> playByIndex(idx, true));
        listEl.appendChild(row);
      }

      // header filter active states
      btnFilterLiked.classList.toggle("active", filterLiked);
      btnFilterFav.classList.toggle("active", filterFav);
      btnFilterSel.classList.toggle("active", filterSel);
    }

    async function playByIndex(idx, tryAutoplay){
      const it = items[idx];
      if (!it) return;

      activeIndex = idx;
      fpTitle.textContent = it.title;
      fpMsg.textContent = "";

      const url = it.url;
      const type = mimeOf(it.ext);

      // Plyr source set (daha stabil)
      plyr.source = {
        type: "audio",
        title: it.title,
        sources: [{ src: url, type }]
      };

      render();

      if (!tryAutoplay) return;

      // autoplay bazen engellenir -> yakala ve kullanıcıya söyle
      try{
        await plyr.play();
      }catch(err){
        fpMsg.innerHTML = `Oynatma başlatılamadı. Player’daki ▶ tuşuna bas. <a href="${url}" target="_blank" rel="noopener">dosyayı yeni sekmede aç</a>`;
      }
    }

    function playPrev(){
      if (!viewIndexes.length) return;
      if (activeIndex == null){
        playByIndex(viewIndexes[0], true);
        return;
      }
      const pos = viewIndexes.indexOf(activeIndex);
      const prev = viewIndexes[(pos - 1 + viewIndexes.length) % viewIndexes.length];
      playByIndex(prev, true);
    }

    function playNext(){
      if (!viewIndexes.length) return;
      if (activeIndex == null){
        playByIndex(viewIndexes[0], true);
        return;
      }
      const pos = viewIndexes.indexOf(activeIndex);
      const next = viewIndexes[(pos + 1) % viewIndexes.length];
      playByIndex(next, true);
    }

    btnPrev.addEventListener("click", (e)=>{ e.stopPropagation(); playPrev(); });
    btnNext.addEventListener("click", (e)=>{ e.stopPropagation(); playNext(); });

    // Space play/pause (input focus değilken)
    document.addEventListener("keydown", (e)=>{
      if (e.code !== "Space") return;
      const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
      if (tag === "input" || tag === "textarea") return;
      e.preventDefault();
      plyr.togglePlay();
    });

    // Search
    searchEl.addEventListener("input", ()=> render());

    // Hepsi: filtreleri + aramayı sıfırla
    btnAll.addEventListener("click", ()=>{
      filterLiked = false;
      filterFav = false;
      filterSel = false;
      searchEl.value = "";
      render();
    });

    // Header icon filters (toggle)
    btnFilterLiked.addEventListener("click", ()=>{ filterLiked = !filterLiked; render(); });
    btnFilterFav.addEventListener("click",   ()=>{ filterFav   = !filterFav;   render(); });
    btnFilterSel.addEventListener("click",   ()=>{ filterSel   = !filterSel;   render(); });

    // Track end -> next
    audioEl.addEventListener("ended", ()=> playNext());

    // ====== Draggable player (header-only) ======
    (function initDrag(){
      const drag = document.getElementById("fpDrag");
      let isDown = false;
      let startX=0, startY=0, startLeft=0, startTop=0;

      // restore pos
      try{
        const p = JSON.parse(localStorage.getItem(LS.playerPos) || "null");
        if (p && typeof p.left==="number" && typeof p.top==="number"){
          fp.style.left = p.left + "px";
          fp.style.top  = p.top + "px";
          fp.style.bottom = "auto";
        }
      }catch{}

      drag.addEventListener("pointerdown", (e)=>{
        isDown = true;
        drag.setPointerCapture(e.pointerId);
        const rect = fp.getBoundingClientRect();
        startX = e.clientX;
        startY = e.clientY;
        startLeft = rect.left;
        startTop  = rect.top;
      });

      drag.addEventListener("pointermove", (e)=>{
        if (!isDown) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let left = startLeft + dx;
        let top  = startTop  + dy;

        // clamp
        const maxLeft = window.innerWidth - fp.offsetWidth - 8;
        const maxTop  = window.innerHeight - fp.offsetHeight - 8;
        left = Math.max(8, Math.min(maxLeft, left));
        top  = Math.max(8, Math.min(maxTop, top));

        fp.style.left = left + "px";
        fp.style.top  = top  + "px";
        fp.style.bottom = "auto";
      });

      drag.addEventListener("pointerup", ()=>{
        if (!isDown) return;
        isDown = false;
        const rect = fp.getBoundingClientRect();
        localStorage.setItem(LS.playerPos, JSON.stringify({left: rect.left, top: rect.top}));
      });
    })();

    // ====== Load items.json ======
    async function loadItems(){
      const res = await fetch(ITEMS_JSON + "?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("items.json okunamadı: " + res.status);
      const data = await res.json();

      // Çok toleranslı mapping: array veya {items:[]}
      const arr = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
      const mapped = [];

      for (const x of arr){
        // olası formatlar:
        // - "filename.m4a"
        // - {file:"...", title:"..."}
        // - {name:"...", title:"..."}
        // - {name:"...", format:"..." ...}
        const file = (typeof x === "string") ? x : (x.file || x.name || x.filename || "");
        if (!file) continue;

        const ext = extOf(file);
        if (!ext) continue; // sadece mp3/m4a

        // başlık
        const title =
          (typeof x === "string")
            ? decodeURIComponent(file).replace(/\.(m4a|mp3)$/i,"")
            : (x.title || x.display || x.label || decodeURIComponent(file).replace(/\.(m4a|mp3)$/i,""));

        mapped.push({
          file,
          title,
          ext,
          url: buildUrl(file)
        });
      }

      // alfabetik
      mapped.sort((a,b)=> a.title.localeCompare(b.title, "tr", { sensitivity: "base" }));

      items = mapped;
      render();
    }

    loadItems().catch(err=>{
      console.error(err);
      metaEl.textContent = "Hata: items.json yüklenemedi.";
      listEl.innerHTML = `<div style="padding:14px;color:#b91c1c">items.json yüklenemedi. Repo kökünde olduğuna emin ol.</div>`;
    });
  </script>
</body>
</html>
