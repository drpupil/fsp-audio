<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Alfabetik FSP A–Z</title>

  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      max-width: 900px;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.75rem;
    }
    #search {
      width: 100%;
      max-width: 420px;
      padding: 0.45rem 0.6rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    #list {
      border-top: 1px solid #eee;
      margin-bottom: 1rem;
    }
    .item {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    .item:hover {
      background: #f7f7f7;
    }
    .item.active {
      background: #e6f1ff;
    }
    .title {
      flex: 1;
    }
    .badge {
      font-size: 0.75rem;
      color: #666;
      white-space: nowrap;
    }
    #current {
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      color: #333;
    }
  </style>
</head>
<body>

<h1>Alfabetik FSP A–Z</h1>

<input
  id="search"
  type="text"
  placeholder="Arama (ör. ACS, DM, PAVK)..."
/>

<div id="list"></div>

<div id="current">Yükleniyor…</div>

<audio id="player" class="js-player" controls></audio>

<!-- Plyr JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
  // Archive.org base URL
  const BASE =
    "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

  const listEl    = document.getElementById("list");
  const searchEl  = document.getElementById("search");
  const playerEl  = document.getElementById("player");
  const currentEl = document.getElementById("current");

  const plyr = new Plyr(playerEl, {
    controls: ["play", "progress", "current-time", "mute", "volume"]
  });

  let items = [];
  let activeIndex = null;

  function urlFor(item) {
    // ÖZEL KARAKTER + BOŞLUK GÜVENLİ
    return BASE + encodeURIComponent(item.file).replace(/%2F/g, "/");
  }

  function renderList(filterText = "") {
    const q = filterText.toLowerCase();
    listEl.innerHTML = "";

    items.forEach((item, index) => {
      if (!item.title.toLowerCase().includes(q)) return;

      const row = document.createElement("div");
      row.className = "item";
      if (index === activeIndex) row.classList.add("active");
      row.dataset.index = index;

      const title = document.createElement("span");
      title.className = "title";
      title.textContent = item.title;

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = item.info || "";

      row.appendChild(title);
      row.appendChild(badge);
      listEl.appendChild(row);
    });

    if (!listEl.children.length) {
      const empty = document.createElement("div");
      empty.style.padding = "0.75rem";
      empty.style.color = "#666";
      empty.textContent = "Sonuç bulunamadı.";
      listEl.appendChild(empty);
    }
  }

  function playIndex(index) {
    const item = items[index];
    if (!item) return;

    activeIndex = index;
    playerEl.src = urlFor(item);
    currentEl.textContent = "Şu an: " + item.title;
    renderList(searchEl.value);
    plyr.play();
  }

  async function loadItems() {
    try {
      const res = await fetch("./items.json", { cache: "no-store" });
      if (!res.ok) throw new Error("items.json yüklenemedi");

      const data = await res.json();
      items = data
        .filter(x => x && x.title && x.file)
        .map(x => ({ title: x.title, file: x.file, info: x.info || "" }));

      items.sort((a, b) => a.title.localeCompare(b.title, "de"));

      currentEl.textContent = `Toplam kayıt: ${items.length}`;
      renderList();
    } catch (err) {
      console.error(err);
      currentEl.textContent = "Kayıtlar yüklenemedi.";
    }
  }

  listEl.addEventListener("click", (e) => {
    const row = e.target.closest(".item");
    if (!row) return;
    playIndex(Number(row.dataset.index));
  });

  searchEl.addEventListener("input", () => {
    renderList(searchEl.value);
  });

  document.addEventListener("keydown", (e) => {
    const q = searchEl.value.toLowerCase();
    const filtered = items
      .map((item, index) => ({ item, index }))
      .filter(({ item }) => item.title.toLowerCase().includes(q));

    if (!filtered.length) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      const pos = filtered.findIndex(f => f.index === activeIndex);
      playIndex(filtered[(pos + 1) % filtered.length].index);
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      const pos = filtered.findIndex(f => f.index === activeIndex);
      playIndex(filtered[(pos - 1 + filtered.length) % filtered.length].index);
    }

    if (e.key === "Enter" && activeIndex === null) {
      playIndex(filtered[0].index);
    }
  });

  loadItems();
</script>

</body>
</html>
