<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alfabetik FSP A‚ÄìZ</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --blue:#1a73e8;
      --gold:#f3c969;
      --border:#e7e7e7;
      --muted:#666;
      --bgHover:#f7f7f7;
      --bgActive:#e6f1ff;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      max-width: 980px;
      padding-bottom: 210px;
    }
    h1{ font-size: 1.45rem; margin: 0 0 0.9rem; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap: .6rem;
      align-items:center;
      margin-bottom: 0.6rem;
    }

    #search{
      flex: 1;
      min-width: 240px;
      max-width: 620px;
      padding: 0.55rem 0.7rem;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 0.98rem;
    }

    .btn{
      padding: .52rem .7rem;
      border: 1px solid #ccc;
      border-radius: 12px;
      background:#fff;
      cursor:pointer;
      font-size:.92rem;
      white-space:nowrap;
      user-select:none;
      display:flex;
      align-items:center;
      gap:.45rem;
    }
    .btn:hover{ background:#f2f2f2; }
    .btn.primary{ border-color:#8ab4ff; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .pill{
      font-size:.82rem;
      padding:.18rem .45rem;
      border-radius:999px;
      border:1px solid #ddd;
      color:#444;
    }
    .pill.on{
      border-color:#bcd6ff;
      background:#eaf2ff;
      color: var(--blue);
    }

    #metaLine{
      font-size:.88rem;
      color: var(--muted);
      margin: .35rem 0 1rem;
    }

    #list{
      border-top: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .item{
      padding: 0.52rem 0.55rem;
      border-bottom: 1px solid #f2f2f2;
      display:flex;
      align-items:center;
      gap: .65rem;
      font-size: 0.98rem;
      position: relative;
    }
    .item:hover{ background: var(--bgHover); }
    .item.active{
      background: var(--bgActive);
      border-left: 4px solid var(--blue);
      padding-left: calc(0.55rem - 4px);
    }

    .title{
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      font-weight: 600;
    }

    .badge{
      font-size: 0.85rem;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
      min-width: 56px;
      text-align:right;
    }

    .actions{
      display:flex;
      gap: .35rem;
      align-items:center;
      flex: 0 0 auto;
    }

    .iconBtn{
      width: 30px;
      height: 30px;
      border: 1px solid #dcdcdc;
      background:#fff;
      border-radius: 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      line-height: 1;
      user-select:none;
      padding: 0;
    }
    .iconBtn:hover{ background:#f2f2f2; }

    /* SELECT */
    .iconBtn.select{
      border-width: 2px;
      border-color: #cfcfcf;
      background:#fff;
    }
    .iconBtn.select::before{
      content:"‚òê";
      font-size:16px;
      color:#888;
      transform: translateY(-0.5px);
    }
    .iconBtn.select.active{
      background: var(--blue);
      border-color: var(--blue);
    }
    .iconBtn.select.active::before{
      content:"‚úì";
      color:#fff;
      font-weight: 900;
    }

    /* FAVORITE */
    .iconBtn.star{
      border-width: 2px;
      border-color:#d8d8d8;
    }
    .iconBtn.star::before{
      content:"‚òÜ";
      font-size:16px;
      color:#777;
      transform: translateY(-0.5px);
    }
    .iconBtn.star.active{
      border-color: var(--gold);
      background: #fff8e6;
    }
    .iconBtn.star.active::before{
      content:"‚òÖ";
      color: #c69200;
    }

    /* DOWNLOAD */
    .iconBtn.dl{
      border-radius: 999px;
      width: 30px;
      height: 30px;
      font-size: 14px;
    }
    .iconBtn.dl::before{
      content:"‚¨áÔ∏é";
      transform: translateY(-0.5px);
      color:#444;
    }
    .iconBtn.dl:hover{
      background: #eaf2ff;
      border-color: #bcd6ff;
    }
    .iconBtn.dl:hover::before{
      color: var(--blue);
    }

    /* Floating draggable player */
    #floatingPlayer{
      position: fixed;
      left: 16px;
      bottom: 16px;
      width: min(560px, calc(100vw - 32px));
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding: 10px 12px;
      z-index: 9999;
    }
    #floatingPlayer.dragging{
      opacity: .93;
      cursor: grabbing;
    }
    #fpTitle{
      font-size: 0.92rem;
      font-weight: 750;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: grab;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
    }
    #fpTitleLeft{
      min-width:0;
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #fpTitleRight{
      display:flex;
      align-items:center;
      gap:.45rem;
      flex:0 0 auto;
    }

    #fpStatus{
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .smallNote{
      font-size:.82rem;
      color:#777;
      margin-top:.4rem;
    }

    @media (max-width: 520px){
      body{ margin: 1rem; }
      .iconBtn{ width: 36px; height: 36px; font-size: 15px; border-radius: 12px; }
      .iconBtn.dl{ width: 36px; height: 36px; }
      .badge{ min-width: 52px; }
    }
  </style>
</head>

<body>
  <h1>Alfabetik FSP A‚ÄìZ</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (√∂r. ACS, DM, PAVK)..." />

    <button id="toggleFavs" class="btn primary" type="button">‚≠ê Sadece favoriler</button>
    <button id="toggleShuffle" class="btn" type="button">
      üîÄ Karƒ±≈üƒ±k
      <span id="shufflePill" class="pill">Kapalƒ±</span>
    </button>
    <button id="clearSelection" class="btn" type="button">Se√ßimi temizle</button>
  </div>

  <div id="metaLine">Y√ºkleniyor‚Ä¶</div>
  <div id="list"></div>

  <div id="floatingPlayer">
    <div id="fpTitle">
      <span id="fpTitleLeft">Se√ßili kayƒ±t yok</span>
      <span id="fpTitleRight">
        <span id="modePill" class="pill">Sƒ±ralƒ±</span>
      </span>
    </div>
    <div id="fpStatus">Bir kayƒ±t se√ß.</div>

    <audio id="player" class="js-player" controls preload="auto"></audio>

    <div class="smallNote">ƒ∞pucu: Ba≈ülƒ±ktan tutup s√ºr√ºkleyebilirsin. 5 sn ileri/geri + hƒ±z: ‚öôÔ∏é</div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // === Archive item identifier ===
    const IDENT = "vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25";
    const BASE  = `https://archive.org/download/${IDENT}/`;

    const listEl   = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl   = document.getElementById("metaLine");

    const playerEl = document.getElementById("player");
    const titleLeftEl = document.getElementById("fpTitleLeft");
    const statusEl = document.getElementById("fpStatus");

    const btnToggleFavs = document.getElementById("toggleFavs");
    const btnToggleShuffle = document.getElementById("toggleShuffle");
    const shufflePill = document.getElementById("shufflePill");
    const modePill = document.getElementById("modePill");
    const btnClearSel   = document.getElementById("clearSelection");

    // Plyr: 5sn ileri/geri, hƒ±z ayarƒ±, prev/next + download
    const plyr = new Plyr(playerEl, {
      seekTime: 5,
      controls: [
        "rewind",
        "play",
        "fast-forward",
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume",
        "settings",
        "download"
      ],
      settings: ["speed"],
      speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2] }
    });

    let items = [];              // {file,title,info,url}
    let activeIndex = null;

    // state
    const LS_FAVS = "favs_v3";
    const LS_SEL  = "sel_v3";
    const LS_POS  = "floatingPlayerPos_v3";
    const LS_RESUME_PREFIX = "resume_v3_";
    const LS_LAST = "last_played_file_v3";
    const LS_SHUFFLE = "shuffle_v3";

    let favs = new Set();
    let selected = new Set();
    let onlyFavs = false;
    let shuffle = false;

    // shuffle order
    let playQueue = [];     // array of indices (filtered)
    let queuePos = -1;

    function escapeHtml(s){
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setStatus(text){
      statusEl.textContent = text || "";
    }

    function titleFromFilename(name){
      return name
        .replace(/\.(m4a|mp3)$/i, "")
        .replaceAll("_", " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function fileUrl(fileName){
      return new URL(fileName, BASE).href;
    }

    function formatSecondsToHMS(totalSeconds){
      const s = Math.max(0, Math.round(Number(totalSeconds) || 0));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;
      const mm = String(m).padStart(2, "0");
      const rr = String(r).padStart(2, "0");
      return h > 0 ? `${h}:${mm}:${rr}` : `${m}:${rr.padStart(2,"0")}`;
    }

    function normalizeDuration(raw){
      if (!raw) return "";
      const v = String(raw).trim();
      if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(v)) return v;
      if (/^\d+(\.\d+)?$/.test(v)) return formatSecondsToHMS(parseFloat(v));
      return "";
    }

    function saveFavs(){ localStorage.setItem(LS_FAVS, JSON.stringify(Array.from(favs))); }
    function loadFavs(){
      try{
        const a = JSON.parse(localStorage.getItem(LS_FAVS) || "[]");
        favs = new Set(Array.isArray(a) ? a : []);
      } catch { favs = new Set(); }
    }

    function saveSelection(){ localStorage.setItem(LS_SEL, JSON.stringify(Array.from(selected))); }
    function loadSelection(){
      try{
        const a = JSON.parse(localStorage.getItem(LS_SEL) || "[]");
        selected = new Set(Array.isArray(a) ? a : []);
      } catch { selected = new Set(); }
    }

    function resumeKey(file){ return LS_RESUME_PREFIX + file; }
    function saveResume(file, seconds){
      try{ localStorage.setItem(resumeKey(file), String(Math.floor(seconds || 0))); } catch {}
    }
    function loadResume(file){
      const v = localStorage.getItem(resumeKey(file));
      const n = v == null ? 0 : Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function updateMetaLine(){
      metaEl.textContent =
        `Toplam: ${items.length}  ‚Ä¢  Favori: ${favs.size}  ‚Ä¢  Se√ßili: ${selected.size}` +
        (onlyFavs ? "  ‚Ä¢  (Favori filtresi a√ßƒ±k)" : "");
    }

    function passesFilters(item){
      const q = searchEl.value.trim().toLowerCase();
      if (q && !item.title.toLowerCase().includes(q)) return false;
      if (onlyFavs && !favs.has(item.file)) return false;
      return true;
    }

    function renderList(){
      listEl.innerHTML = "";
      let shown = 0;

      items.forEach((item, index) => {
        if (!passesFilters(item)) return;
        shown++;

        const row = document.createElement("div");
        row.className = "item" + (index === activeIndex ? " active" : "");

        const isFav = favs.has(item.file);
        const isSel = selected.has(item.file);

        row.innerHTML = `
          <span class="title" data-action="play" data-index="${index}" title="${escapeHtml(item.title)}">${escapeHtml(item.title)}</span>
          <span class="badge">${escapeHtml(item.info || "")}</span>
          <span class="actions">
            <button class="iconBtn select ${isSel ? "active" : ""}" data-action="select" data-file="${escapeHtml(item.file)}" title="Se√ß"></button>
            <button class="iconBtn star ${isFav ? "active" : ""}" data-action="fav" data-file="${escapeHtml(item.file)}" title="Favori"></button>
            <button class="iconBtn dl" data-action="dl" data-file="${escapeHtml(item.file)}" title="ƒ∞ndir"></button>
          </span>
        `;

        listEl.appendChild(row);
      });

      if (!shown){
        listEl.innerHTML = "<div style='padding:0.9rem;color:#666'>Sonu√ß yok.</div>";
      }

      updateMetaLine();
      rebuildQueue(); // filtre deƒüi≈üince kuyruk g√ºncellensin
    }

    // --- Queue (ordered or shuffled) ---
    function buildFilteredIndices(){
      const arr = [];
      items.forEach((it, idx) => { if (passesFilters(it)) arr.push(idx); });
      return arr;
    }

    function shuffleArray(a){
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function rebuildQueue(){
      const filtered = buildFilteredIndices();
      if (!filtered.length){
        playQueue = [];
        queuePos = -1;
        return;
      }

      // if currently playing, keep it in the queue and keep position
      const current = activeIndex;

      if (!shuffle){
        playQueue = filtered; // alphabetical list order (items already sorted)
      } else {
        playQueue = shuffleArray(filtered.slice());
      }

      if (current != null){
        const pos = playQueue.indexOf(current);
        queuePos = pos >= 0 ? pos : -1;
      } else {
        queuePos = -1;
      }
    }

    function setShuffle(on){
      shuffle = !!on;
      localStorage.setItem(LS_SHUFFLE, shuffle ? "1" : "0");
      shufflePill.textContent = shuffle ? "A√ßƒ±k" : "Kapalƒ±";
      shufflePill.classList.toggle("on", shuffle);
      modePill.textContent = shuffle ? "Karƒ±≈üƒ±k" : "Sƒ±ralƒ±";
      modePill.classList.toggle("on", shuffle);
      rebuildQueue();
    }

    function nextIndex(){
      if (!playQueue.length) return null;
      if (queuePos < 0){
        // not in queue yet
        return playQueue[0];
      }
      queuePos = (queuePos + 1) % playQueue.length;
      return playQueue[queuePos];
    }

    function prevIndex(){
      if (!playQueue.length) return null;
      if (queuePos < 0){
        return playQueue[0];
      }
      queuePos = (queuePos - 1 + playQueue.length) % playQueue.length;
      return playQueue[queuePos];
    }

    async function playIndex(index, reason = "manual"){
      const item = items[index];
      if (!item) return;

      activeIndex = index;

      // Ensure queue is built and position set
      rebuildQueue();
      queuePos = playQueue.indexOf(index);

      const src = item.url;
      titleLeftEl.textContent = item.title;
      setStatus("Y√ºkleniyor‚Ä¶");

      // Plyr download button points to file
      plyr.config.urls = { download: src };

      renderList();

      try { playerEl.pause(); } catch {}
      playerEl.src = src;
      playerEl.load();

      const resumeAt = loadResume(item.file);
      const applyResumeOnce = () => {
        playerEl.removeEventListener("loadedmetadata", applyResumeOnce);
        if (resumeAt > 3 && playerEl.duration && resumeAt < playerEl.duration - 2) {
          playerEl.currentTime = resumeAt;
          setStatus(`Kaldƒ±ƒüƒ±n yerden devam: ${formatSecondsToHMS(resumeAt)}`);
        }
      };
      playerEl.addEventListener("loadedmetadata", applyResumeOnce);

      try{ localStorage.setItem(LS_LAST, item.file); } catch {}

      try{
        await playerEl.play();
        setStatus(shuffle ? "Oynatƒ±lƒ±yor (karƒ±≈üƒ±k)..." : "Oynatƒ±lƒ±yor (sƒ±ralƒ±)...");
      } catch {
        setStatus("Oynatma ba≈ülatƒ±lamadƒ±. Play tu≈üuna bas.");
      }
    }

    // Auto next on ended
    playerEl.addEventListener("ended", () => {
      const n = nextIndex();
      if (n != null) playIndex(n, "ended");
    });

    // Resume autosave
    let lastResumeWrite = 0;
    playerEl.addEventListener("timeupdate", () => {
      if (activeIndex == null) return;
      const item = items[activeIndex];
      if (!item) return;
      const now = Date.now();
      if (now - lastResumeWrite < 5000) return;
      lastResumeWrite = now;
      if (playerEl.currentTime > 2) saveResume(item.file, playerEl.currentTime);
    });

    // Keyboard: next/prev
    document.addEventListener("keydown", (e) => {
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;

      if (e.key === "ArrowRight"){
        e.preventDefault();
        const n = nextIndex();
        if (n != null) playIndex(n, "key");
      }
      if (e.key === "ArrowLeft"){
        e.preventDefault();
        const p = prevIndex();
        if (p != null) playIndex(p, "key");
      }
    });

    // Click actions
    listEl.addEventListener("click", (e) => {
      const el = e.target.closest("[data-action]");
      if (!el) return;

      const action = el.dataset.action;

      if (action === "play"){
        playIndex(Number(el.dataset.index));
        return;
      }

      const file = el.dataset.file;
      if (!file) return;

      if (action === "fav"){
        if (favs.has(file)) favs.delete(file);
        else favs.add(file);
        saveFavs();
        renderList();
        return;
      }

      if (action === "select"){
        if (selected.has(file)) selected.delete(file);
        else selected.add(file);
        saveSelection();
        renderList();
        return;
      }

      if (action === "dl"){
        // ‚ÄúYeni sekme‚Äù YOK. Direkt indirmeyi dene.
        const url = fileUrl(file);
        const a = document.createElement("a");
        a.href = url;
        a.download = file;      // bazƒ± tarayƒ±cƒ±larda cross-origin‚Äôde ignore edilebilir ama en iyi pratik bu
        a.rel = "noreferrer";
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }
    });

    // Search
    searchEl.addEventListener("input", () => renderList());

    // Only favs toggle
    btnToggleFavs.addEventListener("click", () => {
      onlyFavs = !onlyFavs;
      btnToggleFavs.textContent = onlyFavs ? "‚≠ê Favoriler a√ßƒ±k" : "‚≠ê Sadece favoriler";
      renderList();
    });

    // Shuffle toggle
    btnToggleShuffle.addEventListener("click", () => {
      setShuffle(!shuffle);
      // karƒ±≈üƒ±k a√ßƒ±lƒ±nca o anda √ßalan varsa kuyruƒüu yeniden d√ºzenledik
      setStatus(shuffle ? "Karƒ±≈üƒ±k mod a√ßƒ±ldƒ±." : "Sƒ±ralƒ± mod a√ßƒ±ldƒ±.");
    });

    // Clear selection
    btnClearSel.addEventListener("click", () => {
      selected.clear();
      saveSelection();
      renderList();
    });

    // Load from Archive metadata (durations included)
    async function loadFromArchive(){
      metaEl.textContent = "Archive.org‚Äôdan liste alƒ±nƒ±yor‚Ä¶";
      titleLeftEl.textContent = "Y√ºkleniyor‚Ä¶";
      setStatus("Liste hazƒ±rlanƒ±yor‚Ä¶");

      const metaUrl = `https://archive.org/metadata/${IDENT}`;
      const res = await fetch(metaUrl, { cache: "no-store" });
      if (!res.ok) throw new Error("metadata alƒ±namadƒ±");

      const meta = await res.json();
      const files = Array.isArray(meta.files) ? meta.files : [];

      items = files
        .filter(f => f && typeof f === "object" && typeof f.name === "string")
        .filter(f => f.name.toLowerCase().endsWith(".m4a"))
        .map(f => {
          const durRaw = f.length ?? f.duration ?? "";
          return {
            file: f.name,
            title: titleFromFilename(f.name),
            info: normalizeDuration(durRaw),
            url: fileUrl(f.name),
          };
        })
        .sort((a, b) => a.title.localeCompare(b.title, "de"));

      updateMetaLine();
      renderList();

      titleLeftEl.textContent = `Toplam kayƒ±t: ${items.length}`;
      setStatus("Bir kayƒ±t se√ß.");

      // restore last played hint
      const last = localStorage.getItem(LS_LAST);
      if (last){
        const idx = items.findIndex(x => x.file === last);
        if (idx >= 0){
          activeIndex = idx;
          titleLeftEl.textContent = items[idx].title;
          const resumeAt = loadResume(items[idx].file);
          if (resumeAt > 2) setStatus(`Son dinleme: ${formatSecondsToHMS(resumeAt)} (tƒ±klayƒ±nca devam eder)`);
          renderList();
        }
      }
    }

    // draggable floating player
    (function enableDrag(){
      const box = document.getElementById("floatingPlayer");
      const handle = document.getElementById("fpTitle");

      try{
        const saved = JSON.parse(localStorage.getItem(LS_POS) || "null");
        if (saved && typeof saved.x === "number" && typeof saved.y === "number") {
          box.style.left = saved.x + "px";
          box.style.top = saved.y + "px";
          box.style.right = "auto";
          box.style.bottom = "auto";
        }
      } catch {}

      let startX = 0, startY = 0;
      let boxX = 0, boxY = 0;
      let dragging = false;

      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

      function pointerDown(e){
        if (e.target.closest(".plyr__controls")) return;

        dragging = true;
        box.classList.add("dragging");

        const rect = box.getBoundingClientRect();
        boxX = rect.left;
        boxY = rect.top;

        const p = e.touches ? e.touches[0] : e;
        startX = p.clientX;
        startY = p.clientY;

        box.style.left = boxX + "px";
        box.style.top = boxY + "px";
        box.style.right = "auto";
        box.style.bottom = "auto";

        document.addEventListener(e.touches ? "touchmove" : "mousemove", pointerMove, { passive: false });
        document.addEventListener(e.touches ? "touchend" : "mouseup", pointerUp, { passive: false });
      }

      function pointerMove(e){
        if (!dragging) return;
        if (e.cancelable) e.preventDefault();

        const p = e.touches ? e.touches[0] : e;
        const dx = p.clientX - startX;
        const dy = p.clientY - startY;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const rect = box.getBoundingClientRect();

        const newLeft = clamp(boxX + dx, 8, vw - rect.width - 8);
        const newTop  = clamp(boxY + dy, 8, vh - rect.height - 8);

        box.style.left = newLeft + "px";
        box.style.top  = newTop + "px";
      }

      function pointerUp(){
        if (!dragging) return;
        dragging = false;
        box.classList.remove("dragging");

        const rect = box.getBoundingClientRect();
        localStorage.setItem(LS_POS, JSON.stringify({ x: rect.left, y: rect.top }));

        document.removeEventListener("mousemove", pointerMove);
        document.removeEventListener("mouseup", pointerUp);
        document.removeEventListener("touchmove", pointerMove);
        document.removeEventListener("touchend", pointerUp);
      }

      handle.addEventListener("mousedown", pointerDown);
      handle.addEventListener("touchstart", pointerDown, { passive: false });
    })();

    // init
    loadFavs();
    loadSelection();
    setShuffle(localStorage.getItem(LS_SHUFFLE) === "1");

    // Add prev/next buttons into Plyr controls (custom)
    // (Plyr has no built-in prev/next; we inject two buttons next to rewind/play.)
    (function injectPrevNext(){
      const tryInject = () => {
        const controls = document.querySelector("#floatingPlayer .plyr__controls");
        if (!controls) return false;

        // avoid duplicates
        if (controls.querySelector("[data-custom='prev']")) return true;

        const makeBtn = (label, title, onClick) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "plyr__control";
          btn.setAttribute("data-custom", label);
          btn.setAttribute("title", title);
          btn.setAttribute("aria-label", title);
          btn.innerHTML = label === "prev" ? "‚èÆ" : "‚è≠";
          btn.addEventListener("click", (e) => { e.preventDefault(); onClick(); });
          return btn;
        };

        const prevBtn = makeBtn("prev", "√ñnceki", () => {
          const p = prevIndex();
          if (p != null) playIndex(p, "prev");
        });
        const nextBtn = makeBtn("next", "Sonraki", () => {
          const n = nextIndex();
          if (n != null) playIndex(n, "next");
        });

        // insert near play button
        const playBtn = controls.querySelector("[data-plyr='play']");
        if (playBtn){
          controls.insertBefore(prevBtn, playBtn);
          controls.insertBefore(nextBtn, playBtn.nextSibling);
        } else {
          controls.prepend(prevBtn, nextBtn);
        }
        return true;
      };

      // wait a bit until plyr mounts
      const t = setInterval(() => {
        if (tryInject()) clearInterval(t);
      }, 200);
      setTimeout(() => clearInterval(t), 5000);
    })();

    loadFromArchive().catch(err => {
      console.error(err);
      metaEl.textContent = "Liste y√ºklenemedi (Archive.org metadata hatasƒ±).";
      titleLeftEl.textContent = "Liste y√ºklenemedi";
      setStatus("Aƒü/ge√ßici sorun olabilir. Yenile veya sonra tekrar dene.");
      listEl.innerHTML = "<div style='padding:0.9rem;color:#666'>Liste y√ºklenemedi.</div>";
    });
  </script>
</body>
</html>
