<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alfabetik FSP A–Z</title>

  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      max-width: 950px;
      padding-bottom: 190px; /* floating player sayfayı kapatmasın */
    }
    h1{ font-size: 1.45rem; margin: 0 0 0.9rem; }

    #search{
      width: 100%;
      max-width: 520px;
      padding: 0.55rem 0.7rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.98rem;
    }

    #list{
      border-top: 1px solid #eee;
      margin-bottom: 1rem;
    }
    .item{
      padding: 0.45rem 0.5rem;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.98rem;
    }
    .item:hover{ background: #f7f7f7; }
    .item.active{ background: #e6f1ff; }

    .title{
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .badge{
      font-size: 0.8rem;
      color: #666;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    /* Floating draggable player (default: sol-alt) */
    #floatingPlayer{
      position: fixed;
      left: 16px;
      bottom: 16px;
      right: auto;
      top: auto;

      width: min(480px, calc(100vw - 32px));
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding: 10px 12px;
      z-index: 9999;
    }
    #floatingPlayer.dragging{
      opacity: 0.92;
      cursor: grabbing;
    }
    #fpTitle{
      font-size: 0.92rem;
      font-weight: 650;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;

      /* drag handle */
      cursor: grab;
      user-select: none;
    }
    #fpStatus{
      font-size: 0.82rem;
      color: #666;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #fpStatus a{ color: inherit; text-decoration: underline; }
  </style>
</head>

<body>
  <h1>Alfabetik FSP A–Z</h1>

  <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />

  <div id="list"></div>

  <div id="floatingPlayer">
    <div id="fpTitle">Seçili kayıt yok</div>
    <div id="fpStatus">Bir kayıt seç.</div>
    <audio id="player" class="js-player" controls preload="auto"></audio>
  </div>

  <!-- Plyr JS -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // Archive item identifier
    const IDENT = "vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25";
    const BASE  = `https://archive.org/download/${IDENT}/`;

    const listEl   = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const playerEl = document.getElementById("player");
    const titleEl  = document.getElementById("fpTitle");
    const statusEl = document.getElementById("fpStatus");

    // Plyr UI (5 sn ileri/geri)
    const plyr = new Plyr(playerEl, {
      seekTime: 5,
      controls: [
        "rewind",
        "play",
        "fast-forward",
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume"
      ]
    });

    let items = [];
    let activeIndex = null;

    function escapeHtml(s){
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setStatus(text, link){
      if (link){
        statusEl.innerHTML =
          `${escapeHtml(text)} — <a href="${link}" target="_blank" rel="noreferrer">dosyayı yeni sekmede aç</a>`;
      } else {
        statusEl.textContent = text || "";
      }
    }

    function titleFromFilename(name){
      return name
        .replace(/\.(m4a|mp3)$/i, "")
        .replaceAll("_", " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function fileUrl(fileName){
      // doğru encode + case korur
      return new URL(fileName, BASE).href;
    }

    function formatSecondsToHMS(totalSeconds){
      const s = Math.max(0, Math.round(Number(totalSeconds) || 0));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;

      const mm = String(m).padStart(2, "0");
      const rr = String(r).padStart(2, "0");
      return h > 0 ? `${h}:${mm}:${rr}` : `${m}:${rr.padStart(2,"0")}`;
    }

    function normalizeDuration(raw){
      if (!raw) return "";
      const v = String(raw).trim();

      // "00:39:19" veya "39:19"
      if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(v)) return v;

      // "2359.12" gibi saniye
      if (/^\d+(\.\d+)?$/.test(v)) return formatSecondsToHMS(parseFloat(v));

      return "";
    }

    function renderList(filterText = ""){
      const q = filterText.toLowerCase();
      listEl.innerHTML = "";

      let shown = 0;
      items.forEach((item, index) => {
        if (!item.title.toLowerCase().includes(q)) return;
        shown++;

        const row = document.createElement("div");
        row.className = "item";
        if (index === activeIndex) row.classList.add("active");
        row.dataset.index = index;

        row.innerHTML = `
          <span class="title">${escapeHtml(item.title)}</span>
          <span class="badge">${escapeHtml(item.info || "")}</span>
        `;
        listEl.appendChild(row);
      });

      if (!shown){
        listEl.innerHTML = "<div style='padding:0.9rem;color:#666'>Sonuç yok.</div>";
      }
    }

    async function playIndex(index){
      const item = items[index];
      if (!item) return;

      activeIndex = index;

      const src = fileUrl(item.file);
      titleEl.textContent = item.title;
      setStatus("Yükleniyor…", src);
      renderList(searchEl.value);

      try { playerEl.pause(); } catch {}
      playerEl.src = src;
      playerEl.load();

      try {
        await playerEl.play();
      } catch {
        setStatus("Oynatma başlatılamadı. Play tuşuna bas veya linki yeni sekmede aç.", src);
      }
    }

    // Events
    playerEl.addEventListener("playing", () => {
      setStatus("Oynatılıyor…", playerEl.currentSrc || playerEl.src);
    });
    playerEl.addEventListener("pause", () => {
      if (playerEl.currentTime > 0 && !playerEl.ended) {
        setStatus("Duraklatıldı.", playerEl.currentSrc || playerEl.src);
      }
    });
    playerEl.addEventListener("ended", () => {
      setStatus("Bitti.", playerEl.currentSrc || playerEl.src);
    });
    playerEl.addEventListener("error", () => {
      const err = playerEl.error;
      const code = err ? err.code : 0;
      const src = playerEl.currentSrc || playerEl.src;

      const msg =
        code === 2 ? "Ağ hatası (link/erişim sorunu)" :
        code === 3 ? "Decode hatası (codec desteklenmiyor olabilir)" :
        code === 4 ? "Format desteklenmiyor veya link yanlış" :
        "Bilinmeyen hata";

      setStatus("Hata: " + msg, src);
    });

    // Click list
    listEl.addEventListener("click", (e) => {
      const row = e.target.closest(".item");
      if (!row) return;
      playIndex(Number(row.dataset.index));
    });

    // Search
    searchEl.addEventListener("input", () => renderList(searchEl.value));

    // Keyboard nav
    document.addEventListener("keydown", (e) => {
      const q = searchEl.value.toLowerCase();
      const filtered = items
        .map((item, index) => ({ item, index }))
        .filter(({ item }) => item.title.toLowerCase().includes(q));

      if (!filtered.length) return;

      if (e.key === "ArrowDown"){
        e.preventDefault();
        const pos = filtered.findIndex(f => f.index === activeIndex);
        const next = filtered[(pos + 1) % filtered.length].index;
        playIndex(next);
      } else if (e.key === "ArrowUp"){
        e.preventDefault();
        const pos = filtered.findIndex(f => f.index === activeIndex);
        const prev = filtered[(pos - 1 + filtered.length) % filtered.length].index;
        playIndex(prev);
      } else if (e.key === "Enter" && activeIndex == null){
        e.preventDefault();
        playIndex(filtered[0].index);
      }
    });

    // Load from Archive metadata + duration
    async function loadFromArchive(){
      try{
        titleEl.textContent = "Yükleniyor…";
        setStatus("Archive.org’dan liste alınıyor…", "");

        const metaUrl = `https://archive.org/metadata/${IDENT}`;
        const res = await fetch(metaUrl, { cache: "no-store" });
        if (!res.ok) throw new Error("metadata alınamadı");

        const meta = await res.json();
        const files = Array.isArray(meta.files) ? meta.files : [];

        items = files
          .filter(f => f && typeof f === "object" && typeof f.name === "string")
          .filter(f => f.name.toLowerCase().endsWith(".m4a"))
          .map(f => {
            // Archive'da bazen "length", bazen "duration" gelir
            const durRaw = f.length ?? f.duration ?? "";
            return {
              file: f.name,
              title: titleFromFilename(f.name),
              info: normalizeDuration(durRaw)
            };
          })
          .sort((a, b) => a.title.localeCompare(b.title, "de"));

        titleEl.textContent = `Toplam kayıt: ${items.length}`;
        setStatus("Bir kayıt seç.", "");
        renderList();

      } catch (e){
        console.error(e);
        titleEl.textContent = "Liste yüklenemedi";
        setStatus("Archive.org metadata erişimi başarısız (ağ/CORS/geçici sorun).", "");
        listEl.innerHTML = "<div style='padding:0.9rem;color:#666'>Liste yüklenemedi.</div>";
      }
    }

    // === Drag & Drop (desktop + mobile) + konumu hatırla ===
    (function enableDrag(){
      const box = document.getElementById("floatingPlayer");
      const handle = document.getElementById("fpTitle");

      // kaydedilmiş pozisyonu yükle
      try{
        const saved = JSON.parse(localStorage.getItem("floatingPlayerPos") || "null");
        if (saved && typeof saved.x === "number" && typeof saved.y === "number") {
          box.style.left = saved.x + "px";
          box.style.top = saved.y + "px";
          box.style.right = "auto";
          box.style.bottom = "auto";
        }
      } catch {}

      let startX = 0, startY = 0;
      let boxX = 0, boxY = 0;
      let dragging = false;

      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

      function pointerDown(e){
        // Slider/controls üstünde sürükleme olmasın
        if (e.target.closest(".plyr__controls")) return;

        dragging = true;
        box.classList.add("dragging");

        const rect = box.getBoundingClientRect();
        boxX = rect.left;
        boxY = rect.top;

        const p = e.touches ? e.touches[0] : e;
        startX = p.clientX;
        startY = p.clientY;

        // top/left ile sürükle
        box.style.left = boxX + "px";
        box.style.top = boxY + "px";
        box.style.right = "auto";
        box.style.bottom = "auto";

        document.addEventListener(e.touches ? "touchmove" : "mousemove", pointerMove, { passive: false });
        document.addEventListener(e.touches ? "touchend" : "mouseup", pointerUp, { passive: false });
      }

      function pointerMove(e){
        if (!dragging) return;
        if (e.cancelable) e.preventDefault();

        const p = e.touches ? e.touches[0] : e;
        const dx = p.clientX - startX;
        const dy = p.clientY - startY;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const rect = box.getBoundingClientRect();

        const newLeft = clamp(boxX + dx, 8, vw - rect.width - 8);
        const newTop  = clamp(boxY + dy, 8, vh - rect.height - 8);

        box.style.left = newLeft + "px";
        box.style.top  = newTop + "px";
      }

      function pointerUp(){
        if (!dragging) return;
        dragging = false;
        box.classList.remove("dragging");

        const rect = box.getBoundingClientRect();
        localStorage.setItem("floatingPlayerPos", JSON.stringify({ x: rect.left, y: rect.top }));

        document.removeEventListener("mousemove", pointerMove);
        document.removeEventListener("mouseup", pointerUp);
        document.removeEventListener("touchmove", pointerMove);
        document.removeEventListener("touchend", pointerUp);
      }

      // başlıktan tut sürükle
      handle.addEventListener("mousedown", pointerDown);
      handle.addEventListener("touchstart", pointerDown, { passive: false });
    })();

    loadFromArchive();
  </script>
</body>
</html>
