<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfabetik FSP A–Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --bg:#fff;
      --line:#eee;
      --muted:#666;
      --muted2:#888;
      --accent:#1677ff;
      --danger:#e11d48;
      --star:#f59e0b;
      --chip:#f5f5f7;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      margin: 18px;
      max-width: 1100px;
      background:var(--bg);
      color:#111;
    }
    h1{ font-size: 22px; margin: 0 0 12px; font-weight: 700; }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    #search{
      flex:1;
      min-width: 260px;
      padding: 10px 12px;
      border:1px solid #d9d9d9;
      border-radius: 10px;
      outline:none;
      font-size: 15px;
    }
    #search:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(22,119,255,.15); }

    .pill{
      padding: 9px 12px;
      border:1px solid #d9d9d9;
      border-radius: 10px;
      background:#fff;
      cursor:pointer;
      font-size: 14px;
      user-select:none;
    }
    .pill:hover{ background: var(--chip); }

    .meta{
      font-size: 13px;
      color: var(--muted);
      margin: 6px 0 10px;
    }

    #list{
      border-top:1px solid var(--line);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 8px 6px;           /* ✅ satır aralığı sıkı */
      border-bottom:1px solid var(--line);
      cursor:pointer;
    }
    .row:hover{ background:#fafafa; }
    .row.active{ background: rgba(22,119,255,.09); }

    .title{
      flex: 1;
      min-width: 0;
      font-size: 15px;            /* ✅ bold kaldırdım */
      font-weight: 400;
      line-height: 1.25;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .right{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      flex-shrink:0;
    }
    .dur{
      min-width: 52px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: 13px;
    }

    .iconbtn{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border:1px solid #d9d9d9;
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .iconbtn:hover{ background: var(--chip); }
    .iconbtn:active{ transform: translateY(1px); }

    .likeWrap{
      display:flex;
      align-items:center;
      gap:6px;
      min-width: 54px;
      justify-content:flex-end;
    }
    .likeCount{
      width: 18px;
      text-align:right;
      color: var(--muted2);
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }

    .heart{ color: var(--muted2); }
    .heart.on{ color: var(--danger); }

    .star{ color: var(--muted2); }
    .star.on{ color: var(--star); }

    /* Floating player */
    #floatingPlayer{
      position: fixed;
      left: 18px;
      bottom: 18px;
      width: min(620px, calc(100vw - 36px));
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      z-index: 9999;
      overflow:hidden;
    }
    #fpHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #fcfcfd;
      cursor: grab;               /* ✅ sürüklenebilir */
      user-select:none;
    }
    #fpHeader:active{ cursor: grabbing; }

    #fpTitle{
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      flex:1;
    }
    #fpStatus{
      padding: 0 12px 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .fpControls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }
    .tiny{
      width: 34px; height: 34px;
      border-radius: 10px;
      border: 1px solid #d9d9d9;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .tiny:hover{ background: var(--chip); }
    .tiny:active{ transform: translateY(1px); }

    /* Plyr iç boşluk */
    #fpBody{ padding: 8px 10px 10px; }

    /* Mobilde biraz küçült */
    @media (max-width: 520px){
      .dur{ display:none; }
      .likeWrap{ min-width: auto; }
      #floatingPlayer{ width: calc(100vw - 24px); left:12px; bottom:12px; }
    }
  </style>
</head>
<body>

  <h1>Alfabetik FSP A–Z</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />
    <button id="clearFilter" class="pill" title="Aramayı temizle + filtreleri sıfırla">Hepsi</button>
  </div>

  <div class="meta" id="meta">Yükleniyor...</div>

  <div id="list"></div>

  <!-- Floating player -->
  <div id="floatingPlayer" role="region" aria-label="Player">
    <div id="fpHeader">
      <div id="fpTitle">Bir kayıt seç…</div>
      <div class="fpControls">
        <button id="btnPrev" class="tiny" title="Önceki">⏮</button>
        <button id="btnNext" class="tiny" title="Sonraki">⏭</button>
      </div>
    </div>
    <div id="fpStatus"></div>
    <div id="fpBody">
      <audio id="player" class="js-player" controls preload="none" crossorigin="anonymous"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    const BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";
    const ITEMS_URL = "./items.json";

    const listEl   = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl   = document.getElementById("meta");

    const fpTitle  = document.getElementById("fpTitle");
    const fpStatus = document.getElementById("fpStatus");
    const btnPrev  = document.getElementById("btnPrev");
    const btnNext  = document.getElementById("btnNext");

    const playerEl = document.getElementById("player");

    // Plyr
    const plyr = new Plyr(playerEl, {
      seekTime: 5, // ✅ -5/+5
      controls: [
        "rewind",
        "play",
        "fast-forward",
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume"
      ]
    });

    let items = [];
    let activeIndex = null; // items[] index
    let filteredIdx = [];   // items index list

    // Local storage (device bazlı)
    const LS_LIKES = "fsp_likes_v1";
    const LS_FAVS  = "fsp_favs_v1";
    const LS_DURS  = "fsp_durations_v1";

    const likes = JSON.parse(localStorage.getItem(LS_LIKES) || "{}");   // file -> number
    const favs  = JSON.parse(localStorage.getItem(LS_FAVS)  || "{}");   // file -> true
    const durs  = JSON.parse(localStorage.getItem(LS_DURS)  || "{}");   // file -> "mm:ss"

    function saveLikes(){ localStorage.setItem(LS_LIKES, JSON.stringify(likes)); }
    function saveFavs(){  localStorage.setItem(LS_FAVS,  JSON.stringify(favs));  }
    function saveDurs(){  localStorage.setItem(LS_DURS,  JSON.stringify(durs));  }

    function urlFor(item){
      return BASE + item.file;
    }

    function fmtTime(sec){
      if (!isFinite(sec) || sec <= 0) return "";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    }

    function buildFiltered(){
      const q = (searchEl.value || "").trim().toLowerCase();
      filteredIdx = [];
      for (let i = 0; i < items.length; i++){
        if (!q || items[i].title.toLowerCase().includes(q)) filteredIdx.push(i);
      }
      metaEl.textContent = `Görünen: ${filteredIdx.length} / Toplam: ${items.length}`;
    }

    function render(){
      buildFiltered();
      listEl.innerHTML = "";

      for (const idx of filteredIdx){
        const it = items[idx];
        const row = document.createElement("div");
        row.className = "row" + (idx === activeIndex ? " active" : "");
        row.dataset.index = String(idx);

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;

        const right = document.createElement("div");
        right.className = "right";

        // duration (önceden biliniyorsa göster)
        const dur = document.createElement("div");
        dur.className = "dur";
        dur.textContent = durs[it.file] || "";
        right.appendChild(dur);

        // like
        const likeWrap = document.createElement("div");
        likeWrap.className = "likeWrap";

        const likeCount = document.createElement("div");
        likeCount.className = "likeCount";
        likeCount.textContent = String(likes[it.file] || 0);

        const likeBtn = document.createElement("button");
        likeBtn.className = "iconbtn";
        likeBtn.title = "Like";
        const heart = document.createElement("span");
        heart.className = "heart" + ((likes[it.file] || 0) > 0 ? " on" : "");
        heart.textContent = "♥";
        likeBtn.appendChild(heart);

        likeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          likes[it.file] = (likes[it.file] || 0) + 1;
          saveLikes();
          render();
        });

        likeWrap.appendChild(likeCount);
        likeWrap.appendChild(likeBtn);
        right.appendChild(likeWrap);

        // fav
        const favBtn = document.createElement("button");
        favBtn.className = "iconbtn";
        favBtn.title = "Favori";
        const star = document.createElement("span");
        star.className = "star" + (favs[it.file] ? " on" : "");
        star.textContent = "★";
        favBtn.appendChild(star);

        favBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          favs[it.file] = !favs[it.file];
          if (!favs[it.file]) delete favs[it.file];
          saveFavs();
          render();
        });

        right.appendChild(favBtn);

        // download (küçük ikon)
        const dl = document.createElement("a");
        dl.className = "iconbtn";
        dl.title = "İndir / Aç";
        dl.href = urlFor(it);
        dl.target = "_blank";
        dl.rel = "noopener";
        dl.textContent = "⬇";
        dl.addEventListener("click", (e) => e.stopPropagation());
        right.appendChild(dl);

        row.appendChild(title);
        row.appendChild(right);

        row.addEventListener("click", () => {
          // ✅ satır tıklaması user-gesture => autoplay denemesi burada
          playIndex(idx, true);
        });

        listEl.appendChild(row);
      }
    }

    function findActivePos(){
      if (activeIndex == null) return -1;
      return filteredIdx.indexOf(activeIndex);
    }

    function playPrev(){
      if (!filteredIdx.length) return;
      const pos = findActivePos();
      const nextPos = (pos <= 0) ? (filteredIdx.length - 1) : (pos - 1);
      playIndex(filteredIdx[nextPos], true);
    }

    function playNext(){
      if (!filteredIdx.length) return;
      const pos = findActivePos();
      const nextPos = (pos === -1 || pos >= filteredIdx.length - 1) ? 0 : (pos + 1);
      playIndex(filteredIdx[nextPos], true);
    }

    btnPrev.addEventListener("click", playPrev);
    btnNext.addEventListener("click", playNext);

    async function playIndex(index, userInitiated){
      const it = items[index];
      if (!it) return;

      activeIndex = index;
      fpTitle.textContent = it.title;
      fpStatus.textContent = "Yükleniyor…";

      // Kaynak değiştir
      playerEl.src = urlFor(it);
      playerEl.load(); // ✅ önce yükle

      render();

      // Autoplay denemesi: sadece gerçekten kullanıcı tıklamasıyla geldiyse
      if (userInitiated){
        try{
          // play() promise döner; yakalayalım
          await plyr.play();
          fpStatus.textContent = "";
        }catch(err){
          // Tarayıcı engelledi
          fpStatus.innerHTML =
            "Oynatma başlatılamadı. Player’daki ▶ tuşuna bas (tarayıcı kısıtı olabilir).";
        }
      } else {
        fpStatus.textContent = "Hazır. Oynatmak için ▶ veya Space.";
      }
    }

    // Metadata geldiğinde süreyi kaydet (cihazında birikir)
    playerEl.addEventListener("loadedmetadata", () => {
      const dur = fmtTime(playerEl.duration);
      if (activeIndex != null){
        const f = items[activeIndex].file;
        if (dur && durs[f] !== dur){
          durs[f] = dur;
          saveDurs();
          render();
        }
      }
    });

    // Track bitince otomatik sonraki
    playerEl.addEventListener("ended", () => {
      playNext();
    });

    // Arama
    searchEl.addEventListener("input", render);

    // Hepsi butonu: aramayı temizle + aktif filtreyi sıfırla
    document.getElementById("clearFilter").addEventListener("click", () => {
      searchEl.value = "";
      render();
    });

    // Space: play/pause (inputta yazarken devre dışı)
    document.addEventListener("keydown", async (e) => {
      const tag = (document.activeElement && document.activeElement.tagName) || "";
      if (tag === "INPUT" || tag === "TEXTAREA") return;

      if (e.code === "Space"){
        e.preventDefault();
        try{
          if (plyr.playing) plyr.pause();
          else await plyr.play();
        }catch{
          // autoplay engeli olabilir -> kullanıcı zaten space’e bastı, bazen yine de engelleyebilir
          fpStatus.textContent = "Oynatma başlatılamadı. ▶ tuşuna basmayı dene.";
        }
      } else if (e.key === "ArrowDown"){
        e.preventDefault();
        if (!filteredIdx.length) return;
        const pos = findActivePos();
        const nextPos = (pos === -1 || pos >= filteredIdx.length - 1) ? 0 : (pos + 1);
        // ok ile sadece seç/ hazırla, autoplay zorlamayalım
        playIndex(filteredIdx[nextPos], false);
      } else if (e.key === "ArrowUp"){
        e.preventDefault();
        if (!filteredIdx.length) return;
        const pos = findActivePos();
        const nextPos = (pos <= 0) ? (filteredIdx.length - 1) : (pos - 1);
        playIndex(filteredIdx[nextPos], false);
      }
    });

    // Floating player drag
    (function makeDraggable(){
      const box = document.getElementById("floatingPlayer");
      const handle = document.getElementById("fpHeader");

      let dragging = false;
      let startX = 0, startY = 0;
      let origX = 0, origY = 0;

      function getRect(){
        const r = box.getBoundingClientRect();
        return { x: r.left, y: r.top };
      }

      handle.addEventListener("pointerdown", (e) => {
        dragging = true;
        handle.setPointerCapture(e.pointerId);
        const r = getRect();
        origX = r.x; origY = r.y;
        startX = e.clientX; startY = e.clientY;
      });

      handle.addEventListener("pointermove", (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let nx = origX + dx;
        let ny = origY + dy;

        // ekran içinde tut
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const r = box.getBoundingClientRect();
        nx = Math.max(8, Math.min(nx, vw - r.width - 8));
        ny = Math.max(8, Math.min(ny, vh - r.height - 8));

        box.style.left = nx + "px";
        box.style.top = ny + "px";
        box.style.bottom = "auto";
      });

      handle.addEventListener("pointerup", () => { dragging = false; });
      handle.addEventListener("pointercancel", () => { dragging = false; });
    })();

    async function loadItems(){
      metaEl.textContent = "Yükleniyor…";
      const res = await fetch(ITEMS_URL, { cache: "no-store" });
      items = await res.json();
      // alfabetik
      items.sort((a,b) => a.title.localeCompare(b.title, "tr", { sensitivity: "base" }));
      render();
      metaEl.textContent = `Görünen: ${filteredIdx.length} / Toplam: ${items.length}`;
    }

    loadItems().catch(err => {
      metaEl.textContent = "items.json yüklenemedi. (Pages yayınlandı mı?)";
      console.error(err);
    });
  </script>
</body>
</html>
