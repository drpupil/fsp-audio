<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Alfabetik FSP A–Z</title>

  <!-- Plyr -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --bg:#fff;
      --text:#111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#2563eb;
      --blueSoft:#eaf2ff;
      --btn:#f8fafc;
      --shadow:0 10px 30px rgba(0,0,0,.12);
      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1180px;
      margin: 18px auto 120px; /* player için alt boşluk */
      padding: 0 14px;
    }

    h1{
      font-size: 44px;
      letter-spacing:-.02em;
      margin: 10px 0 12px;
      font-weight: 800;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }

    .search{
      flex: 1 1 360px;
      min-width: 240px;
      height: 54px;
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 0 16px;
      font-size: 18px;
      outline: none;
    }

    .btn{
      height: 54px;
      padding: 0 18px;
      border:1px solid var(--line);
      background: var(--btn);
      border-radius: 16px;
      font-size:18px;
      cursor:pointer;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(37,99,235,.35);
      color: var(--blue);
      background: #fff;
    }

    .meta{
      color: var(--muted);
      font-size: 18px;
      margin: 10px 0 14px;
    }

    /* Grid tablo */
    .table{
      border-top:1px solid var(--line);
    }

    /* sütunlar: Başlık | LikeCount | Like | Fav | Seç | İndir | Süre */
    .row{
      display:grid;
      grid-template-columns: 1fr 42px 44px 44px 44px 44px 78px;
      align-items:center;
      gap: 8px;
      padding: 6px 8px;           /* ✅ daha dar satır */
      border-bottom:1px solid var(--line);
    }
    .row.header{
      padding: 7px 8px;          /* ✅ daha dar başlık */
      color: var(--muted);
      font-size: 16px;
    }

    .title{
      min-width:0;
      font-size: 22px;
      line-height: 1.10;         /* ✅ daha sıkı */
      white-space: nowrap;       /* ✅ mobilde tek satır */
      overflow: hidden;
      text-overflow: ellipsis;
      cursor:pointer;
      user-select:none;
    }

    .row.active{ background: var(--blueSoft); }

    .likeCount{
      text-align:right;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: 18px;
    }

    .duration{
      text-align:right;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: 18px;
    }

    .iconBtn{
      width: 36px;               /* ✅ kompakt */
      height: 36px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{transform: translateY(1px)}
    .iconBtn svg{width:18px;height:18px}
    .iconBtn.on{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12) inset;
    }
    .iconBtn.like.on{ border-color: rgba(220,38,38,.6); box-shadow: 0 0 0 3px rgba(220,38,38,.12) inset; }
    .iconBtn.fav.on{ border-color: rgba(245,158,11,.7); box-shadow: 0 0 0 3px rgba(245,158,11,.14) inset; }

    .header .iconBtn{
      opacity:.55;
    }
    .header .iconBtn.filterOn{
      opacity: 1;
      border-color: rgba(37,99,235,.65);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12) inset;
    }
    .header .iconBtn.like.filterOn{
      border-color: rgba(220,38,38,.65);
      box-shadow: 0 0 0 3px rgba(220,38,38,.12) inset;
    }
    .header .iconBtn.fav.filterOn{
      border-color: rgba(245,158,11,.75);
      box-shadow: 0 0 0 3px rgba(245,158,11,.14) inset;
    }

    /* Player */
    #floatingPlayer{
      position: fixed;
      left: 14px;
      bottom: 14px;
      width: min(920px, calc(100vw - 28px));
      background:#fff;
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index: 9999;
      touch-action: none;
    }
    .fpHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
    .fpTitle{
      min-width:0;
      font-size: 18px;
      font-weight: 650;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .fpRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .dragHandle{
      color: var(--muted);
      font-size: 14px;
      user-select:none;
    }
    .navBtn{
      width: 40px;
      height: 36px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .navBtn:active{transform: translateY(1px)}
    .navBtn svg{width:18px;height:18px}
    .fpBody{
      padding: 10px 12px 12px;
    }
    .status{
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 6px;
      min-height: 18px;
    }

    /* Plyr kompakt */
    .plyr--audio .plyr__controls{
      padding: 10px !important;
      border-radius: 14px;
    }

    /* Mobil düzen: buton alt satıra düşebilir ama hizalar bozulmasın */
    @media (max-width: 720px){
      h1{font-size:40px}
      .row{
        grid-template-columns: 1fr 34px 40px 40px 40px 40px 64px;
        gap: 6px;
      }
      .title{font-size:20px}
      .duration,.likeCount{font-size:16px}
      .iconBtn{width:34px;height:34px}
      #floatingPlayer{
        left: 10px; bottom: 10px; width: calc(100vw - 20px);
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alfabetik FSP A–Z</h1>

    <div class="topbar">
      <input id="q" class="search" placeholder="Arama (ör. ACS, DM, PAVK)..." autocomplete="off" />
      <button id="clearFilters" class="btn primary">Hepsi</button>
    </div>

    <div id="meta" class="meta">Yükleniyor…</div>

    <div class="table">
      <div class="row header">
        <div>Kayıt</div>
        <div></div>

        <!-- Header ikonları: tıkla = filtre -->
        <button id="filterLike" class="iconBtn like" title="Like filtre">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 21s-7-4.35-9.33-8.16C.6 9.38 2.42 6 6 6c1.86 0 3.41 1 4 2 0.59-1 2.14-2 4-2 3.58 0 5.4 3.38 3.33 6.84C19 16.65 12 21 12 21z"/>
          </svg>
        </button>

        <button id="filterFav" class="iconBtn fav" title="Favori filtre">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 17.3l-6.18 3.7 1.64-7.03L2 9.24l7.19-.61L12 2l2.81 6.63L22 9.24l-5.46 4.73L18.18 21z"/>
          </svg>
        </button>

        <button id="filterSel" class="iconBtn" title="Seçili filtre">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
        </button>

        <div></div>
        <div style="text-align:right;">Süre</div>
      </div>

      <div id="list"></div>
    </div>
  </div>

  <!-- Floating Player -->
  <div id="floatingPlayer" aria-label="Player">
    <div class="fpHeader" id="dragBar">
      <div class="fpTitle" id="fpTitle">Bir kayıt seç…</div>
      <div class="fpRight">
        <button id="prevBtn" class="navBtn" title="Önceki">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 18l-6-6 6-6v12z"/></svg>
        </button>
        <button id="nextBtn" class="navBtn" title="Sonraki">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 6l6 6-6 6V6z"/></svg>
        </button>
        <div class="dragHandle">Sürükle</div>
      </div>
    </div>
    <div class="fpBody">
      <div class="status" id="status"></div>
      <audio id="player" class="js-player" controls preload="metadata"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    // ======================
    // Yardımcılar
    // ======================
    const $ = (id) => document.getElementById(id);

    const LS = {
      like: "fsp_like_v1",
      fav: "fsp_fav_v1",
      sel: "fsp_sel_v1",
      dur: "fsp_dur_v1",
      playerPos: "fsp_player_pos_v1"
    };

    const safeJson = (v, fallback) => {
      try { return JSON.parse(v); } catch { return fallback; }
    };

    const getStore = (key) => safeJson(localStorage.getItem(key), {});
    const setStore = (key, obj) => localStorage.setItem(key, JSON.stringify(obj));

    const fmtTime = (sec) => {
      if (!isFinite(sec) || sec <= 0) return "—";
      const s = Math.floor(sec % 60).toString().padStart(2,"0");
      const m = Math.floor((sec/60) % 60).toString().padStart(2,"0");
      const h = Math.floor(sec/3600);
      return h > 0 ? `${h}:${m}:${s}` : `${m}:${s}`;
    };

    const extOk = (url) => {
      const u = (url || "").toLowerCase();
      return u.endsWith(".m4a") || u.endsWith(".mp3");
    };

    // ======================
    // Durum
    // ======================
    let items = [];
    let filteredIdx = [];    // gösterilen indeksler
    let activeIndex = null;  // items içindeki index
    let plyr = null;

    let filter = {
      like: false,
      fav: false,
      sel: false
    };

    // ======================
    // Plyr
    // ======================
    function initPlyr(){
      const audio = $("player");

      // iOS için daha stabil
      audio.setAttribute("playsinline", "");
      audio.setAttribute("preload", "metadata");

      plyr = new Plyr(audio, {
        seekTime: 5,
        controls: [
          "rewind",
          "play",
          "fast-forward",
          "progress",
          "current-time",
          "duration",
          "mute",
          "volume",
          "settings"
        ],
        settings: ["speed"],
        speed: {
          selected: 1,
          // ✅ istediğin hızlar (uçlar yok)
          options: [0.8, 0.9, 1, 1.1, 1.25, 1.5]
        }
      });

      audio.addEventListener("loadedmetadata", () => {
        if (activeIndex == null) return;
        const durStore = getStore(LS.dur);
        durStore[items[activeIndex].url] = audio.duration;
        setStore(LS.dur, durStore);
        // sadece o satırı güncelle
        const durEl = document.querySelector(`[data-dur="${activeIndex}"]`);
        if (durEl) durEl.textContent = fmtTime(audio.duration);
      });

      audio.addEventListener("error", () => {
        $("status").textContent = "Oynatma başlatılamadı. İndir ikonuyla indirip yerelden deneyebilirsin.";
      });

      // Space ile play/pause (input odaktayken değil)
      document.addEventListener("keydown", (e) => {
        if (e.code !== "Space") return;
        const tag = (document.activeElement?.tagName || "").toLowerCase();
        if (tag === "input" || tag === "textarea") return;
        e.preventDefault();
        try { plyr.togglePlay(); } catch {}
      });
    }

    // ======================
    // Liste render
    // ======================
    function computeFiltered(){
      const q = $("q").value.trim().toLowerCase();
      const likeStore = getStore(LS.like);
      const favStore  = getStore(LS.fav);
      const selStore  = getStore(LS.sel);

      filteredIdx = items
        .map((it, idx) => ({it, idx}))
        .filter(({it}) => {
          if (q && !it.titleLower.includes(q)) return false;
          if (filter.like && !likeStore[it.url]) return false;
          if (filter.fav  && !favStore[it.url])  return false;
          if (filter.sel  && !selStore[it.url])  return false;
          return true;
        })
        .map(x => x.idx);

      $("meta").textContent = `Görünen: ${filteredIdx.length} / Toplam: ${items.length}`;
    }

    function renderList(){
      computeFiltered();

      const likeStore = getStore(LS.like);
      const favStore  = getStore(LS.fav);
      const selStore  = getStore(LS.sel);
      const durStore  = getStore(LS.dur);

      const root = $("list");
      root.innerHTML = "";

      for (const idx of filteredIdx){
        const it = items[idx];

        const row = document.createElement("div");
        row.className = "row" + (idx === activeIndex ? " active" : "");
        row.dataset.idx = idx;

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;
        title.addEventListener("click", () => playIndex(idx));

        const likeCount = document.createElement("div");
        likeCount.className = "likeCount";
        likeCount.textContent = likeStore[it.url] ? "1" : "0"; // backend yok; tarayıcı bazlı

        const likeBtn = iconBtn("like", likeStore[it.url]);
        likeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleStore(LS.like, it.url);
          renderList();
        });

        const favBtn = iconBtn("fav", favStore[it.url]);
        favBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleStore(LS.fav, it.url);
          renderList();
        });

        const selBtn = iconBtn("sel", selStore[it.url]);
        selBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleStore(LS.sel, it.url);
          renderList();
        });

        const dlBtn = iconBtn("dl", false);
        dlBtn.title = "İndir";
        dlBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          downloadFile(it.url, it.title);
        });

        const dur = document.createElement("div");
        dur.className = "duration";
        dur.dataset.dur = idx;
        dur.textContent = fmtTime(durStore[it.url]);

        row.appendChild(title);
        row.appendChild(likeCount);
        row.appendChild(likeBtn);
        row.appendChild(favBtn);
        row.appendChild(selBtn);
        row.appendChild(dlBtn);
        row.appendChild(dur);

        root.appendChild(row);
      }

      // header filtre ikonlarının görünümü
      setHeaderFilterUI();
    }

    function iconBtn(kind, on){
      const b = document.createElement("button");
      b.className = "iconBtn" + (on ? " on" : "");
      if (kind === "like") b.classList.add("like");
      if (kind === "fav") b.classList.add("fav");

      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("viewBox","0 0 24 24");
      svg.setAttribute("fill","none");
      svg.setAttribute("stroke","currentColor");
      svg.setAttribute("stroke-width","2");

      if (kind === "like"){
        svg.innerHTML = `<path d="M12 21s-7-4.35-9.33-8.16C.6 9.38 2.42 6 6 6c1.86 0 3.41 1 4 2 0.59-1 2.14-2 4-2 3.58 0 5.4 3.38 3.33 6.84C19 16.65 12 21 12 21z"/>`;
      } else if (kind === "fav"){
        svg.innerHTML = `<path d="M12 17.3l-6.18 3.7 1.64-7.03L2 9.24l7.19-.61L12 2l2.81 6.63L22 9.24l-5.46 4.73L18.18 21z"/>`;
      } else if (kind === "sel"){
        svg.innerHTML = `<path d="M20 6L9 17l-5-5"/>`;
      } else if (kind === "dl"){
        svg.innerHTML = `<path d="M12 3v12"/><path d="M7 10l5 5 5-5"/><path d="M5 21h14"/>`;
      }

      b.appendChild(svg);
      return b;
    }

    function toggleStore(key, url){
      const st = getStore(key);
      st[url] = st[url] ? 0 : 1;
      setStore(key, st);
    }

    // ======================
    // Oynatma
    // ======================
    function playIndex(idx){
      const it = items[idx];
      activeIndex = idx;

      $("fpTitle").textContent = it.title;
      $("status").textContent = "";

      // satır seçimi vurgusu
      document.querySelectorAll(".row").forEach(r => r.classList.remove("active"));
      const activeRow = document.querySelector(`.row[data-idx="${idx}"]`);
      if (activeRow) activeRow.classList.add("active");

      // URL set + play
      const audio = $("player");
      audio.src = it.url;

      // iOS autoplay kısıtı: kullanıcı satıra tıklayınca play deniyoruz
      // hata olursa status yazıyoruz
      audio.load();

      try {
        plyr.play().catch(() => {
          $("status").textContent = "Oynatma başlatılamadı. Player’daki ▶︎ tuşuna bas.";
        });
      } catch {
        $("status").textContent = "Oynatma başlatılamadı. Player’daki ▶︎ tuşuna bas.";
      }
    }

    function playNext(delta){
      if (!filteredIdx.length) return;
      if (activeIndex == null){
        playIndex(filteredIdx[0]);
        return;
      }
      const pos = filteredIdx.indexOf(activeIndex);
      const nextPos = (pos + delta + filteredIdx.length) % filteredIdx.length;
      playIndex(filteredIdx[nextPos]);
    }

    // ======================
    // İndirme
    // ======================
    async function downloadFile(url, title){
      // CORS varsa blob ile indir (en iyi)
      // CORS yoksa fallback: yeni sekmede aç (iOS'ta genelde böyle çalışır)
      const cleanName = (title || "audio").replace(/[\\/:*?"<>|]+/g,"_");
      const ext = url.toLowerCase().endsWith(".mp3") ? ".mp3" : ".m4a";
      const filename = cleanName + ext;

      try{
        const res = await fetch(url, { mode: "cors" });
        if (!res.ok) throw new Error("fetch failed");
        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      } catch {
        // fallback
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    }

    // ======================
    // Filtre ikonları (header)
    // ======================
    function setHeaderFilterUI(){
      const like = $("filterLike");
      const fav  = $("filterFav");
      const sel  = $("filterSel");

      like.classList.toggle("filterOn", filter.like);
      fav.classList.toggle("filterOn",  filter.fav);
      sel.classList.toggle("filterOn",  filter.sel);
    }

    function clearFilters(){
      filter.like = false;
      filter.fav = false;
      filter.sel = false;
      renderList();
    }

    // ======================
    // Draggable floating player
    // ======================
    function initDrag(){
      const box = $("floatingPlayer");
      const bar = $("dragBar");

      // restore position
      const pos = safeJson(localStorage.getItem(LS.playerPos), null);
      if (pos && typeof pos.x === "number" && typeof pos.y === "number"){
        box.style.left = pos.x + "px";
        box.style.bottom = "auto";
        box.style.top = pos.y + "px";
      }

      let dragging = false;
      let startX=0, startY=0, startLeft=0, startTop=0;

      const onDown = (e) => {
        // Sadece header üzerinden sürükle
        dragging = true;
        const rect = box.getBoundingClientRect();
        startLeft = rect.left;
        startTop = rect.top;
        startX = (e.touches ? e.touches[0].clientX : e.clientX);
        startY = (e.touches ? e.touches[0].clientY : e.clientY);
        e.preventDefault();
      };

      const onMove = (e) => {
        if (!dragging) return;
        const x = (e.touches ? e.touches[0].clientX : e.clientX);
        const y = (e.touches ? e.touches[0].clientY : e.clientY);
        let nx = startLeft + (x - startX);
        let ny = startTop + (y - startY);

        // clamp
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const rect = box.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        nx = Math.max(8, Math.min(vw - w - 8, nx));
        ny = Math.max(8, Math.min(vh - h - 8, ny));

        box.style.left = nx + "px";
        box.style.top = ny + "px";
        box.style.bottom = "auto";
      };

      const onUp = () => {
        if (!dragging) return;
        dragging = false;
        const rect = box.getBoundingClientRect();
        localStorage.setItem(LS.playerPos, JSON.stringify({x: rect.left, y: rect.top}));
      };

      bar.addEventListener("mousedown", onDown);
      bar.addEventListener("touchstart", onDown, {passive:false});
      window.addEventListener("mousemove", onMove);
      window.addEventListener("touchmove", onMove, {passive:false});
      window.addEventListener("mouseup", onUp);
      window.addEventListener("touchend", onUp);
    }

    // ======================
    // Load items
    // ======================
    async function loadItems(){
      const res = await fetch("./items.json", {cache:"no-store"});
      const data = await res.json();

      // Beklenen format: [{title, url}, ...]
      items = (Array.isArray(data) ? data : [])
        .filter(x => x && x.url && x.title)
        .filter(x => extOk(x.url)) // ✅ m4a + mp3
        .map(x => ({
          title: x.title,
          url: x.url,
          titleLower: String(x.title).toLowerCase()
        }));

      // alfabetik
      items.sort((a,b)=>a.titleLower.localeCompare(b.titleLower, "tr"));

      renderList();
    }

    // ======================
    // Wire up
    // ======================
    (function main(){
      initPlyr();
      initDrag();

      $("q").addEventListener("input", () => renderList());

      $("clearFilters").addEventListener("click", () => {
        clearFilters();
        $("q").focus();
      });

      $("filterLike").addEventListener("click", () => {
        filter.like = !filter.like;
        renderList();
      });
      $("filterFav").addEventListener("click", () => {
        filter.fav = !filter.fav;
        renderList();
      });
      $("filterSel").addEventListener("click", () => {
        filter.sel = !filter.sel;
        renderList();
      });

      $("prevBtn").addEventListener("click", () => playNext(-1));
      $("nextBtn").addEventListener("click", () => playNext(+1));

      loadItems().catch(() => {
        $("meta").textContent = "items.json yüklenemedi.";
      });
    })();
  </script>
</body>
</html>
