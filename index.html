<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfabetik FSP A–Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --border:#e9e9e9;
      --muted:#6b6b6b;
      --bg:#ffffff;
      --hover:#f7f7f7;
      --active:#e8f3ff;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 18px;
      max-width: 980px;
      color:#111;
      background: var(--bg);
    }

    h1{
      font-size: 1.55rem;
      margin: 0 0 12px 0;
      font-weight: 650;
      letter-spacing: .2px;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    #search{
      flex: 1 1 420px;
      min-width: 220px;
      padding: 10px 12px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      font-size: 1rem;
      outline: none;
    }

    .durWrap{
      display:flex;
      gap:10px;
      align-items:center;
      flex: 0 0 auto;
    }

    .durField{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      background: #fff;
    }

    .durField label{
      color: var(--muted);
      font-size: .92rem;
      user-select:none;
      white-space: nowrap;
    }

    .durField input{
      width: 70px;
      padding: 6px 8px;
      border: 1px solid #e1e1e1;
      border-radius: 10px;
      font-size: 1rem;
      outline:none;
    }

    #resetBtn{
      padding: 10px 16px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      background: white;
      cursor: pointer;
      font-size: 1rem;
      flex: 0 0 auto;
    }
    #resetBtn:hover{ background: var(--hover); }

    #meta{
      color: var(--muted);
      font-size: .95rem;
      margin: 6px 0 12px 2px;
    }

    /* HEADER + ROWS */
    .headerRow, .itemRow{
      display: grid;
      grid-template-columns: 1fr 120px 260px; /* Kayıt | Süre | İşlemler */
      align-items: center;
      column-gap: 10px;
    }

    .headerRow{
      padding: 8px 8px;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-size: .92rem;
    }

    .colTitle{ user-select:none; }
    .colDur{ text-align:right; user-select:none; }

    .colActions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      user-select:none;
    }

    .titleHead, .durHead{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .titleHead{ justify-content:flex-start; }
    .durHead{ justify-content:flex-end; }

    .sortBtn{
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#111;
    }
    .sortBtn:hover{ background: var(--hover); }
    .sortBtn svg{ width:16px; height:16px; }
    .sortBtn.on{
      border-color:#2b7cff;
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }

    #list{
      border-bottom: 1px solid var(--border);
    }

    .itemRow{
      padding: 8px 8px;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      background: transparent;
    }
    .itemRow:hover{ background: var(--hover); }
    .itemRow.active{ background: var(--active); }

    .title{
      font-size: 1.02rem;
      font-weight: 500;
      line-height: 1.2;
      min-width: 0;
    }

    .dur{
      text-align:right;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      font-size: .95rem;
      user-select:none;
      white-space: nowrap;
    }

    @media (max-width: 680px){
      body{ margin: 14px; }
      .headerRow, .itemRow{ grid-template-columns: 1fr 92px 210px; }
      .title{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .durWrap{ width: 100%; }
      #search{ flex: 1 1 100%; }
    }

    .actions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
    }

    .iconBtn{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: pointer;
      flex: 0 0 auto;
      user-select:none;
    }
    .iconBtn:hover{ background: var(--hover); }
    .iconBtn.on{
      border-color: #2b7cff;
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }
    .iconBtn svg{ width: 18px; height: 18px; opacity: .9; }

    .filterBtn{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#111;
    }
    .filterBtn:hover{ background: var(--hover); }
    .filterBtn.on{
      border-color:#2b7cff;
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }
    .filterBtn svg{ width:18px; height:18px; }

    /* Floating player */
    #floatingPlayer{
      position: fixed;
      left: 18px;
      bottom: 18px;
      width: min(720px, calc(100vw - 36px));
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      z-index: 9999;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }

    #fpHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      background: #fbfbfb;
      cursor: grab;
      user-select:none;
      gap: 10px;
      touch-action: none;
    }

    #fpTitle{
      font-weight: 600;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1 1 auto;
      min-width: 0;
    }

    #fpHeaderRight{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .miniBtn{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .miniBtn:hover{ background: var(--hover); }
    .miniBtn svg{ width:18px; height:18px; }

    #fpBody{
      padding: 10px 12px 12px 12px;
    }

    #status{
      margin: 8px 2px 0 2px;
      color: var(--muted);
      font-size: .92rem;
    }

    .plyr--audio .plyr__controls{
      border-radius: 12px;
    }
  </style>
</head>

<body>
  <h1>Alfabetik FSP A–Z</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />

    <div class="durWrap" aria-label="Süre filtresi">
      <div class="durField">
        <label for="minDur">Min dk</label>
        <input id="minDur" type="number" min="0" step="1" inputmode="numeric" placeholder="0" />
      </div>
      <div class="durField">
        <label for="maxDur">Max dk</label>
        <input id="maxDur" type="number" min="0" step="1" inputmode="numeric" placeholder="∞" />
      </div>
    </div>

    <button id="resetBtn" type="button">Hepsi</button>
  </div>

  <div id="meta">Görünən: 0 / Toplam: 0</div>

  <div class="headerRow">
    <div class="colTitle">
      <div class="titleHead">
        <span>Kayıt</span>
        <!-- ✅ Tarihe göre sort (dosya sonundaki tarih) -->
        <button id="sortDateBtn" class="sortBtn" type="button" title="Tarihe göre sırala (dosya sonu)">
          <svg id="sortDateIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14"/><path d="M7 14l5 5 5-5"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="colDur">
      <div class="durHead">
        <span>Süre</span>
        <button id="sortDurBtn" class="sortBtn" type="button" title="Süreye göre sırala">
          <svg id="sortDurIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14"/><path d="M7 14l5 5 5-5"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="colActions">
      <button id="filterFav" class="filterBtn" title="Favoriler filtrele" type="button" aria-pressed="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 17.8 5.8 21l1.2-6.8-5-4.9 6.9-1L12 2z"/>
        </svg>
      </button>

      <button id="filterSel" class="filterBtn" title="Seçilenler filtrele" type="button" aria-pressed="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="list"></div>
  <div id="status"></div>

  <div id="floatingPlayer" role="region" aria-label="Oynatıcı">
    <div id="fpHeader" title="Sürükle">
      <div id="fpTitle">Bir kayıt seç...</div>
      <div id="fpHeaderRight">
        <button id="prevBtn" class="miniBtn" type="button" title="Önceki">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 20L9 12l10-8v16z"/><path d="M5 19V5"/>
          </svg>
        </button>
        <button id="nextBtn" class="miniBtn" type="button" title="Sonraki">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 4l10 8-10 8V4z"/><path d="M19 5v14"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="fpBody">
      <audio id="player" class="js-player" controls preload="metadata"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    const BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

    const listEl   = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl   = document.getElementById("meta");
    const statusEl = document.getElementById("status");

    const minDurEl = document.getElementById("minDur");
    const maxDurEl = document.getElementById("maxDur");

    const fp = document.getElementById("floatingPlayer");
    const fpHeader = document.getElementById("fpHeader");
    const fpTitle = document.getElementById("fpTitle");

    const playerEl = document.getElementById("player");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const filterFavBtn  = document.getElementById("filterFav");
    const filterSelBtn  = document.getElementById("filterSel");
    const resetBtn      = document.getElementById("resetBtn");

    const sortDurBtn  = document.getElementById("sortDurBtn");
    const sortDurIcon = document.getElementById("sortDurIcon");
    const sortDateBtn  = document.getElementById("sortDateBtn");
    const sortDateIcon = document.getElementById("sortDateIcon");

    // ✅ Plyr: hız ayarı (settings + speed)
    const plyr = new Plyr(playerEl, {
      seekTime: 5,
      controls: [
        "rewind",
        "play",
        "fast-forward",
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume",
        "settings"
      ],
      settings: ["speed"],
      speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2] }
    });

    const LS = {
      favs:  "fsp.favs.v1",
      sels:  "fsp.sels.v1",
      pos:   "fsp.fp.pos.v1",
      durs:  "fsp.durs.v1",
      sortMode: "fsp.sort.mode.v1",   // "title" | "dur" | "date"
      sortDirDur: "fsp.sort.dur.dir.v1",   // "asc" | "desc"
      sortDirDate: "fsp.sort.date.dir.v1"  // "asc" | "desc"
    };

    const loadMap = (k) => { try { return JSON.parse(localStorage.getItem(k) || "{}"); } catch { return {}; } };
    const saveMap = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    let favs  = loadMap(LS.favs);
    let sels  = loadMap(LS.sels);
    let durs  = loadMap(LS.durs);

    let filterFav  = false;
    let filterSel  = false;

    let items = [];
    let activeId = null;

    // sort state
    let sortMode = localStorage.getItem(LS.sortMode) || "title";  // default: alfabetik
    let durSortDir  = (localStorage.getItem(LS.sortDirDur) === "desc") ? "desc" : "asc";
    let dateSortDir = (localStorage.getItem(LS.sortDirDate) === "desc") ? "desc" : "asc";

    function normTR(s){
      return (s || "").toLocaleLowerCase("tr");
    }

    function guessMime(url){
      try{
        const p = new URL(url).pathname.toLowerCase();
        if (p.endsWith(".mp3")) return "audio/mpeg";
        if (p.endsWith(".m4a")) return "audio/mp4";
      }catch{}
      return "audio/*";
    }

    function urlFor(item){
      if (item.url) return item.url;
      const file = item.file || item.name || item.title || "";
      return new URL(file, BASE).toString();
    }

    function fmtDur(sec){
      if (!Number.isFinite(sec) || sec <= 0) return "—";
      sec = Math.round(sec);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      const mm = String(m).padStart(2, "0");
      const ss = String(s).padStart(2, "0");
      if (h > 0) return `${h}:${mm}:${ss}`;
      return `${m}:${ss}`;
    }

    function parseMinMax(){
      const minV = minDurEl.value.trim();
      const maxV = maxDurEl.value.trim();
      const minMin = minV === "" ? null : Number(minV);
      const maxMin = maxV === "" ? null : Number(maxV);
      const minSec = (Number.isFinite(minMin) && minMin >= 0) ? (minMin * 60) : null;
      const maxSec = (Number.isFinite(maxMin) && maxMin >= 0) ? (maxMin * 60) : null;
      return { minSec, maxSec, active: (minSec !== null || maxSec !== null) };
    }

    // ✅ Başlık sonundan tarih yakala: dd.mm.yy veya dd.mm.yyyy
    // Örn: "... 17.10.24" veya "..._17.10.2024"
    const DATE_RE = /(\d{2})[.\-_](\d{2})[.\-_](\d{2}|\d{4})(?!.*\d)/;

    function parseEndDate(item){
      // önce title, yoksa file
      const s = (item.title || "") + " " + (item.file || "");
      const m = s.match(DATE_RE);
      if (!m) return null;
      const dd = Number(m[1]);
      const mm = Number(m[2]);
      let yy = Number(m[3]);
      if (!Number.isFinite(dd) || !Number.isFinite(mm) || !Number.isFinite(yy)) return null;
      if (yy < 100) yy = 2000 + yy; // 24 -> 2024
      // UTC date
      const t = Date.UTC(yy, mm - 1, dd);
      if (!Number.isFinite(t)) return null;
      return t;
    }

    function setSortIcons(){
      // reset visual
      sortDurBtn.classList.remove("on");
      sortDateBtn.classList.remove("on");

      // helper for arrow
      const arrow = (isAsc) => isAsc
        ? `<path d="M12 5v14"/><path d="M7 14l5 5 5-5"/>`   // aşağı ok
        : `<path d="M12 19V5"/><path d="M7 10l5-5 5 5"/>`; // yukarı ok

      // duration icon (direction stored even if inactive)
      sortDurIcon.innerHTML = arrow(durSortDir === "asc");
      sortDateIcon.innerHTML = arrow(dateSortDir === "asc");

      // active highlight
      if (sortMode === "dur") sortDurBtn.classList.add("on");
      if (sortMode === "date") sortDateBtn.classList.add("on");
    }

    // Toggle duration sort (exclusive)
    sortDurBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sortMode !== "dur"){
        sortMode = "dur";
      } else {
        durSortDir = (durSortDir === "asc") ? "desc" : "asc";
      }
      localStorage.setItem(LS.sortMode, sortMode);
      localStorage.setItem(LS.sortDirDur, durSortDir);
      setSortIcons();
      render();
    });

    // Toggle date sort (exclusive)
    sortDateBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sortMode !== "date"){
        sortMode = "date";
      } else {
        dateSortDir = (dateSortDir === "asc") ? "desc" : "asc";
      }
      localStorage.setItem(LS.sortMode, sortMode);
      localStorage.setItem(LS.sortDirDate, dateSortDir);
      setSortIcons();
      render();
    });

    // --- Duration loader (metadata) ---
    const durQueue = [];
    const durLoading = new Set();
    let durActive = 0;
    const DUR_CONCURRENCY = 2;
    let rerenderTimer = null;

    function scheduleRerender(){
      if (rerenderTimer) return;
      rerenderTimer = setTimeout(() => {
        rerenderTimer = null;
        render();
      }, 120);
    }

    function requestDuration(it){
      const id = it.id;
      if (durs[id] > 0) return;
      if (durLoading.has(id)) return;
      durLoading.add(id);
      durQueue.push(it);
      pumpDurationQueue();
    }

    function pumpDurationQueue(){
      while (durActive < DUR_CONCURRENCY && durQueue.length){
        const it = durQueue.shift();
        durActive++;
        loadDurationFor(it)
          .catch(() => {})
          .finally(() => {
            durActive--;
            pumpDurationQueue();
          });
      }
    }

    function loadDurationFor(it){
      return new Promise((resolve, reject) => {
        const a = new Audio();
        a.preload = "metadata";
        a.src = urlFor(it);

        const cleanup = () => {
          a.removeEventListener("loadedmetadata", onMeta);
          a.removeEventListener("error", onErr);
          a.src = "";
        };

        const onMeta = () => {
          const dur = a.duration;
          cleanup();
          if (Number.isFinite(dur) && dur > 0){
            durs[it.id] = dur;
            saveMap(LS.durs, durs);
            scheduleRerender();
          }
          durLoading.delete(it.id);
          resolve();
        };

        const onErr = () => {
          cleanup();
          durLoading.delete(it.id);
          reject(new Error("metadata error"));
        };

        a.addEventListener("loadedmetadata", onMeta, { once: true });
        a.addEventListener("error", onErr, { once: true });

        setTimeout(() => {
          if (!durs[it.id] && durLoading.has(it.id)){
            durLoading.delete(it.id);
            reject(new Error("timeout"));
          }
        }, 12000);
      });
    }

    async function loadItems(){
      statusEl.textContent = "Yükleniyor...";
      try{
        const res = await fetch(`items.json?v=${Date.now()}`, { cache: "no-store" });
        if(!res.ok) throw new Error("items.json okunamadı");
        const data = await res.json();

        items = (Array.isArray(data) ? data : (data.items || []))
          .filter(x => {
            const f = (x.file || x.name || x.url || "").toLowerCase();
            return f.endsWith(".m4a") || f.endsWith(".mp3");
          })
          .map((x, idx) => {
            const file = x.file || x.name || "";
            const title = x.title || x.name || file || ("Kayıt " + (idx+1));
            const id = x.id || file || title;
            return { id, title, file, url: x.url || null };
          });

        // title sort only used as fallback/default; we keep it stable
        items.sort((a,b) => a.title.localeCompare(b.title, "tr"));
        statusEl.textContent = "";
        render();
      }catch(err){
        console.error(err);
        statusEl.textContent = "items.json yüklenemedi.";
      }
    }

    function getVisibleItems(){
      const q = normTR((searchEl.value || "").trim());
      const { minSec, maxSec, active } = parseMinMax();

      let arr = items.filter(it => {
        if (q && !normTR(it.title).includes(q)) return false;
        if (filterFav && !favs[it.id]) return false;
        if (filterSel && !sels[it.id]) return false;

        if (active){
          const dur = durs[it.id];
          if (!Number.isFinite(dur) || dur <= 0) return false;
          if (minSec !== null && dur < minSec) return false;
          if (maxSec !== null && dur > maxSec) return false;
        }
        return true;
      });

      // ✅ Sorting mode
      if (sortMode === "dur"){
        const dir = (durSortDir === "asc") ? 1 : -1;
        arr.sort((a,b) => {
          const da = (durs[a.id] > 0) ? durs[a.id] : Infinity;
          const db = (durs[b.id] > 0) ? durs[b.id] : Infinity;
          if (da !== db) return (da - db) * dir;
          return a.title.localeCompare(b.title, "tr");
        });
      } else if (sortMode === "date"){
        const dir = (dateSortDir === "asc") ? 1 : -1;
        arr.sort((a,b) => {
          const ta = parseEndDate(a);
          const tb = parseEndDate(b);
          const va = (ta === null) ? Infinity : ta;
          const vb = (tb === null) ? Infinity : tb;
          if (va !== vb) return (va - vb) * dir;
          return a.title.localeCompare(b.title, "tr");
        });
      } else {
        // default: alfabetik
        arr.sort((a,b) => a.title.localeCompare(b.title, "tr"));
      }

      return arr;
    }

    function render(){
      const visible = getVisibleItems();
      metaEl.textContent = `Görünən: ${visible.length} / Toplam: ${items.length}`;

      filterFavBtn.classList.toggle("on", filterFav);
      filterSelBtn.classList.toggle("on", filterSel);

      filterFavBtn.setAttribute("aria-pressed",  String(filterFav));
      filterSelBtn.setAttribute("aria-pressed",  String(filterSel));

      listEl.innerHTML = "";

      // duration measurement
      const { active: durFilterActive } = parseMinMax();
      let toMeasure = visible;

      // Süre filtresi aktifse veya süre sort aktifse, daha agresif ölç
      if (durFilterActive || sortMode === "dur"){
        const q = normTR((searchEl.value || "").trim());
        toMeasure = items.filter(it => {
          if (q && !normTR(it.title).includes(q)) return false;
          if (filterFav && !favs[it.id]) return false;
          if (filterSel && !sels[it.id]) return false;
          return true;
        });
      }

      for (const it of toMeasure){
        if (!(durs[it.id] > 0)) requestDuration(it);
      }

      for (const it of visible){
        const row = document.createElement("div");
        row.className = "itemRow" + (it.id === activeId ? " active" : "");

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;

        const dur = document.createElement("div");
        dur.className = "dur";
        dur.textContent = (durs[it.id] > 0) ? fmtDur(durs[it.id]) : "…";

        const actions = document.createElement("div");
        actions.className = "actions";

        const favBtn = iconButton("star", !!favs[it.id], "Favori");
        const selBtn = iconButton("check", !!sels[it.id], "Seç");
        const dlBtn  = iconButton("download", false, "İndir");

        favBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          favs[it.id] = !favs[it.id];
          saveMap(LS.favs, favs);
          render();
        });

        selBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          sels[it.id] = !sels[it.id];
          saveMap(LS.sels, sels);
          render();
        });

        dlBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const url = urlFor(it);
          const a = document.createElement("a");
          a.href = url;
          a.setAttribute("download", it.file || (it.title + ".audio"));
          a.rel = "noopener";
          document.body.appendChild(a);
          a.click();
          a.remove();
        });

        // iOS pointer bubbling safety
        for (const b of [favBtn, selBtn, dlBtn]){
          b.addEventListener("pointerup", (e) => e.stopPropagation());
          b.addEventListener("pointerdown", (e) => e.stopPropagation());
        }

        actions.appendChild(favBtn);
        actions.appendChild(selBtn);
        actions.appendChild(dlBtn);

        row.appendChild(title);
        row.appendChild(dur);
        row.appendChild(actions);

        row.addEventListener("click", () => playById(it.id));
        listEl.appendChild(row);
      }
    }

    function iconButton(kind, on, title){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "iconBtn" + (on ? " on" : "");
      btn.title = title;

      if (kind === "star"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="${on ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 17.8 5.8 21l1.2-6.8-5-4.9 6.9-1L12 2z"/>
          </svg>`;
      } else if (kind === "check"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"/>
          </svg>`;
      } else if (kind === "download"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v12"/>
            <path d="M7 10l5 5 5-5"/>
            <path d="M5 21h14"/>
          </svg>`;
      }
      return btn;
    }

    // --- Playback ---
    function playById(id){
      const visible = getVisibleItems();
      const idx = visible.findIndex(x => x.id === id);
      if (idx === -1) return;
      playAtVisibleIndex(idx);
    }

    function playAtVisibleIndex(idx){
      const visible = getVisibleItems();
      const it = visible[idx];
      if (!it) return;

      statusEl.textContent = "";
      activeId = it.id;
      fpTitle.textContent = it.title;
      render();

      const url = urlFor(it);
      const mime = guessMime(url);

      plyr.source = {
        type: "audio",
        title: it.title,
        sources: [{ src: url, type: mime }]
      };

      const tryPlay = () => {
        const p = plyr.play();
        if (p && typeof p.catch === "function"){
          p.catch(() => {
            statusEl.textContent = "Oynatma başlatılamadı. Player’daki ▶︎ tuşuna bas.";
          });
        }
      };

      const onCanPlay = () => {
        playerEl.removeEventListener("canplay", onCanPlay);
        setTimeout(tryPlay, 50);
      };

      playerEl.addEventListener("canplay", onCanPlay);

      setTimeout(() => {
        if (playerEl.paused) tryPlay();
      }, 600);
    }

    function playPrev(){
      const visible = getVisibleItems();
      if (!visible.length) return;
      let idx = visible.findIndex(x => x.id === activeId);
      if (idx === -1) idx = 0;
      idx = (idx - 1 + visible.length) % visible.length;
      playAtVisibleIndex(idx);
    }

    function playNext(){
      const visible = getVisibleItems();
      if (!visible.length) return;
      let idx = visible.findIndex(x => x.id === activeId);
      if (idx === -1) idx = 0;
      idx = (idx + 1) % visible.length;
      playAtVisibleIndex(idx);
    }

    prevBtn.addEventListener("click", playPrev);
    nextBtn.addEventListener("click", playNext);

    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      const inTyping = (tag === "input" || tag === "textarea");
      if (inTyping) return;

      if (e.code === "Space"){
        e.preventDefault();
        plyr.togglePlay();
      } else if (e.code === "ArrowLeft"){
        e.preventDefault();
        playPrev();
      } else if (e.code === "ArrowRight"){
        e.preventDefault();
        playNext();
      }
    });

    // Filters
    filterFavBtn.addEventListener("click", () => { filterFav = !filterFav; render(); });
    filterSelBtn.addEventListener("click", () => { filterSel = !filterSel; render(); });

    // ✅ Hepsi: tüm filtre + sıralama kalksın (default alfabetik)
    resetBtn.addEventListener("click", () => {
      filterFav = false;
      filterSel = false;

      searchEl.value = "";
      minDurEl.value = "";
      maxDurEl.value = "";

      sortMode = "title";              // <- sıralamaları kapat
      localStorage.setItem(LS.sortMode, sortMode);

      setSortIcons();
      render();
    });

    searchEl.addEventListener("input", () => render());
    minDurEl.addEventListener("input", () => render());
    maxDurEl.addEventListener("input", () => render());

    // Draggable player
    function restorePlayerPos(){
      try{
        const s = JSON.parse(localStorage.getItem(LS.pos) || "null");
        if (!s) return;
        if (typeof s.x === "number" && typeof s.y === "number"){
          fp.style.left = s.x + "px";
          fp.style.top = s.y + "px";
          fp.style.bottom = "auto";
        }
      }catch{}
    }

    function savePlayerPos(x,y){
      localStorage.setItem(LS.pos, JSON.stringify({x,y}));
    }

    let dragging = false;
    let startX = 0, startY = 0, startLeft = 0, startTop = 0;

    fpHeader.addEventListener("pointerdown", (e) => {
      dragging = true;
      fpHeader.setPointerCapture(e.pointerId);
      fpHeader.style.cursor = "grabbing";

      const rect = fp.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      startLeft = rect.left;
      startTop = rect.top;

      fp.style.left = startLeft + "px";
      fp.style.top = startTop + "px";
      fp.style.bottom = "auto";
    });

    fpHeader.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      const w = fp.offsetWidth;
      const h = fp.offsetHeight;

      const minX = 8;
      const minY = 8;
      const maxX = window.innerWidth - w - 8;
      const maxY = window.innerHeight - h - 8;

      let nx = Math.min(maxX, Math.max(minX, startLeft + dx));
      let ny = Math.min(maxY, Math.max(minY, startTop + dy));

      fp.style.left = nx + "px";
      fp.style.top = ny + "px";
      savePlayerPos(nx, ny);
    });

    fpHeader.addEventListener("pointerup", (e) => {
      dragging = false;
      fpHeader.style.cursor = "grab";
      try{ fpHeader.releasePointerCapture(e.pointerId); }catch{}
    });

    setSortIcons();
    restorePlayerPos();
    loadItems();
  </script>
</body>
</html>
