<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Alfabetik FSP A–Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      max-width: 900px;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.75rem;
    }
    #search {
      width: 100%;
      max-width: 420px;
      padding: 0.45rem 0.6rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    #list {
      border-top: 1px solid #eee;
      margin-bottom: 1rem;
    }
    .item {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    .item:hover { background: #f7f7f7; }
    .item.active { background: #e6f1ff; }
    .title { flex: 1; }
    .badge {
      font-size: 0.75rem;
      color: #666;
      white-space: nowrap;
    }
    #current {
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
      color: #333;
    }
    #status {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.7rem;
      line-height: 1.35;
    }
    #status a { color: inherit; }
  </style>
</head>
<body>

<h1>Alfabetik FSP A–Z</h1>

<input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />

<div id="list"></div>

<div id="current">Yükleniyor…</div>
<div id="status"></div>

<!-- ÖNEMLİ: crossorigin YOK -->
<audio id="player" class="js-player" controls></audio>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
  const BASE =
    "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

  const listEl = document.getElementById("list");
  const searchEl = document.getElementById("search");
  const playerEl = document.getElementById("player");
  const currentEl = document.getElementById("current");
  const statusEl = document.getElementById("status");

  const plyr = new Plyr(playerEl, {
    controls: ["play", "progress", "current-time", "mute", "volume"]
  });

  let items = [];
  let activeIndex = null;

  function urlFor(item) {
    // encodeURI: boşluk/özel karakteri encode eder ama %20 varsa bozmaz
    return encodeURI(BASE + item.file);
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setStatus(text, link) {
    if (link) {
      statusEl.innerHTML = `${escapeHtml(text)} <a href="${link}" target="_blank" rel="noreferrer">(dosyayı yeni sekmede aç)</a>`;
    } else {
      statusEl.textContent = text || "";
    }
  }

  function renderList(q = "") {
    q = q.toLowerCase();
    listEl.innerHTML = "";
    let shown = 0;

    items.forEach((item, index) => {
      if (!item.title.toLowerCase().includes(q)) return;
      shown++;

      const row = document.createElement("div");
      row.className = "item";
      if (index === activeIndex) row.classList.add("active");
      row.dataset.index = index;

      row.innerHTML = `
        <span class="title">${escapeHtml(item.title)}</span>
        <span class="badge">${escapeHtml(item.info || "")}</span>
      `;
      listEl.appendChild(row);
    });

    if (!shown) {
      listEl.innerHTML = "<div style='padding:0.75rem;color:#666'>Sonuç yok.</div>";
    }
  }

  function playIndex(index) {
    const item = items[index];
    if (!item) return;

    activeIndex = index;

    const src = urlFor(item);
    playerEl.src = src;

    currentEl.textContent = "Şu an: " + item.title;
    setStatus("Yükleniyor…", src);
    renderList(searchEl.value);

    plyr.play().catch(() => {
      // Kullanıcı etkileşimi zaten var ama bazı tarayıcılar yine de kapris yapabiliyor.
      setStatus("Oynatma tarayıcı tarafından engellendi. Play tuşuna tekrar bas.", src);
    });
  }

  async function loadItems() {
    try {
      const res = await fetch("./items.json", { cache: "no-store" });
      if (!res.ok) throw new Error("items.json yüklenemedi");

      const data = await res.json();
      items = (Array.isArray(data) ? data : [])
        .filter(x => x && x.title && x.file)
        .map(x => ({ title: String(x.title), file: String(x.file), info: x.info ? String(x.info) : "" }));

      items.sort((a, b) => a.title.localeCompare(b.title, "de"));

      currentEl.textContent = `Toplam kayıt: ${items.length}`;
      setStatus("Bir kayıt seç.", "");
      renderList();
    } catch (e) {
      console.error(e);
      currentEl.textContent = "Kayıtlar yüklenemedi.";
      setStatus("items.json bulunamadı veya bozuk.", "");
    }
  }

  // Medya olayları: yükleniyor mu, hata mı var net gösterelim
  playerEl.addEventListener("loadstart", () => setStatus("Yükleniyor…", playerEl.src));
  playerEl.addEventListener("canplay", () => setStatus("Hazır. Oynatılıyor…", playerEl.src));
  playerEl.addEventListener("playing", () => setStatus("Oynatılıyor…", playerEl.src));
  playerEl.addEventListener("pause", () => setStatus("Duraklatıldı.", playerEl.src));

  playerEl.addEventListener("error", () => {
    const err = playerEl.error;
    const code = err ? err.code : 0;

    // 2 = network error / 3 = decode error / 4 = src not supported
    const msg =
      code === 2 ? "Ağ hatası (dosyaya erişilemiyor)." :
      code === 3 ? "Decode hatası (dosya okunamıyor)." :
      code === 4 ? "Format desteklenmiyor veya link yanlış." :
      "Bilinmeyen hata.";

    setStatus("Hata: " + msg, playerEl.src);
  });

  listEl.addEventListener("click", e => {
    const row = e.target.closest(".item");
    if (!row) return;
    playIndex(Number(row.dataset.index));
  });

  searchEl.addEventListener("input", () => renderList(searchEl.value));

  document.addEventListener("keydown", e => {
    const q = searchEl.value.toLowerCase();
    const filtered = items
      .map((item, index) => ({ item, index }))
      .filter(({ item }) => item.title.toLowerCase().includes(q));

    if (!filtered.length) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      const pos = filtered.findIndex(f => f.index === activeIndex);
      playIndex(filtered[(pos + 1) % filtered.length].index);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      const pos = filtered.findIndex(f => f.index === activeIndex);
      playIndex(filtered[(pos - 1 + filtered.length) % filtered.length].index);
    } else if (e.key === "Enter" && activeIndex === null) {
      playIndex(filtered[0].index);
    }
  });

  loadItems();
</script>

</body>
</html>
