<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Alfabetik FSP Aâ€“Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      max-width: 900px;
    }
    h1 { font-size: 1.4rem; margin-bottom: 0.75rem; }
    #search {
      width: 100%;
      max-width: 420px;
      padding: 0.45rem 0.6rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    #list { border-top: 1px solid #eee; margin-bottom: 1rem; }
    .item {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    .item:hover { background: #f7f7f7; }
    .item.active { background: #e6f1ff; }
    .title { flex: 1; }
    .badge { font-size: 0.75rem; color: #666; white-space: nowrap; }

    #current { font-size: 0.9rem; margin-bottom: 0.2rem; color: #222; }
    #status  { font-size: 0.85rem; color: #666; margin-bottom: 0.6rem; line-height: 1.35; }
    #status a { color: inherit; text-decoration: underline; }
  </style>
</head>
<body>

<h1>Alfabetik FSP Aâ€“Z</h1>

<input id="search" type="text" placeholder="Arama (Ã¶r. ACS, DM, PAVK)..." />

<div id="list"></div>

<div id="current">YÃ¼kleniyorâ€¦</div>
<div id="status"></div>

<audio id="player" class="js-player" controls preload="auto"></audio>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
  // Archive item identifier (deÄŸiÅŸtirme)
  const IDENT = "vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25";

  // Download base (deÄŸiÅŸtirme)
  const BASE = `https://archive.org/download/${IDENT}/`;

  const listEl = document.getElementById("list");
  const searchEl = document.getElementById("search");
  const playerEl = document.getElementById("player");
  const currentEl = document.getElementById("current");
  const statusEl = document.getElementById("status");

  // Plyr sadece arayÃ¼z
  new Plyr(playerEl, {
  seekTime: 5, // <- 5 sn atlama
  controls: [
    "rewind",      // <- -5 sn
    "play",
    "fast-forward",// <- +5 sn
    "progress",
    "current-time",
    "duration",
    "mute",
    "volume"
  ]
});


  let items = [];
  let activeIndex = null;

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setStatus(text, link) {
    if (link) {
      statusEl.innerHTML =
        `${escapeHtml(text)} â€” <a href="${link}" target="_blank" rel="noreferrer">dosyayÄ± yeni sekmede aÃ§</a>`;
    } else {
      statusEl.textContent = text || "";
    }
  }

  function titleFromFilename(name) {
    // sadece gÃ¶rÃ¼ntÃ¼ iÃ§in
    return name.replace(/\.(m4a|mp3)$/i, "").replaceAll("_", " ").trim();
  }

  function fileUrl(fileName) {
    // ðŸ”¥ en Ã¶nemli kÄ±sÄ±m: URL() doÄŸru encode eder, case'i bozmaz
    return new URL(fileName, BASE).href;
  }

  function renderList(q = "") {
    q = q.toLowerCase();
    listEl.innerHTML = "";
    let shown = 0;

    items.forEach((item, index) => {
      if (!item.title.toLowerCase().includes(q)) return;
      shown++;

      const row = document.createElement("div");
      row.className = "item";
      if (index === activeIndex) row.classList.add("active");
      row.dataset.index = index;

      row.innerHTML = `
        <span class="title">${escapeHtml(item.title)}</span>
        <span class="badge">${escapeHtml(item.info || "")}</span>
      `;
      listEl.appendChild(row);
    });

    if (!shown) {
      listEl.innerHTML = "<div style='padding:0.75rem;color:#666'>SonuÃ§ yok.</div>";
    }
  }

  async function playIndex(index) {
    const item = items[index];
    if (!item) return;

    activeIndex = index;

    const src = fileUrl(item.file);

    currentEl.textContent = "Åžu an: " + item.title;
    setStatus("YÃ¼kleniyorâ€¦", src);
    renderList(searchEl.value);

    try { playerEl.pause(); } catch {}
    playerEl.src = src;
    playerEl.load();

    try {
      await playerEl.play();
      // playing event gÃ¼nceller
    } catch {
      setStatus("Oynatma baÅŸlatÄ±lamadÄ±. Play tuÅŸuna bas veya linki yeni sekmede aÃ§Ä±p test et.", src);
    }
  }

  // Media eventleri
  playerEl.addEventListener("playing", () => {
    setStatus("OynatÄ±lÄ±yorâ€¦", playerEl.currentSrc || playerEl.src);
  });
  playerEl.addEventListener("pause", () => {
    // gerÃ§ek duraklama olursa gÃ¶ster
    if (playerEl.currentTime > 0 && !playerEl.ended) {
      setStatus("DuraklatÄ±ldÄ±.", playerEl.currentSrc || playerEl.src);
    }
  });
  playerEl.addEventListener("error", () => {
    const err = playerEl.error;
    const code = err ? err.code : 0;
    const src = playerEl.currentSrc || playerEl.src;

    const msg =
      code === 2 ? "AÄŸ hatasÄ± (link/eriÅŸim sorunu)" :
      code === 3 ? "Decode hatasÄ± (codec desteklenmiyor olabilir)" :
      code === 4 ? "Format desteklenmiyor veya link yanlÄ±ÅŸ" :
      "Bilinmeyen hata";

    setStatus("Hata: " + msg, src);
  });

  // Liste tÄ±klama
  listEl.addEventListener("click", e => {
    const row = e.target.closest(".item");
    if (!row) return;
    playIndex(Number(row.dataset.index));
  });

  // Arama
  searchEl.addEventListener("input", () => renderList(searchEl.value));

  // Klavye gezinme
  document.addEventListener("keydown", e => {
    const q = searchEl.value.toLowerCase();
    const filtered = items
      .map((item, index) => ({ item, index }))
      .filter(({ item }) => item.title.toLowerCase().includes(q));
    if (!filtered.length) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      const pos = filtered.findIndex(f => f.index === activeIndex);
      playIndex(filtered[(pos + 1) % filtered.length].index);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      const pos = filtered.findIndex(f => f.index === activeIndex);
      playIndex(filtered[(pos - 1 + filtered.length) % filtered.length].index);
    } else if (e.key === "Enter" && activeIndex === null) {
      playIndex(filtered[0].index);
    }
  });

  // âœ… items.json yok: direkt Archive metadataâ€™dan Ã§ek
  async function loadFromArchive() {
    try {
      currentEl.textContent = "KayÄ±tlar yÃ¼kleniyorâ€¦";
      setStatus("Archive.orgâ€™dan liste alÄ±nÄ±yorâ€¦", "");

      const metaUrl = `https://archive.org/metadata/${IDENT}`;
      const res = await fetch(metaUrl, { cache: "no-store" });
      if (!res.ok) throw new Error("metadata alÄ±namadÄ±");

      const meta = await res.json();
      const files = Array.isArray(meta.files) ? meta.files : [];

      items = files
        .map(f => (typeof f === "object" ? f.name : null))
        .filter(name => name && String(name).toLowerCase().endsWith(".m4a"))
        .map(name => ({
          file: String(name),                // ðŸ”¥ gerÃ§ek dosya adÄ± (case doÄŸru!)
          title: titleFromFilename(String(name)),
          info: ""
        }))
        .sort((a, b) => a.title.localeCompare(b.title, "de"));

      currentEl.textContent = `Toplam kayÄ±t: ${items.length}`;
      setStatus("Bir kayÄ±t seÃ§.", "");
      renderList();

    } catch (e) {
      console.error(e);
      currentEl.textContent = "Liste yÃ¼klenemedi.";
      setStatus("Archive.org metadata eriÅŸimi baÅŸarÄ±sÄ±z. (AÄŸ / CORS / geÃ§ici sorun olabilir)", "");
    }
  }

  loadFromArchive();
</script>

</body>
</html>
