<script>
/****************************************************************
 * 1) BUNU ACTION'DAKİYLE AYNI TUT
 ****************************************************************/
const ARCHIVE_IDENTIFIER = "vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25";

/****************************************************************
 * 2) items.json için fallback path'ler
 * - Pages root yayınlıyorsa: ./items.json
 * - Pages docs yayınlıyorsa: ./items.json (docs içinde olacağı için yine çalışır)
 * - bazı durumlarda sayfa root, dosya docs: ./docs/items.json
 ****************************************************************/
const ITEMS_JSON_CANDIDATES = [
  "./items.json",
  "./docs/items.json"
];

const ARCHIVE_BASE = `https://archive.org/download/${ARCHIVE_IDENTIFIER}/`;

// ---- DOM ----
const rowsEl = document.getElementById("rows");
const metaEl = document.getElementById("meta");
const searchEl = document.getElementById("search");
const resetBtn = document.getElementById("resetBtn");

const filterLikeBtn = document.getElementById("filterLike");
const filterFavBtn  = document.getElementById("filterFav");
const filterSelBtn  = document.getElementById("filterSel");

const fpTitle = document.getElementById("fpTitle");
const fpMsg   = document.getElementById("fpMsg");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const audio   = document.getElementById("player");

const plyr = new Plyr(audio, {
  controls: ["rewind","play","fast-forward","progress","current-time","duration","mute","volume","settings"],
  seekTime: 5,
  settings: ["speed"],
  speed: { selected: 1.0, options: [0.8,0.9,1.0,1.1,1.2] }
});

// ---- state (localStorage) ----
const LS_KEY = "fsp_audio_state_v1";
const defaultState = { likes:{}, favs:{}, sels:{}, likeCounts:{} };
const state = (() => {
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultState);
    const s = JSON.parse(raw);
    return { ...structuredClone(defaultState), ...s };
  }catch(e){
    return structuredClone(defaultState);
  }
})();
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

// ---- data ----
let allItems = [];
let viewItems = [];
let activeIndex = -1;
let filterMode = null; // "like" | "fav" | "sel" | null

function buildUrl(file){
  const enc = encodeURIComponent(file).replace(/%2F/g, "/");
  return ARCHIVE_BASE + enc;
}
function isPlayable(file){
  const f = (file || "").toLowerCase();
  return f.endsWith(".m4a") || f.endsWith(".mp3");
}

function setMeta(){
  metaEl.textContent = `Görünen: ${viewItems.length} / Toplam: ${allItems.length}`;
}
function showMsg(text){
  fpMsg.style.display = "block";
  fpMsg.textContent = text;
}
function clearMsg(){
  fpMsg.style.display = "none";
  fpMsg.textContent = "";
}
function iconBtn(on, extraClass){
  return `iconBtn ${on ? "on "+extraClass : ""}`.trim();
}

function render(){
  const q = (searchEl.value || "").trim().toLowerCase();

  viewItems = allItems.filter((it) => {
    if(!it || !it.title) return false;
    if(q && !it.title.toLowerCase().includes(q)) return false;

    if(filterMode === "like") return !!state.likes[it.file];
    if(filterMode === "fav")  return !!state.favs[it.file];
    if(filterMode === "sel")  return !!state.sels[it.file];
    return true;
  });

  setMeta();

  filterLikeBtn.className = "iconBtn" + (filterMode==="like" ? " on like" : "");
  filterFavBtn.className  = "iconBtn" + (filterMode==="fav"  ? " on fav"  : "");
  filterSelBtn.className  = "iconBtn" + (filterMode==="sel"  ? " on sel"  : "");

  rowsEl.innerHTML = "";

  viewItems.forEach((it, idx) => {
    const row = document.createElement("div");
    row.className = "row grid" + (idx === activeIndex ? " active" : "");

    const likeCount = Number(state.likeCounts[it.file] || 0);

    const t = document.createElement("div");
    t.className = "title";
    t.textContent = it.title;

    const lc = document.createElement("div");
    lc.className = "likeCount";
    lc.textContent = String(likeCount);

    const like = document.createElement("div");
    like.className = iconBtn(!!state.likes[it.file], "like");
    like.title = "Like";
    like.innerHTML = `
      <svg class="ic" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 21s-7-4.6-9.5-8.5C.6 9.4 2.4 6.5 5.7 6.5c1.7 0 3.2.9 4.1 2.2.9-1.3 2.4-2.2 4.1-2.2 3.3 0 5.1 2.9 3.2 6.0C19 16.4 12 21 12 21z"/>
      </svg>
    `;

    const fav = document.createElement("div");
    fav.className = iconBtn(!!state.favs[it.file], "fav");
    fav.title = "Favori";
    fav.innerHTML = `
      <svg class="ic" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 17.3l-6.2 3.5 1.7-7.0L2 9.2l7.2-.6L12 2l2.8 6.6 7.2.6-5.5 4.6 1.7 7z"/>
      </svg>
    `;

    const sel = document.createElement("div");
    sel.className = iconBtn(!!state.sels[it.file], "sel");
    sel.title = "Seç";
    sel.innerHTML = `
      <svg class="ic" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20 6L9 17l-5-5"/>
      </svg>
    `;

    const dl = document.createElement("div");
    dl.className = "iconBtn download";
    dl.title = "İndir";
    dl.innerHTML = `
      <svg class="ic" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 3v12"/><path d="M7 10l5 5 5-5"/><path d="M5 21h14"/>
      </svg>
    `;

    row.addEventListener("click", (e) => {
      if(e.target.closest(".iconBtn")) return;
      playIndex(idx, true);
    });

    like.addEventListener("click", (e) => {
      e.stopPropagation();
      const key = it.file;
      const now = !state.likes[key];
      state.likes[key] = now;
      const cur = Number(state.likeCounts[key] || 0);
      state.likeCounts[key] = Math.max(0, cur + (now ? 1 : -1));
      saveState();
      render();
    });

    fav.addEventListener("click", (e) => {
      e.stopPropagation();
      const key = it.file;
      state.favs[key] = !state.favs[key];
      saveState();
      render();
    });

    sel.addEventListener("click", (e) => {
      e.stopPropagation();
      const key = it.file;
      state.sels[key] = !state.sels[key];
      saveState();
      render();
    });

    dl.addEventListener("click", async (e) => {
      e.stopPropagation();
      const url = buildUrl(it.file);
      try{
        const resp = await fetch(url, { mode:"cors" });
        if(!resp.ok) throw new Error("download http " + resp.status);
        const blob = await resp.blob();
        const a = document.createElement("a");
        const objUrl = URL.createObjectURL(blob);
        a.href = objUrl;
        a.download = it.file;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(objUrl);
      }catch(err){
        window.open(url, "_blank", "noopener,noreferrer");
      }
    });

    // ✅ 6 kolon: title + likeCount + like + fav + sel + download
    row.appendChild(t);
    row.appendChild(lc);
    row.appendChild(like);
    row.appendChild(fav);
    row.appendChild(sel);
    row.appendChild(dl);

    rowsEl.appendChild(row);
  });
}

async function playIndex(idx, userInitiated){
  if(idx < 0 || idx >= viewItems.length) return;
  activeIndex = idx;
  const it = viewItems[idx];

  clearMsg();

  if(!isPlayable(it.file)){
    showMsg("Uygun .m4a/.mp3 değil.");
    render();
    return;
  }

  fpTitle.textContent = it.title;
  audio.src = buildUrl(it.file);
  audio.load();
  render();

  if(userInitiated){
    try{ await plyr.play(); clearMsg(); }
    catch(e){ showMsg("Oynatma başlatılamadı. Player’daki ▶ tuşuna bas."); }
  }else{
    showMsg("Player’daki ▶ tuşuna bas.");
  }
}

prevBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  if(viewItems.length === 0) return;
  const next = (activeIndex <= 0) ? (viewItems.length - 1) : (activeIndex - 1);
  playIndex(next, true);
});

nextBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  if(viewItems.length === 0) return;
  const next = (activeIndex >= viewItems.length - 1) ? 0 : (activeIndex + 1);
  playIndex(next, true);
});

document.addEventListener("keydown", (e) => {
  if(e.code !== "Space") return;
  const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
  if(tag === "input" || tag === "textarea") return;
  e.preventDefault();
  plyr.togglePlay();
});

function setFilter(mode){
  filterMode = (filterMode === mode) ? null : mode;
  activeIndex = -1;
  render();
}

filterLikeBtn.addEventListener("click", () => setFilter("like"));
filterFavBtn.addEventListener("click", () => setFilter("fav"));
filterSelBtn.addEventListener("click", () => setFilter("sel"));

resetBtn.addEventListener("click", () => {
  filterMode = null;
  searchEl.value = "";
  activeIndex = -1;
  render();
});

searchEl.addEventListener("input", () => {
  activeIndex = -1;
  render();
});

/* ✅ items.json yükleme: fallback + ekranda hata göster */
async function loadItems(){
  metaEl.textContent = "Yükleniyor…";

  let lastErr = null;

  for(const path of ITEMS_JSON_CANDIDATES){
    try{
      const r = await fetch(path, { cache: "no-store" });
      if(!r.ok) throw new Error(`${path} HTTP ${r.status}`);
      const data = await r.json();
      if(!Array.isArray(data)) throw new Error(`${path} JSON array değil`);

      allItems = data
        .filter(x => x && x.title && x.file && isPlayable(x.file))
        .sort((a,b) => a.title.localeCompare(b.title, "tr"));

      render();

      if(allItems.length === 0){
        metaEl.textContent = `items.json yüklendi (${path}) ama uygun .m4a/.mp3 yok.`;
      }
      return; // ✅ başarı
    }catch(e){
      lastErr = e;
    }
  }

  metaEl.textContent = "items.json okunamadı: " + (lastErr ? lastErr.message : "bilinmeyen hata");
}

loadItems();
</script>
