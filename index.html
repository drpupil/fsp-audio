<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfabetik FSP A–Z</title>

  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#666;
      --line:#eee;
      --chip:#f6f6f6;
      --chipBorder:#e5e5e5;
      --active:#e5f2ff;
      --btn:#ffffff;
      --btnBorder:#dcdcdc;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 12px;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 18px;
      max-width: 1100px;
      color: var(--text);
      background: var(--bg);
      font-weight: 400; /* bold yok */
    }

    h1{
      font-size: 1.5rem;
      margin: 0 0 12px 0;
      font-weight: 600; /* başlık hariç */
    }

    /* Controls row */
    .topbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      margin-bottom: 10px;
    }

    #search{
      flex: 1 1 320px;
      padding: 10px 12px;
      border: 1px solid #cfcfcf;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      font-weight: 400;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 9px 12px;
      border: 1px solid var(--chipBorder);
      background: var(--chip);
      border-radius: 10px;
      cursor:pointer;
      user-select:none;
      font-size: .95rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .chip:active{ transform: translateY(1px); }

    .chip select{
      border: none;
      background: transparent;
      font-size: .95rem;
      outline:none;
      cursor:pointer;
      font-weight: 500;
    }

    #meta{
      margin: 8px 0 10px 2px;
      font-size: .95rem;
      color: var(--muted);
      font-weight: 400;
    }

    /* List */
    #list{
      border-top: 1px solid var(--line);
      margin-bottom: 110px; /* floating player yer aç */
    }

    .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 6px;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      font-size: 1.02rem;
      font-weight: 400; /* bold yok */
    }
    .row:hover{ background:#fafafa; }
    .row.active{ background: var(--active); }

    .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }
    .title{
      flex: 1;
      min-width: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 400; /* bold yok */
    }

    .right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .badge{
      font-size: .9rem;
      color: #555;
      min-width: 56px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight: 400; /* bold yok */
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--btnBorder);
      background: var(--btn);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      padding:0;
    }
    .iconBtn:active{ transform: translateY(1px); }

    /* Selected */
    .iconBtn.select{
      border-width: 2px;
    }
    .iconBtn.select::before{
      content:"✓";
      font-size: 16px;
      color:#9aa0a6;
      transform: translateY(-0.5px);
    }
    .iconBtn.select.active{
      border-color:#2563eb;
      background:#2563eb;
    }
    .iconBtn.select.active::before{
      color:#fff;
    }

    /* Favorite */
    .iconBtn.star{
      border-width: 2px;
    }
    .iconBtn.star::before{
      content:"☆";
      font-size: 16px;
      color:#777;
      transform: translateY(-0.5px);
    }
    .iconBtn.star.active{
      border-color:#f59e0b;
      background:#fff7ed;
    }
    .iconBtn.star.active::before{
      content:"★";
      color:#f59e0b;
    }

    /* Like + counter */
    .likeCount{
      font-size: 0.85rem;
      color:#444;
      min-width: 22px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight: 400;
    }
    .iconBtn.like{
      border-width: 2px;
    }
    .iconBtn.like::before{
      content:"♡";
      font-size: 15px;
      color:#777;
      transform: translateY(-0.5px);
    }
    .iconBtn.like.active{
      border-color:#f43f5e;
      background:#fff0f3;
    }
    .iconBtn.like.active::before{
      content:"♥";
      color:#e11d48;
    }

    /* Download */
    .iconBtn.dl::before{
      content:"⤓";
      font-size: 16px;
      color:#111;
      transform: translateY(-0.5px);
    }

    /* Floating player */
    #floatingPlayer{
      position: fixed;
      left: 18px;
      bottom: 18px;
      width: min(520px, calc(100vw - 36px));
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 9999;
      overflow:hidden;
    }

    #fpHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid #efefef;
      cursor: grab;
      user-select:none;
      background: #fafafa;
    }
    #fpHeader:active{ cursor: grabbing; }

    #fpTitle{
      font-size: .95rem;
      color:#222;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
      flex: 1;
      min-width:0;
    }
    #fpHint{
      font-size: .8rem;
      color:#888;
      font-weight: 400;
      white-space:nowrap;
    }

    #fpBody{
      padding: 10px 12px 12px 12px;
    }

    #status{
      font-size: .9rem;
      color:#666;
      margin: 0 0 8px 2px;
      font-weight: 400;
    }

    /* Plyr */
    .plyr{
      border-radius: 10px;
    }

    @media (max-width: 520px){
      .badge{ min-width: 48px; }
      .iconBtn{ width: 32px; height: 32px; }
    }
  </style>
</head>

<body>
  <h1>Alfabetik FSP A–Z</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />

    <div class="chip" title="Filtre">
      <span>Filtre:</span>
      <select id="filterMode">
        <option value="all">Hepsi</option>
        <option value="fav">Sadece favoriler</option>
        <option value="liked">Sadece liked</option>
        <option value="smart">Favori + Liked (akıllı)</option>
      </select>
    </div>

    <div class="chip" title="Sıralama">
      <span>Sırala:</span>
      <select id="sortMode">
        <option value="az">A → Z</option>
        <option value="za">Z → A</option>
        <option value="likes">En çok beğenilen</option>
      </select>
    </div>

    <div class="chip" id="clearSelectionBtn" title="Seçimi temizle">Seçimi temizle</div>
  </div>

  <div id="meta">Yükleniyor…</div>

  <div id="list"></div>

  <!-- Floating player -->
  <div id="floatingPlayer" aria-label="Audio player">
    <div id="fpHeader">
      <div id="fpTitle">Seçili kayıt yok</div>
      <div id="fpHint">Sürükle</div>
    </div>
    <div id="fpBody">
      <div id="status"></div>
      <audio id="player" class="js-player" controls preload="auto"></audio>
    </div>
  </div>

  <!-- Plyr JS -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // === AYAR: Archive.org koleksiyon URL'i (download klasörü) ===
    const BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

    // === LocalStorage keys ===
    const LS_FAVS = "favs_v1";        // [file]
    const LS_SELECTED = "selected_v1";// [file]
    const LS_LIKES = "likes_count_v1";// { file: number }

    // === State ===
    let items = [];         // loaded from items.json
    let favs = new Set();
    let selected = new Set();
    let likesCount = {};    // map: file -> number
    let activeFile = null;

    // === Elements ===
    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl = document.getElementById("meta");
    const filterEl = document.getElementById("filterMode");
    const sortEl = document.getElementById("sortMode");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");

    const fp = document.getElementById("floatingPlayer");
    const fpHeader = document.getElementById("fpHeader");
    const fpTitle = document.getElementById("fpTitle");
    const statusEl = document.getElementById("status");

    const audioEl = document.getElementById("player");

    // Plyr: 5 sn geri/ileri
    const plyr = new Plyr(audioEl, {
      seekTime: 5,
      controls: [
        "rewind",       // -5 sn
        "play",
        "fast-forward", // +5 sn
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume"
      ]
    });

    // === Helpers ===
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fileUrl(file){
      // dosya adlarında boşluk/özel karakter olabiliyor -> encode
      const encoded = encodeURIComponent(file).replace(/%2F/g, "/");
      return BASE + encoded;
    }

    function downloadUrl(file){
      // Bazı tarayıcılar cross-origin "download" attribute'u yok sayar.
      // Yine de ?download=1 çoğu yerde indirmeyi tetikleyebiliyor.
      return fileUrl(file) + "?download=1";
    }

    function loadFavs(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_FAVS) || "[]");
        favs = new Set(Array.isArray(arr) ? arr : []);
      } catch { favs = new Set(); }
    }
    function saveFavs(){
      localStorage.setItem(LS_FAVS, JSON.stringify([...favs]));
    }

    function loadSelected(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_SELECTED) || "[]");
        selected = new Set(Array.isArray(arr) ? arr : []);
      } catch { selected = new Set(); }
    }
    function saveSelected(){
      localStorage.setItem(LS_SELECTED, JSON.stringify([...selected]));
    }

    function loadLikes(){
      try{
        likesCount = JSON.parse(localStorage.getItem(LS_LIKES) || "{}") || {};
      } catch { likesCount = {}; }
    }
    function saveLikes(){
      localStorage.setItem(LS_LIKES, JSON.stringify(likesCount));
    }
    function getLikeCount(file){
      return Number(likesCount[file] || 0);
    }

    function updateMetaLine(viewCount){
      metaEl.textContent =
        `Toplam: ${items.length}  •  Görünen: ${viewCount}  •  Favori: ${favs.size}  •  Seçili: ${selected.size}`;
    }

    function buildView(){
      const q = searchEl.value.trim().toLowerCase();
      const mode = filterEl.value; // all / fav / liked / smart
      const sortMode = sortEl.value; // az / za / likes

      // filter
      let view = items.filter(it => {
        const matchQ = !q || (it.title || "").toLowerCase().includes(q);
        if (!matchQ) return false;

        const isFav = favs.has(it.file);
        const likeN = getLikeCount(it.file);
        const isLiked = likeN > 0;

        if (mode === "fav") return isFav;
        if (mode === "liked") return isLiked;
        if (mode === "smart") return (isFav || isLiked);
        return true;
      });

      // sort
      if (sortMode === "likes"){
        view.sort((a,b) => {
          const la = getLikeCount(a.file);
          const lb = getLikeCount(b.file);
          if (lb !== la) return lb - la; // desc
          return String(a.title).localeCompare(String(b.title), "tr");
        });
      } else if (sortMode === "za"){
        view.sort((a,b) => String(b.title).localeCompare(String(a.title), "tr"));
      } else {
        view.sort((a,b) => String(a.title).localeCompare(String(b.title), "tr"));
      }

      return view;
    }

    function renderList(){
      const view = buildView();
      listEl.innerHTML = "";

      for (const it of view){
        const isActive = (it.file === activeFile);
        const isFav = favs.has(it.file);
        const isSel = selected.has(it.file);

        const likeN = getLikeCount(it.file);
        const isLiked = likeN > 0;

        const row = document.createElement("div");
        row.className = "row" + (isActive ? " active" : "");
        row.dataset.file = it.file;

        row.innerHTML = `
          <div class="left">
            <div class="title" data-action="play" title="${escapeHtml(it.title)}">
              ${escapeHtml(it.title)}
            </div>
          </div>

          <div class="right">
            <div class="badge" title="Süre">${escapeHtml(it.info || "")}</div>

            <div class="actions">
              <div class="likeCount" title="Like">${likeN}</div>
              <button class="iconBtn like ${isLiked ? "active" : ""}" data-action="like" title="Like"></button>

              <button class="iconBtn select ${isSel ? "active" : ""}" data-action="select" title="Seç"></button>
              <button class="iconBtn star ${isFav ? "active" : ""}" data-action="fav" title="Favori"></button>
              <button class="iconBtn dl" data-action="dl" title="İndir"></button>
            </div>
          </div>
        `;

        listEl.appendChild(row);
      }

      updateMetaLine(view.length);
    }

    function setStatus(msg){
      statusEl.textContent = msg || "";
    }

    async function playFile(file, title){
      activeFile = file;
      fpTitle.textContent = title || "Seçili kayıt";
      setStatus("Yükleniyor…");

      audioEl.src = fileUrl(file);

      // Plyr bazen eski state yüzünden duruyor; load + play zorlayalım
      try{
        audioEl.load();
      } catch {}

      try{
        await plyr.play();
        setStatus("");
      } catch (e){
        // Autoplay / gesture / network vs.
        setStatus("Oynatma başlatılamadı. Play tuşuna bas.");
      }

      renderList();
    }

    function triggerDownload(file){
      const url = downloadUrl(file);

      // Cross-origin: download attribute bazı tarayıcılarda yok sayılabilir.
      // Yine de çoğu durumda indirir; olmazsa yeni sekme açılır.
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.download = file; // cross-origin ise tarayıcı yok sayabilir
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // === Events ===
    listEl.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      const row = e.target.closest(".row");
      if (!row) return;

      const file = row.dataset.file;
      const item = items.find(x => x.file === file);
      if (!item) return;

      // Play (title click)
      if (!btn){
        // satırın boş yerinden tık -> play
        playFile(item.file, item.title);
        return;
      }

      const action = btn.dataset.action;

      if (action === "play"){
        playFile(item.file, item.title);
        return;
      }

      if (action === "fav"){
        if (favs.has(file)) favs.delete(file);
        else favs.add(file);
        saveFavs();
        renderList();
        return;
      }

      if (action === "select"){
        if (selected.has(file)) selected.delete(file);
        else selected.add(file);
        saveSelected();
        renderList();
        return;
      }

      if (action === "like"){
        const cur = getLikeCount(file);
        likesCount[file] = (cur > 0) ? 0 : 1; // toggle (istersen +1 yaparız)
        saveLikes();
        renderList();
        return;
      }

      if (action === "dl"){
        triggerDownload(file);
        return;
      }
    });

    searchEl.addEventListener("input", renderList);
    filterEl.addEventListener("change", renderList);
    sortEl.addEventListener("change", renderList);

    clearSelectionBtn.addEventListener("click", () => {
      selected.clear();
      saveSelected();
      renderList();
    });

    // === Floating drag ===
    (function makeDraggable(){
      let dragging = false;
      let startX = 0, startY = 0;
      let startLeft = 0, startTop = 0;

      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

      function onDown(clientX, clientY){
        const rect = fp.getBoundingClientRect();
        dragging = true;
        startX = clientX;
        startY = clientY;
        startLeft = rect.left;
        startTop = rect.top;
        fp.style.right = "auto";
        fp.style.bottom = "auto";
      }

      function onMove(clientX, clientY){
        if (!dragging) return;
        const dx = clientX - startX;
        const dy = clientY - startY;

        const newLeft = startLeft + dx;
        const newTop  = startTop + dy;

        const maxLeft = window.innerWidth - fp.offsetWidth - 6;
        const maxTop  = window.innerHeight - fp.offsetHeight - 6;

        fp.style.left = clamp(newLeft, 6, maxLeft) + "px";
        fp.style.top  = clamp(newTop, 6, maxTop) + "px";
      }

      function onUp(){ dragging = false; }

      fpHeader.addEventListener("mousedown", (e) => {
        onDown(e.clientX, e.clientY);
        e.preventDefault();
      });
      window.addEventListener("mousemove", (e) => onMove(e.clientX, e.clientY));
      window.addEventListener("mouseup", onUp);

      fpHeader.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        onDown(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener("touchmove", (e) => {
        if (!dragging) return;
        const t = e.touches[0];
        onMove(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener("touchend", onUp);
    })();

    // === Init ===
    async function loadItems(){
      loadFavs();
      loadSelected();
      loadLikes();

      try{
        const res = await fetch("./items.json", { cache: "no-store" });
        if (!res.ok) throw new Error("items.json okunamadı");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("items.json formatı yanlış");

        // beklenen format: [{title,file,info}, ...]
        items = data
          .filter(x => x && x.file)
          .map(x => ({
            title: String(x.title || x.file),
            file: String(x.file),
            info: String(x.info || "")
          }));

        renderList();
        setStatus("");
      } catch (err){
        console.error(err);
        metaEl.textContent = "Liste yüklenemedi. items.json kontrol et.";
        setStatus("Liste yüklenemedi.");
      }
    }

    loadItems();
  </script>
</body>
</html>
