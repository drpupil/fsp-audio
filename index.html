<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfabetik FSP Aâ€“Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css"/>

  <style>
    :root{
      --fg:#111;
      --muted:#666;
      --line:#e7e7e7;
      --bg:#fff;
      --chip-border:#d8d8dd;
      --accent:#0a66ff;
      --row-hover:#f3f7ff;
      --row-active:#e6f1ff;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    html,body{background:var(--bg); color:var(--fg); margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    *{box-sizing:border-box;}
    .wrap{max-width:1100px; margin:26px auto 120px; padding:0 18px;}
    h1{font-size:54px; line-height:1.05; margin:0 0 14px; letter-spacing:-.02em; font-weight:800;}
    @media (max-width:700px){ h1{font-size:40px;} }

    .topbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0 8px;}
    .search{
      flex:1; min-width:260px;
      border:1px solid var(--line); background:#fff;
      padding:14px 16px; border-radius:20px;
      font-size:20px; outline:none;
      font-weight:400;
    }
    .btn{
      border:1px solid var(--chip-border);
      background:#fff; border-radius:16px;
      padding:12px 16px; font-size:18px;
      cursor:pointer;
      font-weight:400;
    }
    .btn.primary{border-color:rgba(10,102,255,.35); color:var(--accent);}
    .meta{color:var(--muted); font-size:20px; margin:10px 0 14px; font-weight:400;}
    @media (max-width:700px){ .meta{font-size:18px;} }

    .table{border-top:1px solid var(--line);}

    /* âœ… 6 kolon: title | likecount | like | fav | sel | download */
    .head, .row{
      display:grid;
      grid-template-columns: 1fr 56px 54px 54px 54px 54px;
      align-items:center;
      gap:10px;
      padding:10px 6px;            /* daha dar */
    }

    .head{
      color:var(--muted);
      border-bottom:1px solid var(--line);
      font-size:18px;
      font-weight:400;
    }
    .head .hlabel{padding-left:4px;}

    .hicon{
      width:44px; height:44px; border-radius:999px;
      border:1px solid var(--chip-border);
      display:grid; place-items:center;
      cursor:pointer; background:#fff;
      user-select:none;
    }
    .hicon.on{
      border-color:rgba(10,102,255,.45);
      box-shadow:0 0 0 3px rgba(10,102,255,.10);
    }

    .row{
      border-bottom:1px solid var(--line);
      font-size:24px;
      font-weight:400 !important;  /* âœ… bold kapat */
    }
    .row:hover{background:var(--row-hover);}
    .row.active{background:var(--row-active);}
    @media (max-width:700px){ .row{font-size:22px;} }

    .title{min-width:0; display:flex; align-items:center; cursor:pointer;}
    .title span{
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:400 !important; /* âœ… bold kapat */
    }

    .likecount{
      color:var(--muted);
      font-size:18px;
      text-align:right;
      padding-right:2px;
      user-select:none;
      font-weight:400;
    }

    .iconbtn{
      width:44px; height:44px; border-radius:999px;
      border:1px solid var(--chip-border);
      display:grid; place-items:center;
      cursor:pointer; background:#fff;
      user-select:none;
    }
    .iconbtn.on{
      border-color:rgba(10,102,255,.45);
      box-shadow:0 0 0 3px rgba(10,102,255,.10);
    }
    .iconbtn svg{width:22px; height:22px;}
    .iconbtn.on svg{fill:var(--accent); stroke:var(--accent);}
    .iconbtn svg{fill:none; stroke:#666; stroke-width:2; stroke-linecap:round; stroke-linejoin:round;}

    .dl svg{stroke:#444;}
    .iconbtn.dl{border-color:#e0e0e0;}

    /* Floating player */
    #floatingPlayer{
      position:fixed; left:18px; bottom:18px;
      width:min(860px, calc(100vw - 36px));
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      z-index:9999;
      overflow:hidden;
      touch-action:none;
      font-weight:400;
    }
    #fpBar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px 8px 14px; /* daha dar */
      border-bottom:1px solid var(--line);
      cursor:grab;
      user-select:none;
      gap:10px;
    }
    #fpTitle{
      font-size:20px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-weight:600;  /* sadece player baÅŸlÄ±ÄŸÄ± */
      flex:1; min-width:0;
    }
    #fpRight{display:flex; align-items:center; gap:8px;}
    .mini{
      width:44px; height:44px; border-radius:14px;
      border:1px solid var(--chip-border);
      background:#fff;
      display:grid; place-items:center;
      cursor:pointer;
    }
    .mini svg{width:22px; height:22px; fill:none; stroke:#333; stroke-width:2; stroke-linecap:round; stroke-linejoin:round;}
    .dragTag{color:var(--muted); font-size:16px; padding:0 6px;}

    #fpMsg{
      padding:10px 14px 0;
      color:var(--muted);
      font-size:16px;
      display:none;
      line-height:1.35;
    }
    #fpMsg a{color:var(--accent); text-decoration:underline;}

    .plyr--audio .plyr__controls{padding:10px 12px;}
    .plyr__time{font-size:14px;}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Alfabetik FSP Aâ€“Z</h1>

    <div class="topbar">
      <input id="q" class="search" placeholder="Arama (Ã¶r. ACS, DM, PAVK)..." autocomplete="off" />
      <button id="resetBtn" class="btn primary" title="Filtreleri temizle">Hepsi</button>
    </div>

    <div id="meta" class="meta">YÃ¼kleniyorâ€¦</div>

    <div class="table">
      <div class="head">
        <div class="hlabel">KayÄ±t</div>
        <div></div>

        <div id="hLike" class="hicon" title="Sadece liked">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.8 4.6c-1.6-1.6-4.2-1.6-5.8 0L12 7.6 9 4.6C7.4 3 4.8 3 3.2 4.6c-1.7 1.7-1.7 4.4 0 6.1L12 19.5l8.8-8.8c1.7-1.7 1.7-4.4 0-6.1z"/>
          </svg>
        </div>

        <div id="hFav" class="hicon" title="Sadece favoriler">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2l3.1 6.3 7 .9-5.1 5 1.2 7-6.2-3.3-6.2 3.3 1.2-7-5.1-5 7-.9z"/>
          </svg>
        </div>

        <div id="hSel" class="hicon" title="Sadece seÃ§ili">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
        </div>

        <div></div>
      </div>

      <div id="list"></div>
    </div>
  </div>

  <div id="floatingPlayer" aria-live="polite">
    <div id="fpBar">
      <div id="fpTitle">Bir kayÄ±t seÃ§â€¦</div>
      <div id="fpRight">
        <button id="prevBtn" class="mini" title="Ã–nceki">
          <svg viewBox="0 0 24 24"><path d="M11 19l-9-7 9-7v14z"/><path d="M22 19V5"/></svg>
        </button>
        <button id="nextBtn" class="mini" title="Sonraki">
          <svg viewBox="0 0 24 24"><path d="M13 5l9 7-9 7V5z"/><path d="M2 5v14"/></svg>
        </button>
        <span class="dragTag">SÃ¼rÃ¼kle</span>
      </div>
    </div>
    <div id="fpMsg"></div>
    <audio id="player" controls crossorigin="anonymous"></audio>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    /***********************
     * ðŸ”´ BURAYI DÃœZ GÄ°R:
     * https://archive.org/download/IDENTIFIER/
     ***********************/
    const ARCHIVE_BASE = "https://archive.org/download/IDENTIFIER/"; // <-- bunu deÄŸiÅŸtir
    const ITEMS_JSON = "./items.json";

    const LS_LIKES = "fsp_likes_v1";
    const LS_FAVS  = "fsp_favs_v1";
    const LS_SELS  = "fsp_sels_v1";
    const LS_LIKECOUNTS = "fsp_likecounts_v1";

    const loadSet = (k) => new Set(JSON.parse(localStorage.getItem(k) || "[]"));
    const saveSet = (k, s) => localStorage.setItem(k, JSON.stringify([...s]));
    const loadCounts = () => JSON.parse(localStorage.getItem(LS_LIKECOUNTS) || "{}");
    const saveCounts = (obj) => localStorage.setItem(LS_LIKECOUNTS, JSON.stringify(obj));

    let likes = loadSet(LS_LIKES);
    let favs  = loadSet(LS_FAVS);
    let sels  = loadSet(LS_SELS);
    let likeCounts = loadCounts();

    let allItems = [];
    let filtered = [];
    let activeIndex = null;

    let filterLike = false, filterFav = false, filterSel = false;

    const qEl = document.getElementById("q");
    const listEl = document.getElementById("list");
    const metaEl = document.getElementById("meta");
    const resetBtn = document.getElementById("resetBtn");

    const hLike = document.getElementById("hLike");
    const hFav  = document.getElementById("hFav");
    const hSel  = document.getElementById("hSel");

    const fpTitle = document.getElementById("fpTitle");
    const fpMsg = document.getElementById("fpMsg");
    const audioEl = document.getElementById("player");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const plyr = new Plyr(audioEl, {
      seekTime: 5,
      controls: ["rewind","play","fast-forward","progress","current-time","duration","mute","volume","settings"],
      settings: ["speed"],
      speed: { selected: 1, options: [0.8, 0.9, 1, 1.1, 1.2] }
    });

    function showMsg(html){
      fpMsg.style.display = "block";
      fpMsg.innerHTML = html;
    }
    function hideMsg(){
      fpMsg.style.display = "none";
      fpMsg.innerHTML = "";
    }

    // âœ… filename encoding (TÃ¼rkÃ§e/Almanca vb.)
    function encodeFile(file){
      // dosya adÄ±nÄ± parÃ§alayarak encode et (space/umlaut vb.)
      return file.split("/").map(part => encodeURIComponent(part)).join("/");
    }
    function toFileUrl(file){
      const base = ARCHIVE_BASE.endsWith("/") ? ARCHIVE_BASE : (ARCHIVE_BASE + "/");
      return base + encodeFile(file);
    }

    async function loadItems(){
      try{
        const res = await fetch(ITEMS_JSON + "?v=" + Date.now(), { cache: "no-store" });
        if(!res.ok) throw new Error("items.json HTTP " + res.status);
        const data = await res.json();

        const cleaned = (Array.isArray(data) ? data : [])
          .filter(x => x && typeof x.title === "string" && typeof x.file === "string")
          .filter(x => {
            const f = x.file.toLowerCase();
            return f.endsWith(".m4a") || f.endsWith(".mp3");
          })
          .map(x => ({
            id: x.file,
            title: x.title.trim(),
            file: x.file,
            url: toFileUrl(x.file)
          }));

        cleaned.sort((a,b)=> a.title.localeCompare(b.title, "tr", { sensitivity:"base" }));
        allItems = cleaned;

        applyFiltersAndRender();
      }catch(e){
        metaEl.textContent = "Hata: items.json okunamadÄ±. (" + e.message + ")";
      }
    }

    const heartSvg = () => `
      <svg viewBox="0 0 24 24">
        <path d="M20.8 4.6c-1.6-1.6-4.2-1.6-5.8 0L12 7.6 9 4.6C7.4 3 4.8 3 3.2 4.6c-1.7 1.7-1.7 4.4 0 6.1L12 19.5l8.8-8.8c1.7-1.7 1.7-4.4 0-6.1z"></path>
      </svg>`;
    const starSvg = () => `
      <svg viewBox="0 0 24 24">
        <path d="M12 2l3.1 6.3 7 .9-5.1 5 1.2 7-6.2-3.3-6.2 3.3 1.2-7-5.1-5 7-.9z"></path>
      </svg>`;
    const checkSvg = () => `
      <svg viewBox="0 0 24 24">
        <path d="M20 6L9 17l-5-5"></path>
      </svg>`;
    const dlSvg = () => `
      <svg viewBox="0 0 24 24">
        <path d="M12 3v12"></path>
        <path d="M7 10l5 5 5-5"></path>
        <path d="M5 21h14"></path>
      </svg>`;

    function toggleSet(setObj, key, id){
      if(setObj.has(id)) setObj.delete(id);
      else setObj.add(id);
      saveSet(key, setObj);
    }

    function applyFiltersAndRender(){
      const q = qEl.value.trim().toLowerCase();

      filtered = allItems.filter(it => {
        if(q && !it.title.toLowerCase().includes(q)) return false;
        if(filterLike && !likes.has(it.id)) return false;
        if(filterFav  && !favs.has(it.id))  return false;
        if(filterSel  && !sels.has(it.id))  return false;
        return true;
      });

      metaEl.textContent = `GÃ¶rÃ¼nen: ${filtered.length} / Toplam: ${allItems.length}`;

      hLike.classList.toggle("on", filterLike);
      hFav.classList.toggle("on",  filterFav);
      hSel.classList.toggle("on",  filterSel);

      if(activeIndex != null && (activeIndex < 0 || activeIndex >= filtered.length)) activeIndex = null;

      listEl.innerHTML = "";
      filtered.forEach((it, idx) => {
        const row = document.createElement("div");
        row.className = "row" + (activeIndex === idx ? " active" : "");

        const t = document.createElement("div");
        t.className = "title";
        const span = document.createElement("span");
        span.textContent = it.title;
        t.appendChild(span);
        t.addEventListener("click", () => playIndex(idx));

        const lc = document.createElement("div");
        lc.className = "likecount";
        lc.textContent = String(likeCounts[it.id] || 0);

        const bLike = document.createElement("button");
        bLike.className = "iconbtn" + (likes.has(it.id) ? " on" : "");
        bLike.innerHTML = heartSvg();
        bLike.title = "Like";
        bLike.addEventListener("click", (ev) => {
          ev.stopPropagation();
          toggleSet(likes, LS_LIKES, it.id);
          if(likes.has(it.id)){
            likeCounts[it.id] = (likeCounts[it.id] || 0) + 1;
            saveCounts(likeCounts);
          }
          applyFiltersAndRender();
        });

        const bFav = document.createElement("button");
        bFav.className = "iconbtn" + (favs.has(it.id) ? " on" : "");
        bFav.innerHTML = starSvg();
        bFav.title = "Favori";
        bFav.addEventListener("click", (ev) => {
          ev.stopPropagation();
          toggleSet(favs, LS_FAVS, it.id);
          applyFiltersAndRender();
        });

        const bSel = document.createElement("button");
        bSel.className = "iconbtn" + (sels.has(it.id) ? " on" : "");
        bSel.innerHTML = checkSvg();
        bSel.title = "SeÃ§";
        bSel.addEventListener("click", (ev) => {
          ev.stopPropagation();
          toggleSet(sels, LS_SELS, it.id);
          applyFiltersAndRender();
        });

        const bDl = document.createElement("button");
        bDl.className = "iconbtn dl";
        bDl.innerHTML = dlSvg();
        bDl.title = "Ä°ndir";
        bDl.addEventListener("click", async (ev) => {
          ev.stopPropagation();
          await downloadFile(it.url, it.file);
        });

        // âœ… SIRA Ã–NEMLÄ°: 6 kolonla tam oturuyor
        row.appendChild(t);
        row.appendChild(lc);
        row.appendChild(bLike);
        row.appendChild(bFav);
        row.appendChild(bSel);
        row.appendChild(bDl);

        listEl.appendChild(row);
      });
    }

    async function playIndex(idx){
      if(idx < 0 || idx >= filtered.length) return;
      activeIndex = idx;
      const it = filtered[idx];

      applyFiltersAndRender();
      fpTitle.textContent = it.title;

      // âœ… Ã–nce URL test (404/CORS ayÄ±rt etmek iÃ§in)
      const url = it.url;
      showMsg(`YÃ¼kleniyorâ€¦<br><a href="${url}" target="_blank" rel="noopener noreferrer">DosyayÄ± yeni sekmede aÃ§</a>`);

      try{
        // HEAD bazen engellenir; GET range ile de olabilir ama Ã¶nce HEAD deneyelim
        const head = await fetch(url, { method:"HEAD", mode:"cors" });
        if(!head.ok){
          showMsg(`Dosya eriÅŸilemiyor (HTTP ${head.status}).<br>
                   <a href="${url}" target="_blank" rel="noopener noreferrer">DosyayÄ± yeni sekmede aÃ§</a><br>
                   <small>Muhtemel sebep: ARCHIVE_BASE yanlÄ±ÅŸ veya dosya adÄ± farklÄ±.</small>`);
          return;
        }
      }catch(e){
        // HEAD bloke olabilir; yine de audio ile deneyelim
      }

      audioEl.src = url;
      audioEl.load();

      try{
        await audioEl.play();
        hideMsg();
      }catch(e){
        // autoplay policy veya baÅŸka bir engel
        showMsg(`Oynatma baÅŸlatÄ±lamadÄ±. Playerâ€™daki â–¶ï¸Ž tuÅŸuna bas.<br>
                 <a href="${url}" target="_blank" rel="noopener noreferrer">DosyayÄ± yeni sekmede aÃ§</a>`);
      }
    }

    function playPrev(){
      if(!filtered.length) return;
      if(activeIndex == null) return playIndex(0);
      playIndex((activeIndex - 1 + filtered.length) % filtered.length);
    }
    function playNext(){
      if(!filtered.length) return;
      if(activeIndex == null) return playIndex(0);
      playIndex((activeIndex + 1) % filtered.length);
    }

    prevBtn.addEventListener("click", (e)=>{ e.stopPropagation(); playPrev(); });
    nextBtn.addEventListener("click", (e)=>{ e.stopPropagation(); playNext(); });

    audioEl.addEventListener("ended", () => playNext());
    audioEl.addEventListener("error", () => {
      const url = audioEl.src || "";
      showMsg(`Ses yÃ¼klenemedi.<br>
               <a href="${url}" target="_blank" rel="noopener noreferrer">DosyayÄ± yeni sekmede aÃ§</a>`);
    });

    hLike.addEventListener("click", () => { filterLike = !filterLike; applyFiltersAndRender(); });
    hFav .addEventListener("click", () => { filterFav  = !filterFav;  applyFiltersAndRender(); });
    hSel .addEventListener("click", () => { filterSel  = !filterSel;  applyFiltersAndRender(); });

    resetBtn.addEventListener("click", () => {
      filterLike = filterFav = filterSel = false;
      qEl.value = "";
      applyFiltersAndRender();
    });

    qEl.addEventListener("input", applyFiltersAndRender);

    document.addEventListener("keydown", (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if(tag === "input" || tag === "textarea") return;

      if(e.code === "Space"){
        e.preventDefault();
        if(audioEl.src){
          if(audioEl.paused) audioEl.play().catch(()=>{});
          else audioEl.pause();
        }
      }
    });

    // draggable
    (function makeDraggable(){
      const fp = document.getElementById("floatingPlayer");
      const fpBar = document.getElementById("fpBar");
      let dragging=false, startX=0,startY=0,startLeft=0,startTop=0;

      function getPoint(ev){
        if(ev.touches && ev.touches[0]) return {x: ev.touches[0].clientX, y: ev.touches[0].clientY};
        return {x: ev.clientX, y: ev.clientY};
      }
      function onDown(ev){
        dragging=true;
        fpBar.style.cursor="grabbing";

        const r = fp.getBoundingClientRect();
        fp.style.left = r.left + "px";
        fp.style.top  = r.top + "px";
        fp.style.bottom = "auto";

        startLeft=r.left; startTop=r.top;
        const p=getPoint(ev);
        startX=p.x; startY=p.y;

        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", onUp);
        window.addEventListener("touchmove", onMove, {passive:false});
        window.addEventListener("touchend", onUp);
      }
      function onMove(ev){
        if(!dragging) return;
        if(ev.cancelable) ev.preventDefault();
        const p=getPoint(ev);
        const nx=startLeft+(p.x-startX);
        const ny=startTop+(p.y-startY);

        const maxX=window.innerWidth-fp.offsetWidth-10;
        const maxY=window.innerHeight-fp.offsetHeight-10;

        fp.style.left = Math.max(10, Math.min(maxX, nx)) + "px";
        fp.style.top  = Math.max(10, Math.min(maxY, ny)) + "px";
      }
      function onUp(){
        dragging=false;
        fpBar.style.cursor="grab";
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
        window.removeEventListener("touchmove", onMove);
        window.removeEventListener("touchend", onUp);
      }
      fpBar.addEventListener("mousedown", onDown);
      fpBar.addEventListener("touchstart", onDown, {passive:true});
    })();

    async function downloadFile(url, filename){
      try{
        const r = await fetch(url, { mode:"cors" });
        if(!r.ok) throw new Error("HTTP " + r.status);
        const blob = await r.blob();
        const objUrl = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = objUrl;
        a.download = filename || "audio";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(objUrl), 1500);
      }catch(e){
        window.open(url, "_blank", "noopener,noreferrer");
      }
    }

    loadItems();
  </script>
</body>
</html>
