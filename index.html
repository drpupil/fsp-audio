<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfabetik FSP A–Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --bg:#fff;
      --text:#111;
      --muted:#666;
      --line:#eee;
      --soft:#f6f6f6;
      --softBorder:#e5e5e5;
      --active:#e5f2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 12px;
      --blue:#2563eb;
      --amber:#f59e0b;
      --rose:#e11d48;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 18px;
      max-width: 1100px;
      color: var(--text);
      background: var(--bg);
      font-weight: 400;
    }

    h1{
      font-size: 1.5rem;
      margin: 0 0 12px 0;
      font-weight: 600;
    }

    .topbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      margin-bottom: 10px;
    }

    #search{
      flex: 1 1 320px;
      padding: 10px 12px;
      border: 1px solid #cfcfcf;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      font-weight: 400;
    }

    .chipGroup{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .chipBtn{
      padding: 9px 12px;
      border:1px solid var(--softBorder);
      background: var(--soft);
      border-radius:10px;
      cursor:pointer;
      user-select:none;
      font-weight:600;
      font-size:.95rem;
      white-space:nowrap;
    }
    .chipBtn:active{ transform: translateY(1px); }
    .chipBtn.active{
      border-color: var(--blue);
      background: var(--active);
    }

    .ghostBtn{
      padding: 9px 12px;
      border:1px solid var(--softBorder);
      background:#fff;
      border-radius:10px;
      cursor:pointer;
      user-select:none;
      font-weight:600;
      font-size:.95rem;
      white-space:nowrap;
    }
    .ghostBtn:active{ transform: translateY(1px); }

    #statusTop{
      font-size: .95rem;
      color: var(--muted);
      margin: 6px 0 10px 2px;
      font-weight: 400;
    }

    /* Header (kolon başlığı + sort butonu) */
    #listHeader{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 10px 6px;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      color: var(--muted);
      font-size: .92rem;
      user-select:none;
      gap: 10px;
    }
    #listHeader .hLeft{ flex:1; min-width:0; }
    #listHeader .hRight{ display:flex; align-items:center; gap:10px; }

    #sortBtn{
      width: 44px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid #dcdcdc;
      background: #fff;
      cursor:pointer;
      font-weight: 700;
      font-size: .9rem;
    }
    #sortBtn:active{ transform: translateY(1px); }

    /* List */
    #list{
      margin-bottom: 120px; /* floating player için */
    }

    .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 6px;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      font-size: 1.02rem;
      font-weight: 400;
    }
    .row:hover{ background:#fafafa; }
    .row.active{ background: var(--active); }

    .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }
    .title{
      flex: 1;
      min-width: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 400;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .badge{
      font-size: .9rem;
      color: #555;
      min-width: 56px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight: 400;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 2px solid #dcdcdc;
      background: #fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      padding:0;
    }
    .iconBtn:active{ transform: translateY(1px); }

    /* Like + counter */
    .likeCount{
      font-size: 0.85rem;
      color:#444;
      min-width: 18px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight: 400;
    }
    .iconBtn.like::before{ content:"♡"; font-size: 15px; color:#777; transform: translateY(-0.5px); }
    .iconBtn.like.active{ border-color: var(--rose); background:#fff0f3; }
    .iconBtn.like.active::before{ content:"♥"; color: var(--rose); }

    /* Favorite */
    .iconBtn.star::before{ content:"☆"; font-size: 16px; color:#777; transform: translateY(-0.5px); }
    .iconBtn.star.active{ border-color: var(--amber); background:#fff7ed; }
    .iconBtn.star.active::before{ content:"★"; color: var(--amber); }

    /* Selected (isteğe bağlı ama belirgin) */
    .iconBtn.select::before{ content:"✓"; font-size: 16px; color:#9aa0a6; transform: translateY(-0.5px); }
    .iconBtn.select.active{ border-color: var(--blue); background: var(--blue); }
    .iconBtn.select.active::before{ color:#fff; }

    /* Download */
    .iconBtn.dl::before{ content:"⤓"; font-size: 16px; color:#111; transform: translateY(-0.5px); }

    /* Floating player */
    #floatingPlayer{
      position: fixed;
      left: 18px;
      bottom: 18px;
      width: min(560px, calc(100vw - 36px));
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 9999;
      overflow:hidden;
    }

    #fpHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid #efefef;
      cursor: grab;
      user-select:none;
      background: #fafafa;
    }
    #fpHeader:active{ cursor: grabbing; }

    #fpTitle{
      font-size: .95rem;
      color:#222;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 600;
      flex: 1;
      min-width:0;
    }
    #fpHint{
      font-size: .8rem;
      color:#888;
      font-weight: 400;
      white-space:nowrap;
    }

    #fpBody{ padding: 10px 12px 12px 12px; }

    #playerStatus{
      font-size: .9rem;
      color:#666;
      margin: 0 0 8px 2px;
      font-weight: 400;
    }

    .plyr{ border-radius: 10px; }

    @media (max-width: 520px){
      .badge{ min-width: 48px; }
      .iconBtn{ width: 32px; height: 32px; }
      #sortBtn{ width: 42px; }
    }
  </style>
</head>

<body>
  <h1>Alfabetik FSP A–Z</h1>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (ör. ACS, DM, PAVK)..." />

    <div class="chipGroup" id="filterBtns" aria-label="Filtre">
      <button class="chipBtn active" data-filter="all">Hepsi</button>
      <button class="chipBtn" data-filter="fav">Favoriler</button>
      <button class="chipBtn" data-filter="liked">Liked</button>
      <button class="chipBtn" data-filter="smart">Fav+Liked</button>
    </div>

    <button class="ghostBtn" id="clearSelectionBtn" title="Seçimi temizle">Seçimi temizle</button>
  </div>

  <div id="statusTop"></div>

  <div id="listHeader">
    <div class="hLeft">Kayıt</div>
    <div class="hRight">
      <span style="font-variant-numeric: tabular-nums;">Süre</span>
      <button id="sortBtn" title="Sıralama değiştir">A→Z</button>
    </div>
  </div>

  <div id="list"></div>

  <!-- Floating player -->
  <div id="floatingPlayer" aria-label="Audio player">
    <div id="fpHeader">
      <div id="fpTitle">Seçili kayıt yok</div>
      <div id="fpHint">Sürükle</div>
    </div>
    <div id="fpBody">
      <div id="playerStatus"></div>
      <audio id="player" class="js-player" controls preload="auto"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // === Archive.org download base ===
    const BASE = "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

    // === LocalStorage keys ===
    const LS_FAVS = "favs_v2";
    const LS_SELECTED = "selected_v2";
    const LS_LIKES = "likes_count_v2";

    // === State ===
    let items = [];                 // {title,file,info}
    let favs = new Set();
    let selected = new Set();
    let likesCount = {};            // { file: number }
    let activeFile = null;

    let filterMode = "all";         // all | fav | liked | smart
    let sortMode = "az";            // az | za | likes

    // === Elements ===
    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const statusTopEl = document.getElementById("statusTop");

    const fp = document.getElementById("floatingPlayer");
    const fpHeader = document.getElementById("fpHeader");
    const fpTitle = document.getElementById("fpTitle");
    const playerStatusEl = document.getElementById("playerStatus");

    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const sortBtn = document.getElementById("sortBtn");

    const audioEl = document.getElementById("player");

    // Plyr: 5 sn geri/ileri
    const plyr = new Plyr(audioEl, {
      seekTime: 5,
      controls: [
        "rewind",
        "play",
        "fast-forward",
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume"
      ]
    });

    // === Helpers ===
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fileUrl(file){
      const encoded = encodeURIComponent(file).replace(/%2F/g, "/");
      return BASE + encoded;
    }

    function downloadUrl(file){
      return fileUrl(file) + "?download=1";
    }

    function loadSet(key){
      try{
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        return new Set(Array.isArray(arr) ? arr : []);
      } catch { return new Set(); }
    }
    function saveSet(key, set){
      localStorage.setItem(key, JSON.stringify([...set]));
    }

    function loadLikes(){
      try{
        const obj = JSON.parse(localStorage.getItem(LS_LIKES) || "{}");
        return (obj && typeof obj === "object") ? obj : {};
      } catch { return {}; }
    }
    function saveLikes(){
      localStorage.setItem(LS_LIKES, JSON.stringify(likesCount));
    }
    function getLikeCount(file){
      return Number(likesCount[file] || 0);
    }

    function setTopStatus(msg){
      statusTopEl.textContent = msg || "";
    }
    function setPlayerStatus(msg){
      playerStatusEl.textContent = msg || "";
    }

    function updateSortButton(){
      if (sortMode === "az") sortBtn.textContent = "A→Z";
      else if (sortMode === "za") sortBtn.textContent = "Z→A";
      else sortBtn.textContent = "♥";
    }

    function buildView(){
      const q = searchEl.value.trim().toLowerCase();

      // filter
      let view = items.filter(it => {
        const title = (it.title || "").toLowerCase();
        if (q && !title.includes(q)) return false;

        const isFav = favs.has(it.file);
        const likeN = getLikeCount(it.file);
        const isLiked = likeN > 0;

        if (filterMode === "fav") return isFav;
        if (filterMode === "liked") return isLiked;
        if (filterMode === "smart") return (isFav || isLiked);
        return true;
      });

      // sort
      if (sortMode === "likes"){
        view.sort((a,b) => {
          const la = getLikeCount(a.file);
          const lb = getLikeCount(b.file);
          if (lb !== la) return lb - la;
          return String(a.title).localeCompare(String(b.title), "tr");
        });
      } else if (sortMode === "za"){
        view.sort((a,b) => String(b.title).localeCompare(String(a.title), "tr"));
      } else {
        view.sort((a,b) => String(a.title).localeCompare(String(b.title), "tr"));
      }

      return view;
    }

    function renderList(){
      const view = buildView();
      listEl.innerHTML = "";

      // üstte sadece küçük bilgi
      const shown = view.length;
      const likesShown = view.reduce((acc, it) => acc + (getLikeCount(it.file) > 0 ? 1 : 0), 0);
      setTopStatus(`Görünen: ${shown} • Favori: ${favs.size} • Liked: ${likesShown}`);

      for (const it of view){
        const isActive = (it.file === activeFile);
        const isFav = favs.has(it.file);
        const isSel = selected.has(it.file);

        const likeN = getLikeCount(it.file);
        const isLiked = likeN > 0;

        const row = document.createElement("div");
        row.className = "row" + (isActive ? " active" : "");
        row.dataset.file = it.file;

        row.innerHTML = `
          <div class="left">
            <div class="title" data-action="play" title="${escapeHtml(it.title)}">
              ${escapeHtml(it.title)}
            </div>
          </div>

          <div class="right">
            <div class="badge" title="Süre">${escapeHtml(it.info || "")}</div>

            <div class="actions">
              <div class="likeCount" title="Like">${likeN}</div>
              <button class="iconBtn like ${isLiked ? "active" : ""}" data-action="like" title="Like"></button>

              <button class="iconBtn select ${isSel ? "active" : ""}" data-action="select" title="Seç"></button>
              <button class="iconBtn star ${isFav ? "active" : ""}" data-action="fav" title="Favori"></button>
              <button class="iconBtn dl" data-action="dl" title="İndir"></button>
            </div>
          </div>
        `;

        listEl.appendChild(row);
      }
    }

    async function playFile(file, title){
      activeFile = file;
      fpTitle.textContent = title || "Seçili kayıt";
      setPlayerStatus("Yükleniyor…");

      audioEl.src = fileUrl(file);

      try { audioEl.load(); } catch {}

      try{
        await plyr.play();
        setPlayerStatus("");
      } catch {
        setPlayerStatus("Oynatma başlatılamadı. Play tuşuna bas.");
      }

      renderList();
    }

    function triggerDownload(file){
      const url = downloadUrl(file);
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.download = file; // cross-origin ise tarayıcı yok sayabilir
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // === Next/Prev (filtre + sıralı view'a göre) ===
    function getCurrentView(){ return buildView(); }

    function playByIndexInView(view, idx){
      if (idx < 0 || idx >= view.length) return;
      const it = view[idx];
      playFile(it.file, it.title);
    }

    function playNext(){
      if (!activeFile) return;
      const view = getCurrentView();
      const i = view.findIndex(x => x.file === activeFile);
      if (i === -1) return;
      playByIndexInView(view, (i + 1) % view.length);
    }

    function playPrev(){
      if (!activeFile) return;
      const view = getCurrentView();
      const i = view.findIndex(x => x.file === activeFile);
      if (i === -1) return;
      playByIndexInView(view, (i - 1 + view.length) % view.length);
    }

    // Parça bitince otomatik sonraki
    audioEl.addEventListener("ended", () => playNext());

    // Plyr barına Prev/Next butonlarını ekle
    (function injectPrevNextButtons(){
      const tryInject = () => {
        const controls = document.querySelector(".plyr__controls");
        if (!controls) return false;
        if (controls.querySelector("[data-custom='prev']")) return true;

        const makeBtn = (label, title, onClick) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "plyr__control";
          b.setAttribute("data-custom", label);
          b.setAttribute("aria-label", title);
          b.title = title;
          b.innerHTML = (label === "prev") ? "⏮" : "⏭";
          b.addEventListener("click", (e) => {
            e.preventDefault();
            onClick();
          });
          return b;
        };

        const prevBtn = makeBtn("prev", "Önceki", playPrev);
        const nextBtn = makeBtn("next", "Sonraki", playNext);

        const playBtn = controls.querySelector("[data-plyr='play']");
        if (playBtn){
          controls.insertBefore(prevBtn, playBtn);
          controls.insertBefore(nextBtn, playBtn.nextSibling);
        } else {
          controls.prepend(prevBtn, nextBtn);
        }
        return true;
      };

      const t = setInterval(() => {
        if (tryInject()) clearInterval(t);
      }, 200);

      setTimeout(() => clearInterval(t), 5000);
    })();

    // === Events ===
    listEl.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      const row = e.target.closest(".row");
      if (!row) return;

      const file = row.dataset.file;
      const item = items.find(x => x.file === file);
      if (!item) return;

      if (!btn){
        playFile(item.file, item.title);
        return;
      }

      const action = btn.dataset.action;

      if (action === "play"){
        playFile(item.file, item.title);
        return;
      }

      if (action === "fav"){
        if (favs.has(file)) favs.delete(file);
        else favs.add(file);
        saveSet(LS_FAVS, favs);
        renderList();
        return;
      }

      if (action === "select"){
        if (selected.has(file)) selected.delete(file);
        else selected.add(file);
        saveSet(LS_SELECTED, selected);
        renderList();
        return;
      }

      if (action === "like"){
        // Toggle (0/1). İstersen +1 yaparız.
        likesCount[file] = (getLikeCount(file) > 0) ? 0 : 1;
        saveLikes();
        renderList();
        return;
      }

      if (action === "dl"){
        triggerDownload(file);
        return;
      }
    });

    searchEl.addEventListener("input", renderList);

    document.getElementById("filterBtns").addEventListener("click", (e) => {
      const b = e.target.closest("[data-filter]");
      if (!b) return;

      filterMode = b.dataset.filter;

      document.querySelectorAll("#filterBtns .chipBtn").forEach(x => x.classList.remove("active"));
      b.classList.add("active");

      renderList();
    });

    clearSelectionBtn.addEventListener("click", () => {
      selected.clear();
      saveSet(LS_SELECTED, selected);
      renderList();
    });

    sortBtn.addEventListener("click", () => {
      sortMode = (sortMode === "az") ? "za" : (sortMode === "za") ? "likes" : "az";
      updateSortButton();
      renderList();
    });

    // === Floating drag ===
    (function makeDraggable(){
      let dragging = false;
      let startX = 0, startY = 0;
      let startLeft = 0, startTop = 0;

      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

      function onDown(clientX, clientY){
        const rect = fp.getBoundingClientRect();
        dragging = true;
        startX = clientX;
        startY = clientY;
        startLeft = rect.left;
        startTop = rect.top;
        fp.style.right = "auto";
        fp.style.bottom = "auto";
      }

      function onMove(clientX, clientY){
        if (!dragging) return;
        const dx = clientX - startX;
        const dy = clientY - startY;

        const newLeft = startLeft + dx;
        const newTop  = startTop + dy;

        const maxLeft = window.innerWidth - fp.offsetWidth - 6;
        const maxTop  = window.innerHeight - fp.offsetHeight - 6;

        fp.style.left = clamp(newLeft, 6, maxLeft) + "px";
        fp.style.top  = clamp(newTop, 6, maxTop) + "px";
      }

      function onUp(){ dragging = false; }

      fpHeader.addEventListener("mousedown", (e) => {
        onDown(e.clientX, e.clientY);
        e.preventDefault();
      });
      window.addEventListener("mousemove", (e) => onMove(e.clientX, e.clientY));
      window.addEventListener("mouseup", onUp);

      fpHeader.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        onDown(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener("touchmove", (e) => {
        if (!dragging) return;
        const t = e.touches[0];
        onMove(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener("touchend", onUp);
    })();

    // === Init ===
    async function loadItems(){
      favs = loadSet(LS_FAVS);
      selected = loadSet(LS_SELECTED);
      likesCount = loadLikes();

      updateSortButton();
      setTopStatus("Yükleniyor…");

      try{
        const res = await fetch("./items.json", { cache: "no-store" });
        if (!res.ok) throw new Error("items.json okunamadı");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("items.json formatı yanlış");

        items = data
          .filter(x => x && x.file)
          .map(x => ({
            title: String(x.title || x.file),
            file: String(x.file),
            info: String(x.info || "")
          }));

        renderList();
        setTopStatus("");
        setPlayerStatus("");
      } catch (err){
        console.error(err);
        setTopStatus("Liste yüklenemedi. items.json kontrol et.");
        setPlayerStatus("Liste yüklenemedi.");
      }
    }

    loadItems();
  </script>
</body>
</html>
