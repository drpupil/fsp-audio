<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Alfabetik FSP Aâ€“Z</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      max-width: 900px;
    }
    h1 { font-size: 1.4rem; margin-bottom: 0.75rem; }
    #search {
      width: 100%;
      max-width: 420px;
      padding: 0.45rem 0.6rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    #list { border-top: 1px solid #eee; margin-bottom: 1rem; }
    .item {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #f2f2f2;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    .item:hover { background: #f7f7f7; }
    .item.active { background: #e6f1ff; }
    .title { flex: 1; }
    .badge { font-size: 0.75rem; color: #666; white-space: nowrap; }

    #current { font-size: 0.9rem; margin-bottom: 0.2rem; color: #222; }
    #status  { font-size: 0.85rem; color: #666; margin-bottom: 0.6rem; line-height: 1.35; }
    #status a { color: inherit; text-decoration: underline; }
  </style>
</head>
<body>

<h1>Alfabetik FSP Aâ€“Z</h1>

<input id="search" type="text" placeholder="Arama (Ã¶r. ACS, DM, PAVK)..." />

<div id="list"></div>

<div id="current">YÃ¼kleniyorâ€¦</div>
<div id="status"></div>

<audio id="player" class="js-player" controls preload="auto"></audio>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
  const BASE =
    "https://archive.org/download/vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25/";

  const listEl = document.getElementById("list");
  const searchEl = document.getElementById("search");
  const playerEl = document.getElementById("player");
  const currentEl = document.getElementById("current");
  const statusEl = document.getElementById("status");

  // Plyr (istersen tamamen kapatabiliriz, ama bu sÃ¼rÃ¼m Safariâ€™de stabil)
  const plyr = new Plyr(playerEl, {
    controls: ["play", "progress", "current-time", "mute", "volume"]
  });

  let items = [];
  let activeIndex = null;

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function urlFor(item) {
    // Ã‡Ä°FTE-ENCODE YAPMAZ, Safari/Archive.org iÃ§in en gÃ¼venlisi
    return encodeURI(BASE + item.file);
  }

  function setStatus(text, link) {
    if (link) {
      statusEl.innerHTML = `${escapeHtml(text)} â€” <a href="${link}" target="_blank" rel="noreferrer">dosyayÄ± yeni sekmede aÃ§</a>`;
    } else {
      statusEl.textContent = text || "";
    }
  }

  function renderList(q = "") {
    q = q.toLowerCase();
    listEl.innerHTML = "";
    let shown = 0;

    items.forEach((item, index) => {
      if (!item.title.toLowerCase().includes(q)) return;
      shown++;

      const row = document.createElement("div");
      row.className = "item";
      if (index === activeIndex) row.classList.add("active");
      row.dataset.index = index;

      row.innerHTML = `
        <span class="title">${escapeHtml(item.title)}</span>
        <span class="badge">${escapeHtml(item.info || "")}</span>
      `;
      listEl.appendChild(row);
    });

    if (!shown) {
      listEl.innerHTML = "<div style='padding:0.75rem;color:#666'>SonuÃ§ yok.</div>";
    }
  }

  function playIndex(index) {
    const item = items[index];
    if (!item) return;

    activeIndex = index;

    const src = urlFor(item);

    currentEl.textContent = "Åžu an: " + item.title;
    setStatus("YÃ¼kleniyorâ€¦", src);
    renderList(searchEl.value);

    // ðŸ”¥ SAFARI FIX: src deÄŸiÅŸince load() ÅŸart olabiliyor
    try { playerEl.pause(); } catch {}
    playerEl.src = src;
    playerEl.load();   // <-- en kritik satÄ±r

    // Plyr play (kullanÄ±cÄ± tÄ±klamasÄ±yla tetiklendiÄŸi iÃ§in izinli olmalÄ±)
    plyr.play().catch(() => {
      setStatus("Oynatma baÅŸlamadÄ±. Linki yeni sekmede aÃ§Ä±p test et.", src);
    });
  }

  async function loadItems() {
    try {
      const res = await fetch("./items.json", { cache: "no-store" });
      if (!res.ok) throw new Error("items.json yÃ¼klenemedi");

      const data = await res.json();
      items = (Array.isArray(data) ? data : [])
        .filter(x => x && x.title && x.file)
        .map(x => ({ title: String(x.title), file: String(x.file), info: x.info ? String(x.info) : "" }));

      items.sort((a, b) => a.title.localeCompare(b.title, "de"));

      currentEl.textContent = `Toplam kayÄ±t: ${items.length}`;
      setStatus("Bir kayÄ±t seÃ§.", "");
      renderList();
    } catch (e) {
      console.error(e);
      currentEl.textContent = "KayÄ±tlar yÃ¼klenemedi.";
      setStatus("items.json bulunamadÄ± veya bozuk.", "");
    }
  }

  // Hata yakalama (Consoleâ€™a gerek yok)
  playerEl.addEventListener("error", () => {
    const err = playerEl.error;
    const code = err ? err.code : 0;
    const src = playerEl.currentSrc || playerEl.src;

    const msg =
      code === 2 ? "AÄŸ hatasÄ± (link/eriÅŸim sorunu, 404/403 olabilir)" :
      code === 3 ? "Decode hatasÄ± (Safari bu .m4a codecâ€™ini okuyamÄ±yor olabilir)" :
      code === 4 ? "Format desteklenmiyor veya link yanlÄ±ÅŸ" :
      "Bilinmeyen hata";

    setStatus("Hata: " + msg, src);
  });

  playerEl.addEventListener("canplay", () => {
    const src = playerEl.currentSrc || playerEl.src;
    setStatus("HazÄ±r (canplay). OynatÄ±lÄ±yorâ€¦", src);
  });

  listEl.addEventListener("click", e => {
    const row = e.target.closest(".item");
    if (!row) return;
    playIndex(Number(row.dataset.index));
  });

  searchEl.addEventListener("input", () => renderList(searchEl.value));

  loadItems();
</script>

</body>
</html>
